
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Module Compiler</title>
<meta name="description" content="Documentation of Coq module Compiler" />
<link href="coq2html.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="coq2html.js"> </script>
</head>

<body onload="hideAll('proofscript')">
<h1 class="title">Module Compiler</h1>
<div class="coq">
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Bool.Bool.html">Bool</a></span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Arith.Arith.html">Arith</a></span> <span class="id"><a href="http://coq.inria.fr/library/Coq.omega.Omega.html">Omega</a></span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Lists.List.html">List</a></span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Program.Equality.html">Coq.Program.Equality</a></span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id"><a href="../SF/lf/Maps.html">Maps</a></span> <span class="id"><a href="../SF/lf/Imp.html">Imp</a></span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id"><a href="compiler.Sequences.html">Sequences</a></span> <span class="id"><a href="compiler.Semantics.html">Semantics</a></span>.<br/>
<br/>
<div class="doc">This chapter defines a compiler from the Imp language to a virtual machine
  (a small subset of the Java Virtual Machine) and proves that this
  compiler preserves the semantics of the source programs. </div>
<br/>
<h1> 1. The virtual machine. </h1>
<br/>
<div class="doc">The machine operates on a code <span class="bracket"><span class="id">c</span></span> (a fixed list of instructions)
  and three variable components:
<ul>
<li>
 a program counter, denoting a position in <span class="bracket"><span class="id">c</span></span>
</li>
<li>
 a state assigning integer values to variables
</li>
<li>
 an evaluation stack, containing integers.
</li>
</ul>
</div>
<br/>
<div class="doc">The instruction set of the machine. </div>
<br/>
<span class="kwd">Inductive</span> <span class="id"><a name="instruction">instruction</a></span>: <span class="kwd">Type</span> :=<br/>
&nbsp;&nbsp;| <span class="id"><a name="Iconst">Iconst</a></span>(<span class="id">n</span>: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>)                 <span class="docright">(* push integer <span class="bracket"><span class="id">n</span></span> on stack  *)</span><br/>
&nbsp;&nbsp;| <span class="id"><a name="Ivar">Ivar</a></span>(<span class="id">x</span>: <span class="id"><a href="../SF/lf/Maps.html#id">id</a></span>)                    <span class="docright">(* push the value of variable <span class="bracket"><span class="id">x</span></span>  *)</span><br/>
&nbsp;&nbsp;| <span class="id"><a name="Isetvar">Isetvar</a></span>(<span class="id">x</span>: <span class="id"><a href="../SF/lf/Maps.html#id">id</a></span>)                 <span class="docright">(* pop an integer, assign it to variable <span class="bracket"><span class="id">x</span></span>  *)</span><br/>
&nbsp;&nbsp;| <span class="id"><a name="Iadd">Iadd</a></span>                           <span class="docright">(* pop <span class="bracket"><span class="id">n2</span></span>, pop <span class="bracket"><span class="id">n1</span></span>, push back <span class="bracket"><span class="id">n1</span>+<span class="id">n2</span></span>  *)</span><br/>
&nbsp;&nbsp;| <span class="id"><a name="Isub">Isub</a></span>                           <span class="docright">(* pop <span class="bracket"><span class="id">n2</span></span>, pop <span class="bracket"><span class="id">n1</span></span>, push back <span class="bracket"><span class="id">n1</span>-<span class="id">n2</span></span>  *)</span><br/>
&nbsp;&nbsp;| <span class="id"><a name="Imul">Imul</a></span>                           <span class="docright">(* pop <span class="bracket"><span class="id">n2</span></span>, pop <span class="bracket"><span class="id">n1</span></span>, push back <span class="bracket"><span class="id">n1</span>*<span class="id">n2</span></span>  *)</span><br/>
&nbsp;&nbsp;| <span class="id"><a name="Ibranch_forward">Ibranch_forward</a></span>(<span class="id">ofs</span>: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>)      <span class="docright">(* skip <span class="bracket"><span class="id">ofs</span></span> instructions forward  *)</span><br/>
&nbsp;&nbsp;| <span class="id"><a name="Ibranch_backward">Ibranch_backward</a></span>(<span class="id">ofs</span>: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>)     <span class="docright">(* skip <span class="bracket"><span class="id">ofs</span></span> instructions backward  *)</span><br/>
&nbsp;&nbsp;| <span class="id"><a name="Ibeq">Ibeq</a></span>(<span class="id">ofs</span>: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>)                 <span class="docright">(* pop <span class="bracket"><span class="id">n2</span></span>, pop <span class="bracket"><span class="id">n1</span></span>, skip <span class="bracket"><span class="id">ofs</span></span> forward if <span class="bracket"><span class="id">n1</span>=<span class="id">n2</span></span>  *)</span><br/>
&nbsp;&nbsp;| <span class="id"><a name="Ibne">Ibne</a></span>(<span class="id">ofs</span>: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>)                 <span class="docright">(* pop <span class="bracket"><span class="id">n2</span></span>, pop <span class="bracket"><span class="id">n1</span></span>, skip <span class="bracket"><span class="id">ofs</span></span> forward if <span class="bracket"><span class="id">n1</span>&lt;&gt;<span class="id">n2</span></span>  *)</span><br/>
&nbsp;&nbsp;| <span class="id"><a name="Ible">Ible</a></span>(<span class="id">ofs</span>: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>)                 <span class="docright">(* pop <span class="bracket"><span class="id">n2</span></span>, pop <span class="bracket"><span class="id">n1</span></span>, skip <span class="bracket"><span class="id">ofs</span></span> forward if <span class="bracket"><span class="id">n1</span>&lt;=<span class="id">n2</span></span>  *)</span><br/>
&nbsp;&nbsp;| <span class="id"><a name="Ibgt">Ibgt</a></span>(<span class="id">ofs</span>: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>)                 <span class="docright">(* pop <span class="bracket"><span class="id">n2</span></span>, pop <span class="bracket"><span class="id">n1</span></span>, skip <span class="bracket"><span class="id">ofs</span></span> forward if <span class="bracket"><span class="id">n1</span>&gt;<span class="id">n2</span></span>  *)</span><br/>
&nbsp;&nbsp;| <span class="id"><a name="Ihalt">Ihalt</a></span>.                         <span class="docright">(* terminate execution successfully  *)</span><br/>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="code">code</a></span> := <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#list">list</a></span> <span class="id"><a href="compiler.Compiler.html#instruction">instruction</a></span>.<br/>
<br/>
<div class="doc"><span class="bracket"><span class="id">code_at</span> <span class="id">C</span> <span class="id">pc</span> = <span class="id">Some</span> <span class="id">i</span></span> if <span class="bracket"><span class="id">i</span></span> is the instruction at position <span class="bracket"><span class="id">pc</span></span>
  in the list of instructions <span class="bracket"><span class="id">C</span></span>. </div>
<br/>
<span class="kwd">Fixpoint</span> <span class="id"><a name="code_at">code_at</a></span> (<span class="id">C</span>: <span class="id"><a href="compiler.Compiler.html#code">code</a></span>) (<span class="id">pc</span>: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>) : <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#option">option</a></span> <span class="id"><a href="compiler.Compiler.html#instruction">instruction</a></span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span>, <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span>, <span class="id">_</span> =&gt; <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#None">None</a></span><br/>
&nbsp;&nbsp;| <span class="id">i</span> :: <span class="id">C</span>', <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#O">O</a></span> =&gt; <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">i</span><br/>
&nbsp;&nbsp;| <span class="id">i</span> :: <span class="id">C</span>', <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#S">S</a></span> <span class="id">pc</span>' =&gt; <span class="id"><a href="compiler.Compiler.html#code_at">code_at</a></span> <span class="id">C</span>' <span class="id">pc</span>'<br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="stack">stack</a></span> := <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#list">list</a></span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>.<br/>
<br/>
<div class="doc">The semantics of the virtual machine is given in small-step style,
  as a transition relation between machine configuration: triples
  (program counter, evaluation stack, variable state).
  The transition relation is parameterized by the code <span class="bracket"><span class="id">c</span></span>.
  There is one transition rule for each kind of instruction,
  except <span class="bracket"><span class="id">Ihalt</span></span>, which has no transition. </div>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="configuration">configuration</a></span> := (<span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span> * <span class="id"><a href="compiler.Compiler.html#stack">stack</a></span> * <span class="id"><a href="../SF/lf/Imp.html#state">state</a></span>)%<span class="id">type</span>.<br/>
<br/>
<span class="kwd">Inductive</span> <span class="id"><a name="transition">transition</a></span> (<span class="id">C</span>: <span class="id"><a href="compiler.Compiler.html#code">code</a></span>): <span class="id"><a href="compiler.Compiler.html#configuration">configuration</a></span> -&gt; <span class="id"><a href="compiler.Compiler.html#configuration">configuration</a></span> -&gt; <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id"><a name="trans_const">trans_const</a></span>: <span class="kwd">forall</span> <span class="id">pc</span> <span class="id">stk</span> <span class="id">s</span> <span class="id">n</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#code_at">code_at</a></span> <span class="id">C</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span>(<span class="id"><a href="compiler.Compiler.html#Iconst">Iconst</a></span> <span class="id"><a href="compiler.Compiler.html#n">n</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id">C</span> (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>, <span class="id"><a href="compiler.Compiler.html#s">s</a></span>) (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + 1, <span class="id"><a href="compiler.Compiler.html#n">n</a></span> :: <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>, <span class="id"><a href="compiler.Compiler.html#s">s</a></span>)<br/>
&nbsp;&nbsp;| <span class="id"><a name="trans_var">trans_var</a></span>: <span class="kwd">forall</span> <span class="id">pc</span> <span class="id">stk</span> <span class="id">s</span> <span class="id">x</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#code_at">code_at</a></span> <span class="id">C</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span>(<span class="id"><a href="compiler.Compiler.html#Ivar">Ivar</a></span> <span class="id"><a href="compiler.Compiler.html#x">x</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id">C</span> (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>, <span class="id"><a href="compiler.Compiler.html#s">s</a></span>) (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + 1, <span class="id"><a href="compiler.Compiler.html#s">s</a></span> <span class="id"><a href="compiler.Compiler.html#x">x</a></span> :: <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>, <span class="id"><a href="compiler.Compiler.html#s">s</a></span>)<br/>
&nbsp;&nbsp;| <span class="id"><a name="trans_setvar">trans_setvar</a></span>: <span class="kwd">forall</span> <span class="id">pc</span> <span class="id">stk</span> <span class="id">s</span> <span class="id">x</span> <span class="id">n</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#code_at">code_at</a></span> <span class="id">C</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span>(<span class="id"><a href="compiler.Compiler.html#Isetvar">Isetvar</a></span> <span class="id"><a href="compiler.Compiler.html#x">x</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id">C</span> (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="compiler.Compiler.html#n">n</a></span> :: <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>, <span class="id"><a href="compiler.Compiler.html#s">s</a></span>) (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + 1, <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>, <span class="id"><a href="../SF/lf/Maps.html#t_update">t_update</a></span> <span class="id"><a href="compiler.Compiler.html#s">s</a></span> <span class="id"><a href="compiler.Compiler.html#x">x</a></span> <span class="id"><a href="compiler.Compiler.html#n">n</a></span>)<br/>
&nbsp;&nbsp;| <span class="id"><a name="trans_add">trans_add</a></span>: <span class="kwd">forall</span> <span class="id">pc</span> <span class="id">stk</span> <span class="id">s</span> <span class="id">n1</span> <span class="id">n2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#code_at">code_at</a></span> <span class="id">C</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span>(<span class="id"><a href="compiler.Compiler.html#Iadd">Iadd</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id">C</span> (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="compiler.Compiler.html#n2">n2</a></span> :: <span class="id"><a href="compiler.Compiler.html#n1">n1</a></span> :: <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>, <span class="id"><a href="compiler.Compiler.html#s">s</a></span>) (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + 1, (<span class="id"><a href="compiler.Compiler.html#n1">n1</a></span> + <span class="id"><a href="compiler.Compiler.html#n2">n2</a></span>) :: <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>, <span class="id"><a href="compiler.Compiler.html#s">s</a></span>)<br/>
&nbsp;&nbsp;| <span class="id"><a name="trans_sub">trans_sub</a></span>: <span class="kwd">forall</span> <span class="id">pc</span> <span class="id">stk</span> <span class="id">s</span> <span class="id">n1</span> <span class="id">n2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#code_at">code_at</a></span> <span class="id">C</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span>(<span class="id"><a href="compiler.Compiler.html#Isub">Isub</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id">C</span> (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="compiler.Compiler.html#n2">n2</a></span> :: <span class="id"><a href="compiler.Compiler.html#n1">n1</a></span> :: <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>, <span class="id"><a href="compiler.Compiler.html#s">s</a></span>) (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + 1, (<span class="id"><a href="compiler.Compiler.html#n1">n1</a></span> - <span class="id"><a href="compiler.Compiler.html#n2">n2</a></span>) :: <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>, <span class="id"><a href="compiler.Compiler.html#s">s</a></span>)<br/>
&nbsp;&nbsp;| <span class="id"><a name="trans_mul">trans_mul</a></span>: <span class="kwd">forall</span> <span class="id">pc</span> <span class="id">stk</span> <span class="id">s</span> <span class="id">n1</span> <span class="id">n2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#code_at">code_at</a></span> <span class="id">C</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span>(<span class="id"><a href="compiler.Compiler.html#Imul">Imul</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id">C</span> (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="compiler.Compiler.html#n2">n2</a></span> :: <span class="id"><a href="compiler.Compiler.html#n1">n1</a></span> :: <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>, <span class="id"><a href="compiler.Compiler.html#s">s</a></span>) (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + 1, (<span class="id"><a href="compiler.Compiler.html#n1">n1</a></span> * <span class="id"><a href="compiler.Compiler.html#n2">n2</a></span>) :: <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>, <span class="id"><a href="compiler.Compiler.html#s">s</a></span>)<br/>
&nbsp;&nbsp;| <span class="id"><a name="trans_branch_forward">trans_branch_forward</a></span>: <span class="kwd">forall</span> <span class="id">pc</span> <span class="id">stk</span> <span class="id">s</span> <span class="id">ofs</span> <span class="id">pc</span>',<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#code_at">code_at</a></span> <span class="id">C</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span>(<span class="id"><a href="compiler.Compiler.html#Ibranch_forward">Ibranch_forward</a></span> <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">pc</span>' = <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + 1 + <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id">C</span> (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>, <span class="id"><a href="compiler.Compiler.html#s">s</a></span>) (<span class="id">pc</span>', <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>, <span class="id"><a href="compiler.Compiler.html#s">s</a></span>)<br/>
&nbsp;&nbsp;| <span class="id"><a name="trans_branch_backward">trans_branch_backward</a></span>: <span class="kwd">forall</span> <span class="id">pc</span> <span class="id">stk</span> <span class="id">s</span> <span class="id">ofs</span> <span class="id">pc</span>',<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#code_at">code_at</a></span> <span class="id">C</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span>(<span class="id"><a href="compiler.Compiler.html#Ibranch_backward">Ibranch_backward</a></span> <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">pc</span>' = <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + 1 - <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id">C</span> (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>, <span class="id"><a href="compiler.Compiler.html#s">s</a></span>) (<span class="id">pc</span>', <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>, <span class="id"><a href="compiler.Compiler.html#s">s</a></span>)<br/>
&nbsp;&nbsp;| <span class="id"><a name="trans_beq">trans_beq</a></span>: <span class="kwd">forall</span> <span class="id">pc</span> <span class="id">stk</span> <span class="id">s</span> <span class="id">ofs</span> <span class="id">n1</span> <span class="id">n2</span> <span class="id">pc</span>',<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#code_at">code_at</a></span> <span class="id">C</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span>(<span class="id"><a href="compiler.Compiler.html#Ibeq">Ibeq</a></span> <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">pc</span>' = (<span class="kwd">if</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Arith.EqNat.html#beq_nat">beq_nat</a></span> <span class="id"><a href="compiler.Compiler.html#n1">n1</a></span> <span class="id"><a href="compiler.Compiler.html#n2">n2</a></span> <span class="kwd">then</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + 1 + <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span> <span class="kwd">else</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + 1) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id">C</span> (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="compiler.Compiler.html#n2">n2</a></span> :: <span class="id"><a href="compiler.Compiler.html#n1">n1</a></span> :: <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>, <span class="id"><a href="compiler.Compiler.html#s">s</a></span>) (<span class="id">pc</span>', <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>, <span class="id"><a href="compiler.Compiler.html#s">s</a></span>)<br/>
&nbsp;&nbsp;| <span class="id"><a name="trans_bne">trans_bne</a></span>: <span class="kwd">forall</span> <span class="id">pc</span> <span class="id">stk</span> <span class="id">s</span> <span class="id">ofs</span> <span class="id">n1</span> <span class="id">n2</span> <span class="id">pc</span>',<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#code_at">code_at</a></span> <span class="id">C</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span>(<span class="id"><a href="compiler.Compiler.html#Ibne">Ibne</a></span> <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">pc</span>' = (<span class="kwd">if</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Arith.EqNat.html#beq_nat">beq_nat</a></span> <span class="id"><a href="compiler.Compiler.html#n1">n1</a></span> <span class="id"><a href="compiler.Compiler.html#n2">n2</a></span> <span class="kwd">then</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + 1 <span class="kwd">else</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + 1 + <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id">C</span> (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="compiler.Compiler.html#n2">n2</a></span> :: <span class="id"><a href="compiler.Compiler.html#n1">n1</a></span> :: <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>, <span class="id"><a href="compiler.Compiler.html#s">s</a></span>) (<span class="id">pc</span>', <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>, <span class="id"><a href="compiler.Compiler.html#s">s</a></span>)<br/>
&nbsp;&nbsp;| <span class="id"><a name="trans_ble">trans_ble</a></span>: <span class="kwd">forall</span> <span class="id">pc</span> <span class="id">stk</span> <span class="id">s</span> <span class="id">ofs</span> <span class="id">n1</span> <span class="id">n2</span> <span class="id">pc</span>',<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#code_at">code_at</a></span> <span class="id">C</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span>(<span class="id"><a href="compiler.Compiler.html#Ible">Ible</a></span> <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">pc</span>' = (<span class="kwd">if</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Arith.Compare_dec.html#leb">leb</a></span> <span class="id"><a href="compiler.Compiler.html#n1">n1</a></span> <span class="id"><a href="compiler.Compiler.html#n2">n2</a></span> <span class="kwd">then</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + 1 + <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span> <span class="kwd">else</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + 1) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id">C</span> (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="compiler.Compiler.html#n2">n2</a></span> :: <span class="id"><a href="compiler.Compiler.html#n1">n1</a></span> :: <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>, <span class="id"><a href="compiler.Compiler.html#s">s</a></span>) (<span class="id">pc</span>', <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>, <span class="id"><a href="compiler.Compiler.html#s">s</a></span>)<br/>
&nbsp;&nbsp;| <span class="id"><a name="trans_bgt">trans_bgt</a></span>: <span class="kwd">forall</span> <span class="id">pc</span> <span class="id">stk</span> <span class="id">s</span> <span class="id">ofs</span> <span class="id">n1</span> <span class="id">n2</span> <span class="id">pc</span>',<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#code_at">code_at</a></span> <span class="id">C</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span>(<span class="id"><a href="compiler.Compiler.html#Ibgt">Ibgt</a></span> <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">pc</span>' = (<span class="kwd">if</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Arith.Compare_dec.html#leb">leb</a></span> <span class="id"><a href="compiler.Compiler.html#n1">n1</a></span> <span class="id"><a href="compiler.Compiler.html#n2">n2</a></span> <span class="kwd">then</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + 1 <span class="kwd">else</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + 1 + <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id">C</span> (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="compiler.Compiler.html#n2">n2</a></span> :: <span class="id"><a href="compiler.Compiler.html#n1">n1</a></span> :: <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>, <span class="id"><a href="compiler.Compiler.html#s">s</a></span>) (<span class="id">pc</span>', <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>, <span class="id"><a href="compiler.Compiler.html#s">s</a></span>).<br/>
<br/>
<div class="doc">As usual with small-step semantics, we form sequences of machine transitions
  to define the behavior of a code.  We always start with <span class="bracket"><span class="id">pc</span> = 0</span>
  and an empty evaluation stack.  We stop successfully if <span class="bracket"><span class="id">pc</span></span> points
  to an <span class="bracket"><span class="id">Ihalt</span></span> instruction and the evaluation stack is empty.
  If <span class="bracket"><span class="id">R</span></span> is a binary relation, <span class="bracket"><span class="id">star</span> <span class="id">R</span></span> is its reflexive transitive closure.
  (See file <span class="bracket"><span class="id">Sequences</span></span> for the definition.)  <span class="bracket"><span class="id">star</span> (<span class="id">transition</span> <span class="id">C</span>)</span>
  therefore represents a sequence of  zero, one or several machine transitions.
</div>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="mach_terminates">mach_terminates</a></span> (<span class="id">C</span>: <span class="id"><a href="compiler.Compiler.html#code">code</a></span>) (<span class="id">s_init</span> <span class="id">s_fin</span>: <span class="id"><a href="../SF/lf/Imp.html#state">state</a></span>) :=<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">pc</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#code_at">code_at</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id"><a href="compiler.Compiler.html#Ihalt">Ihalt</a></span> /\<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Sequences.html#star">star</a></span> (<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span>) (0, <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span>, <span class="id"><a href="compiler.Compiler.html#s_init">s_init</a></span>) (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span>, <span class="id"><a href="compiler.Compiler.html#s_fin">s_fin</a></span>).<br/>
<br/>
<div class="doc">Likewise, <span class="bracket"><span class="id">infseq</span> <span class="id">R</span></span> represents an infinite sequence of <span class="bracket"><span class="id">R</span></span> transitions.
  (Also defined in file <span class="bracket"><span class="id">Sequences</span></span>.) </div>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="mach_diverges">mach_diverges</a></span> (<span class="id">C</span>: <span class="id"><a href="compiler.Compiler.html#code">code</a></span>) (<span class="id">s_init</span>: <span class="id"><a href="../SF/lf/Imp.html#state">state</a></span>) :=<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Sequences.html#infseq">infseq</a></span> (<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span>) (0, <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span>, <span class="id"><a href="compiler.Compiler.html#s_init">s_init</a></span>).<br/>
<br/>
<div class="doc">A third case can occur: after a finite number of transitions,
  the machine hits a configuration where it cannot make any transition,
  and this state is not a final configuration (<span class="bracket"><span class="id">Ihalt</span></span> instruction and empty stack).
  In this case, we say that the machine "goes wrong", which is
  a politically-correct way of saying that our program just crashed. </div>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="mach_goes_wrong">mach_goes_wrong</a></span> (<span class="id">C</span>: <span class="id"><a href="compiler.Compiler.html#code">code</a></span>) (<span class="id">s_init</span>: <span class="id"><a href="../SF/lf/Imp.html#state">state</a></span>) :=<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">pc</span>, <span class="id">exists</span> <span class="id">stk</span>, <span class="id">exists</span> <span class="id">s_fin</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Sequences.html#star">star</a></span> (<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span>) (0, <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span>, <span class="id"><a href="compiler.Compiler.html#s_init">s_init</a></span>) (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>, <span class="id"><a href="compiler.Compiler.html#s_fin">s_fin</a></span>)<br/>
&nbsp;&nbsp;/\ <span class="id"><a href="compiler.Sequences.html#irred">irred</a></span> (<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span>) (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>, <span class="id"><a href="compiler.Compiler.html#s_fin">s_fin</a></span>)<br/>
&nbsp;&nbsp;/\ (<span class="id"><a href="compiler.Compiler.html#code_at">code_at</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> &lt;&gt; <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id"><a href="compiler.Compiler.html#Ihalt">Ihalt</a></span> \/ <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span> &lt;&gt; <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span>).<br/>
<br/>
<div class="doc">An important property of the virtual machine is that it is deterministic:
  from a given configuration, it can transition to at most one other configuration. </div>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="machine_deterministic">machine_deterministic</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">C</span> <span class="id">config</span> <span class="id">config1</span> <span class="id">config2</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id"><a href="compiler.Compiler.html#config">config</a></span> <span class="id"><a href="compiler.Compiler.html#config1">config1</a></span> -&gt; <span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id"><a href="compiler.Compiler.html#config">config</a></span> <span class="id"><a href="compiler.Compiler.html#config2">config2</a></span> -&gt; <span class="id"><a href="compiler.Compiler.html#config1">config1</a></span> = <span class="id"><a href="compiler.Compiler.html#config2">config2</a></span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof1')">Proof.</div>
<div class="proofscript" id="proof1">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">inversion</span> <span class="id">H</span>; <span class="tactic">subst</span>; <span class="tactic">inversion</span> <span class="id">H0</span>; <span class="tactic">try</span> <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id"><a href="http://coq.inria.fr/library/Coq.Arith.EqNat.html#beq_nat">beq_nat</a></span> <span class="id">n1</span> <span class="id">n2</span>); <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id"><a href="http://coq.inria.fr/library/Coq.Arith.EqNat.html#beq_nat">beq_nat</a></span> <span class="id">n1</span> <span class="id">n2</span>); <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id"><a href="http://coq.inria.fr/library/Coq.Arith.Compare_dec.html#leb">leb</a></span> <span class="id">n1</span> <span class="id">n2</span>); <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id"><a href="http://coq.inria.fr/library/Coq.Arith.Compare_dec.html#leb">leb</a></span> <span class="id">n1</span> <span class="id">n2</span>); <span class="tactic">congruence</span>.<br/>
Qed.</div>
<br/>
<div class="doc">As a consequence of this determinism, it follows that
  the final state of a terminating program is unique,
  and that a program cannot both terminate and diverge,
  or terminate and go wrong, or diverge and go wrong.
  These results follow from the generic determinism properties 
  found at the end of module <span class="bracket"><span class="id">Sequence</span></span>. </div>
<br/>
<span class="kwd">Remark</span> <span class="id"><a name="stop_irred">stop_irred</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">C</span> <span class="id">pc</span> <span class="id">stk</span> <span class="id">st</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#code_at">code_at</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id"><a href="compiler.Compiler.html#Ihalt">Ihalt</a></span> -&gt; <span class="id"><a href="compiler.Sequences.html#irred">irred</a></span> (<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span>) (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>, <span class="id"><a href="compiler.Compiler.html#st">st</a></span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2')">Proof.</div>
<div class="proofscript" id="proof2">
&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id"><a href="compiler.Sequences.html#irred">irred</a></span>; <span class="tactic">intros</span>. <span class="tactic">unfold</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Logic.html#not">not</a></span>; <span class="tactic">intros</span>. <span class="tactic">inversion</span> <span class="id">H0</span>; <span class="tactic">congruence</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="terminates_unique">terminates_unique</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">C</span> <span class="id">st</span> <span class="id">st1</span> <span class="id">st2</span>, <span class="id"><a href="compiler.Compiler.html#mach_terminates">mach_terminates</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id"><a href="compiler.Compiler.html#st">st</a></span> <span class="id"><a href="compiler.Compiler.html#st1">st1</a></span> -&gt; <span class="id"><a href="compiler.Compiler.html#mach_terminates">mach_terminates</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id"><a href="compiler.Compiler.html#st">st</a></span> <span class="id"><a href="compiler.Compiler.html#st2">st2</a></span> -&gt; <span class="id"><a href="compiler.Compiler.html#st1">st1</a></span> = <span class="id"><a href="compiler.Compiler.html#st2">st2</a></span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof3')">Proof.</div>
<div class="proofscript" id="proof3">
&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id"><a href="compiler.Compiler.html#mach_terminates">mach_terminates</a></span>; <span class="tactic">intros</span>. <span class="tactic">destruct</span> <span class="id">H</span> <span class="kwd">as</span> (<span class="id">pc1</span> &amp; <span class="id">A1</span> &amp; <span class="id">B1</span>), <span class="id">H0</span> <span class="kwd">as</span> (<span class="id">pc2</span> &amp; <span class="id">A2</span> &amp; <span class="id">B2</span>).<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (((<span class="id">pc1</span>, <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span>, <span class="id">st1</span>) : <span class="id"><a href="compiler.Compiler.html#configuration">configuration</a></span>) = ((<span class="id">pc2</span>, <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span>, <span class="id">st2</span>) : <span class="id"><a href="compiler.Compiler.html#configuration">configuration</a></span>)).<br/>
&nbsp;&nbsp;{ <span class="tactic">eapply</span> <span class="id"><a href="compiler.Sequences.html#finseq_unique">finseq_unique</a></span>; <span class="tactic">eauto</span> <span class="kwd">using</span> <span class="id"><a href="compiler.Compiler.html#machine_deterministic">machine_deterministic</a></span>, <span class="id"><a href="compiler.Compiler.html#stop_irred">stop_irred</a></span>. }<br/>
&nbsp;&nbsp;<span class="tactic">congruence</span>. <br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="terminates_goeswrong_exclusive">terminates_goeswrong_exclusive</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">C</span> <span class="id">st</span> <span class="id">st</span>', <span class="id"><a href="compiler.Compiler.html#mach_terminates">mach_terminates</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id"><a href="compiler.Compiler.html#st">st</a></span> <span class="id">st</span>' -&gt; <span class="id"><a href="compiler.Compiler.html#mach_goes_wrong">mach_goes_wrong</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id"><a href="compiler.Compiler.html#st">st</a></span> -&gt; <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Logic.html#False">False</a></span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4')">Proof.</div>
<div class="proofscript" id="proof4">
&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id"><a href="compiler.Compiler.html#mach_terminates">mach_terminates</a></span>, <span class="id"><a href="compiler.Compiler.html#mach_goes_wrong">mach_goes_wrong</a></span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">H</span> <span class="kwd">as</span> (<span class="id">pc1</span> &amp; <span class="id">A1</span> &amp; <span class="id">B1</span>), <span class="id">H0</span> <span class="kwd">as</span> (<span class="id">pc2</span> &amp; <span class="id">stk2</span> &amp; <span class="id">st2</span> &amp; <span class="id">A2</span> &amp; <span class="id">B2</span> &amp; <span class="id">C2</span>).<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (((<span class="id">pc1</span>, <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span>, <span class="id">st</span>') : <span class="id"><a href="compiler.Compiler.html#configuration">configuration</a></span>) = ((<span class="id">pc2</span>, <span class="id">stk2</span>, <span class="id">st2</span>) : <span class="id"><a href="compiler.Compiler.html#configuration">configuration</a></span>)).<br/>
&nbsp;&nbsp;{ <span class="tactic">eapply</span> <span class="id"><a href="compiler.Sequences.html#finseq_unique">finseq_unique</a></span>; <span class="tactic">eauto</span> <span class="kwd">using</span> <span class="id"><a href="compiler.Compiler.html#machine_deterministic">machine_deterministic</a></span>, <span class="id"><a href="compiler.Compiler.html#stop_irred">stop_irred</a></span>. }<br/>
&nbsp;&nbsp;<span class="tactic">inversion</span> <span class="id">H</span>. <span class="tactic">subst</span> <span class="id">pc2</span> <span class="id">stk2</span> <span class="id">st2</span>. <span class="tactic">destruct</span> <span class="id">C2</span>; <span class="tactic">congruence</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="terminates_diverges_exclusive">terminates_diverges_exclusive</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">C</span> <span class="id">st</span> <span class="id">st</span>', <span class="id"><a href="compiler.Compiler.html#mach_terminates">mach_terminates</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id"><a href="compiler.Compiler.html#st">st</a></span> <span class="id">st</span>' -&gt; <span class="id"><a href="compiler.Compiler.html#mach_diverges">mach_diverges</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id"><a href="compiler.Compiler.html#st">st</a></span> -&gt; <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Logic.html#False">False</a></span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof5')">Proof.</div>
<div class="proofscript" id="proof5">
&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id"><a href="compiler.Compiler.html#mach_terminates">mach_terminates</a></span>, <span class="id"><a href="compiler.Compiler.html#mach_diverges">mach_diverges</a></span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">H</span> <span class="kwd">as</span> (<span class="id">pc1</span> &amp; <span class="id">A1</span> &amp; <span class="id">B1</span>).<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id"><a href="compiler.Sequences.html#infseq_finseq_excl">infseq_finseq_excl</a></span> <span class="kwd">with</span> (<span class="id">R</span> := <span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id">C</span>); <span class="tactic">eauto</span> <span class="kwd">using</span> <span class="id"><a href="compiler.Compiler.html#machine_deterministic">machine_deterministic</a></span>, <span class="id"><a href="compiler.Compiler.html#stop_irred">stop_irred</a></span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="goeswrong_diverges_exclusive">goeswrong_diverges_exclusive</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">C</span> <span class="id">st</span>, <span class="id"><a href="compiler.Compiler.html#mach_goes_wrong">mach_goes_wrong</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id"><a href="compiler.Compiler.html#st">st</a></span> -&gt; <span class="id"><a href="compiler.Compiler.html#mach_diverges">mach_diverges</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id"><a href="compiler.Compiler.html#st">st</a></span> -&gt; <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Logic.html#False">False</a></span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof6')">Proof.</div>
<div class="proofscript" id="proof6">
&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id"><a href="compiler.Compiler.html#mach_terminates">mach_terminates</a></span>, <span class="id"><a href="compiler.Compiler.html#mach_diverges">mach_diverges</a></span>; <span class="tactic">intros</span>. <br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">H</span> <span class="kwd">as</span> (<span class="id">pc2</span> &amp; <span class="id">stk2</span> &amp; <span class="id">st2</span> &amp; <span class="id">A2</span> &amp; <span class="id">B2</span> &amp; <span class="id">C2</span>).<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id"><a href="compiler.Sequences.html#infseq_finseq_excl">infseq_finseq_excl</a></span> <span class="kwd">with</span> (<span class="id">R</span> := <span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id">C</span>); <span class="tactic">eauto</span> <span class="kwd">using</span> <span class="id"><a href="compiler.Compiler.html#machine_deterministic">machine_deterministic</a></span>, <span class="id"><a href="compiler.Compiler.html#stop_irred">stop_irred</a></span>.<br/>
Qed.</div>
<br/>
<h3> Exercise (2 stars, recommended). </h3>
<div class="doc">To quickly see how a machine program executes, it is convenient
  to redefine the semantics of the machine as an executable function
  instead of inductively-defined relations.  This is similar to the
  <span class="bracket"><span class="id">ceval_step</span></span> function from the <span class="bracket"><span class="id">Imp</span></span> chapter of Software Foundations,
  which provides an executable interpreter for the Imp language.
  To ensure termination of the machine interpreter, we need to bound 
  the number of instructions it can execute.  The result of the
  machine interpreter, therefore, is of the following type:
</div>
<br/>
<span class="kwd">Inductive</span> <span class="id"><a name="machine_result">machine_result</a></span> : <span class="kwd">Type</span> :=<br/>
&nbsp;&nbsp;| <span class="id"><a name="Timeout">Timeout</a></span> : <span class="id"><a href="compiler.Compiler.html#machine_result">machine_result</a></span>              <span class="docright">(* the interpreter ran out of fuel  *)</span><br/>
&nbsp;&nbsp;| <span class="id"><a name="GoesWrong">GoesWrong</a></span> : <span class="id"><a href="compiler.Compiler.html#machine_result">machine_result</a></span>            <span class="docright">(* the machine goes wrong on an impossible case  *)</span><br/>
&nbsp;&nbsp;| <span class="id"><a name="Terminates">Terminates</a></span> : <span class="id"><a href="../SF/lf/Imp.html#state">state</a></span> -&gt; <span class="id"><a href="compiler.Compiler.html#machine_result">machine_result</a></span>. <span class="docright">(* the machine successfully stops with the given state  *)</span><br/>
<br/>
<div class="doc">Please fill in the blanks in the following definition for a machine interpreter: </div>
<br/>
<span class="kwd">Fixpoint</span> <span class="id"><a name="mach_interp">mach_interp</a></span> (<span class="id">C</span>: <span class="id"><a href="compiler.Compiler.html#code">code</a></span>) (<span class="id">fuel</span>: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">pc</span>: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>) (<span class="id">stk</span>: <span class="id"><a href="compiler.Compiler.html#stack">stack</a></span>) (<span class="id">st</span>: <span class="id"><a href="../SF/lf/Imp.html#state">state</a></span>) : <span class="id"><a href="compiler.Compiler.html#machine_result">machine_result</a></span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id"><a href="compiler.Compiler.html#fuel">fuel</a></span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#O">O</a></span> =&gt; <span class="id"><a href="compiler.Compiler.html#Timeout">Timeout</a></span><br/>
&nbsp;&nbsp;| <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#S">S</a></span> <span class="id">fuel</span>' =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id"><a href="compiler.Compiler.html#code_at">code_at</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id"><a href="compiler.Compiler.html#Ihalt">Ihalt</a></span>, <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span> =&gt; <span class="id"><a href="compiler.Compiler.html#Terminates">Terminates</a></span> <span class="id"><a href="compiler.Compiler.html#st">st</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> (<span class="id"><a href="compiler.Compiler.html#Iconst">Iconst</a></span> <span class="id">n</span>), <span class="id">stk</span> =&gt; <span class="id"><a href="compiler.Compiler.html#mach_interp">mach_interp</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id">fuel</span>' (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + 1) (<span class="id">n</span> :: <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>) <span class="id"><a href="compiler.Compiler.html#st">st</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span>, <span class="id">_</span> =&gt; <span class="id"><a href="compiler.Compiler.html#GoesWrong">GoesWrong</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<h1> 2. The compilation scheme </h1>
<br/>
<div class="doc">The code for an arithmetic expression <span class="bracket"><span class="id">a</span></span>
<ul>
<li>
 executes in sequence (no branches)
</li>
<li>
 deposits the value of <span class="bracket"><span class="id">a</span></span> at the top of the stack
</li>
<li>
 preserves the variable state.
</li>
</ul>
This is the familiar translation to "reverse Polish notation".
</div>
<br/>
<span class="kwd">Fixpoint</span> <span class="id"><a name="compile_aexp">compile_aexp</a></span> (<span class="id">a</span>: <span class="id"><a href="../SF/lf/Imp.html#aexp">aexp</a></span>) : <span class="id"><a href="compiler.Compiler.html#code">code</a></span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id"><a href="compiler.Compiler.html#a">a</a></span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id"><a href="../SF/lf/Imp.html#ANum">ANum</a></span> <span class="id">n</span> =&gt; <span class="id"><a href="compiler.Compiler.html#Iconst">Iconst</a></span> <span class="id">n</span> :: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span><br/>
&nbsp;&nbsp;| <span class="id"><a href="../SF/lf/Imp.html#AId">AId</a></span> <span class="id">v</span> =&gt; <span class="id"><a href="compiler.Compiler.html#Ivar">Ivar</a></span> <span class="id">v</span> :: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span><br/>
&nbsp;&nbsp;| <span class="id"><a href="../SF/lf/Imp.html#APlus">APlus</a></span> <span class="id">a1</span> <span class="id">a2</span> =&gt; <span class="id"><a href="compiler.Compiler.html#compile_aexp">compile_aexp</a></span> <span class="id">a1</span> ++ <span class="id"><a href="compiler.Compiler.html#compile_aexp">compile_aexp</a></span> <span class="id">a2</span> ++ <span class="id"><a href="compiler.Compiler.html#Iadd">Iadd</a></span> :: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span><br/>
&nbsp;&nbsp;| <span class="id"><a href="../SF/lf/Imp.html#AMinus">AMinus</a></span> <span class="id">a1</span> <span class="id">a2</span> =&gt; <span class="id"><a href="compiler.Compiler.html#compile_aexp">compile_aexp</a></span> <span class="id">a1</span> ++ <span class="id"><a href="compiler.Compiler.html#compile_aexp">compile_aexp</a></span> <span class="id">a2</span> ++ <span class="id"><a href="compiler.Compiler.html#Isub">Isub</a></span> :: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span><br/>
&nbsp;&nbsp;| <span class="id"><a href="../SF/lf/Imp.html#AMult">AMult</a></span> <span class="id">a1</span> <span class="id">a2</span> =&gt; <span class="id"><a href="compiler.Compiler.html#compile_aexp">compile_aexp</a></span> <span class="id">a1</span> ++ <span class="id"><a href="compiler.Compiler.html#compile_aexp">compile_aexp</a></span> <span class="id">a2</span> ++ <span class="id"><a href="compiler.Compiler.html#Imul">Imul</a></span> :: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<div class="doc">Some examples. </div>
<br/>
<span class="kwd">Notation</span> <span class="id"><a name="vx">vx</a></span> := (<span class="id"><a href="../SF/lf/Maps.html#Id">Id</a></span> "<span class="id">X</span>").<br/>
<span class="kwd">Notation</span> <span class="id"><a name="vy">vy</a></span> := (<span class="id"><a href="../SF/lf/Maps.html#Id">Id</a></span> "<span class="id">Y</span>").<br/>
<br/>
<span class="id">Compute</span> (<span class="id"><a href="compiler.Compiler.html#compile_aexp">compile_aexp</a></span> (<span class="id"><a href="../SF/lf/Imp.html#APlus">APlus</a></span> (<span class="id"><a href="../SF/lf/Imp.html#AId">AId</a></span> <span class="id"><a href="compiler.Compiler.html#vx">vx</a></span>) (<span class="id"><a href="../SF/lf/Imp.html#ANum">ANum</a></span> 1))).<br/>
<br/>
<div class="doc">Result is: <span class="bracket"> [<span class="id">Ivar</span> <span class="id">vx</span>, <span class="id">Iconst</span> 1, <span class="id">Iadd</span>] </span> </div>
<br/>
<span class="id">Compute</span> (<span class="id"><a href="compiler.Compiler.html#compile_aexp">compile_aexp</a></span> (<span class="id"><a href="../SF/lf/Imp.html#AMult">AMult</a></span> (<span class="id"><a href="../SF/lf/Imp.html#AId">AId</a></span> <span class="id"><a href="compiler.Compiler.html#vy">vy</a></span>) (<span class="id"><a href="../SF/lf/Imp.html#APlus">APlus</a></span> (<span class="id"><a href="../SF/lf/Imp.html#AId">AId</a></span> <span class="id"><a href="compiler.Compiler.html#vx">vx</a></span>) (<span class="id"><a href="../SF/lf/Imp.html#ANum">ANum</a></span> 1)))).<br/>
<br/>
<div class="doc">Result is: <span class="bracket"> [<span class="id">Ivar</span> <span class="id">vy</span>, <span class="id">Ivar</span> <span class="id">vx</span>, <span class="id">Iconst</span> 1, <span class="id">Iadd</span>, <span class="id">Imul</span>] </span> </div>
<br/>
<div class="doc">The code <span class="bracket"><span class="id">compile_bexp</span> <span class="id">b</span> <span class="id">cond</span> <span class="id">ofs</span></span> for a boolean expression <span class="bracket"><span class="id">b</span></span>
<ul>
<li>
 skips forward the <span class="bracket"><span class="id">ofs</span></span> following instructions if <span class="bracket"><span class="id">b</span></span> evaluates to <span class="bracket"><span class="id">cond</span></span> (a boolean)
</li>
<li>
 executes in sequence if <span class="bracket"><span class="id">b</span></span> evaluates to the negation of <span class="bracket"><span class="id">cond</span></span>
</li>
<li>
 leaves the stack and the variable state unchanged.
</li>
</ul>
See slides for explanation of the mysterious branch offsets!
</div>
<br/>
<span class="kwd">Fixpoint</span> <span class="id"><a name="compile_bexp">compile_bexp</a></span> (<span class="id">b</span>: <span class="id"><a href="../SF/lf/Imp.html#bexp">bexp</a></span>) (<span class="id">cond</span>: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#bool">bool</a></span>) (<span class="id">ofs</span>: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>) : <span class="id"><a href="compiler.Compiler.html#code">code</a></span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id"><a href="compiler.Compiler.html#b">b</a></span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id"><a href="../SF/lf/Imp.html#BTrue">BTrue</a></span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">if</span> <span class="id"><a href="compiler.Compiler.html#cond">cond</a></span> <span class="kwd">then</span> <span class="id"><a href="compiler.Compiler.html#Ibranch_forward">Ibranch_forward</a></span> <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span> :: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span> <span class="kwd">else</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span><br/>
&nbsp;&nbsp;| <span class="id"><a href="../SF/lf/Imp.html#BFalse">BFalse</a></span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">if</span> <span class="id"><a href="compiler.Compiler.html#cond">cond</a></span> <span class="kwd">then</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span> <span class="kwd">else</span> <span class="id"><a href="compiler.Compiler.html#Ibranch_forward">Ibranch_forward</a></span> <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span> :: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span><br/>
&nbsp;&nbsp;| <span class="id"><a href="../SF/lf/Imp.html#BEq">BEq</a></span> <span class="id">a1</span> <span class="id">a2</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#compile_aexp">compile_aexp</a></span> <span class="id">a1</span> ++ <span class="id"><a href="compiler.Compiler.html#compile_aexp">compile_aexp</a></span> <span class="id">a2</span> ++<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">if</span> <span class="id"><a href="compiler.Compiler.html#cond">cond</a></span> <span class="kwd">then</span> <span class="id"><a href="compiler.Compiler.html#Ibeq">Ibeq</a></span> <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span> :: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span> <span class="kwd">else</span> <span class="id"><a href="compiler.Compiler.html#Ibne">Ibne</a></span> <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span> :: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span>)<br/>
&nbsp;&nbsp;| <span class="id"><a href="../SF/lf/Imp.html#BLe">BLe</a></span> <span class="id">a1</span> <span class="id">a2</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#compile_aexp">compile_aexp</a></span> <span class="id">a1</span> ++ <span class="id"><a href="compiler.Compiler.html#compile_aexp">compile_aexp</a></span> <span class="id">a2</span> ++<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">if</span> <span class="id"><a href="compiler.Compiler.html#cond">cond</a></span> <span class="kwd">then</span> <span class="id"><a href="compiler.Compiler.html#Ible">Ible</a></span> <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span> :: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span> <span class="kwd">else</span> <span class="id"><a href="compiler.Compiler.html#Ibgt">Ibgt</a></span> <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span> :: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span>)<br/>
&nbsp;&nbsp;| <span class="id"><a href="../SF/lf/Imp.html#BNot">BNot</a></span> <span class="id">b1</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#compile_bexp">compile_bexp</a></span> <span class="id">b1</span> (<span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#negb">negb</a></span> <span class="id"><a href="compiler.Compiler.html#cond">cond</a></span>) <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span><br/>
&nbsp;&nbsp;| <span class="id"><a href="../SF/lf/Imp.html#BAnd">BAnd</a></span> <span class="id">b1</span> <span class="id">b2</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">c2</span> := <span class="id"><a href="compiler.Compiler.html#compile_bexp">compile_bexp</a></span> <span class="id">b2</span> <span class="id"><a href="compiler.Compiler.html#cond">cond</a></span> <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">c1</span> := <span class="id"><a href="compiler.Compiler.html#compile_bexp">compile_bexp</a></span> <span class="id">b1</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#false">false</a></span> (<span class="kwd">if</span> <span class="id"><a href="compiler.Compiler.html#cond">cond</a></span> <span class="kwd">then</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id"><a href="compiler.Compiler.html#c2">c2</a></span> <span class="kwd">else</span> <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span> + <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id"><a href="compiler.Compiler.html#c2">c2</a></span>) <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#c1">c1</a></span> ++ <span class="id"><a href="compiler.Compiler.html#c2">c2</a></span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<div class="doc">Examples. </div>
<br/>
<span class="id">Compute</span> (<span class="id"><a href="compiler.Compiler.html#compile_bexp">compile_bexp</a></span> (<span class="id"><a href="../SF/lf/Imp.html#BEq">BEq</a></span> (<span class="id"><a href="../SF/lf/Imp.html#AId">AId</a></span> <span class="id"><a href="compiler.Compiler.html#vx">vx</a></span>) (<span class="id"><a href="../SF/lf/Imp.html#ANum">ANum</a></span> 1)) <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#true">true</a></span> 42).<br/>
<br/>
<div class="doc">Result is: <span class="bracket"> [<span class="id">Ivar</span> <span class="id">vx</span>, <span class="id">Iconst</span> 1, <span class="id">Ibeq</span> 42] </span> </div>
<br/>
<span class="id">Compute</span> (<span class="id"><a href="compiler.Compiler.html#compile_bexp">compile_bexp</a></span> (<span class="id"><a href="../SF/lf/Imp.html#BAnd">BAnd</a></span> (<span class="id"><a href="../SF/lf/Imp.html#BLe">BLe</a></span> (<span class="id"><a href="../SF/lf/Imp.html#ANum">ANum</a></span> 1) (<span class="id"><a href="../SF/lf/Imp.html#AId">AId</a></span> <span class="id"><a href="compiler.Compiler.html#vx">vx</a></span>)) (<span class="id"><a href="../SF/lf/Imp.html#BLe">BLe</a></span> (<span class="id"><a href="../SF/lf/Imp.html#AId">AId</a></span> <span class="id"><a href="compiler.Compiler.html#vx">vx</a></span>) (<span class="id"><a href="../SF/lf/Imp.html#ANum">ANum</a></span> 10))) <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#false">false</a></span> 42).<br/>
<br/>
<div class="doc">Result is: <span class="bracket"> [<span class="id">Iconst</span> 1, <span class="id">Ivar</span> <span class="id">vx</span>, <span class="id">Ibgt</span> 45, <span class="id">Ivar</span> <span class="id">vx</span>, <span class="id">Iconst</span> 10, <span class="id">Ibgt</span> 42] </span> </div>
<br/>
<span class="id">Compute</span> (<span class="id"><a href="compiler.Compiler.html#compile_bexp">compile_bexp</a></span> (<span class="id"><a href="../SF/lf/Imp.html#BNot">BNot</a></span> (<span class="id"><a href="../SF/lf/Imp.html#BAnd">BAnd</a></span> <span class="id"><a href="../SF/lf/Imp.html#BTrue">BTrue</a></span> <span class="id"><a href="../SF/lf/Imp.html#BFalse">BFalse</a></span>)) <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#true">true</a></span> 42).<br/>
<br/>
<div class="doc">Result is: <span class="bracket"> [<span class="id">Ibranch_forward</span> 42] </span> </div>
<br/>
<div class="doc">The code for a command <span class="bracket"><span class="id">c</span></span>
<ul>
<li>
 updates the variable state as prescribed by <span class="bracket"><span class="id">c</span></span>
</li>
<li>
 preserves the stack
</li>
<li>
 finishes on the next instruction immediately following the generated code.
</li>
</ul>
Again, see slides for explanations of the generated branch offsets.
</div>
<br/>
<span class="kwd">Fixpoint</span> <span class="id"><a name="compile_com">compile_com</a></span> (<span class="id">c</span>: <span class="id"><a href="../SF/lf/Imp.html#com">com</a></span>) : <span class="id"><a href="compiler.Compiler.html#code">code</a></span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id"><a href="compiler.Compiler.html#c">c</a></span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">SKIP</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span><br/>
&nbsp;&nbsp;| (<span class="id">id</span> ::= <span class="id">a</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#compile_aexp">compile_aexp</a></span> <span class="id">a</span> ++ <span class="id"><a href="compiler.Compiler.html#Isetvar">Isetvar</a></span> <span class="id">id</span> :: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span><br/>
&nbsp;&nbsp;| (<span class="id">c1</span> ;; <span class="id">c2</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#compile_com">compile_com</a></span> <span class="id">c1</span> ++ <span class="id"><a href="compiler.Compiler.html#compile_com">compile_com</a></span> <span class="id">c2</span><br/>
&nbsp;&nbsp;| <span class="id">IFB</span> <span class="id">b</span> <span class="id">THEN</span> <span class="id">ifso</span> <span class="id">ELSE</span> <span class="id">ifnot</span> <span class="id">FI</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">code_ifso</span> := <span class="id"><a href="compiler.Compiler.html#compile_com">compile_com</a></span> <span class="id">ifso</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">code_ifnot</span> := <span class="id"><a href="compiler.Compiler.html#compile_com">compile_com</a></span> <span class="id">ifnot</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#compile_bexp">compile_bexp</a></span> <span class="id">b</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#false">false</a></span> (<span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id"><a href="compiler.Compiler.html#code_ifso">code_ifso</a></span> + 1)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ <span class="id"><a href="compiler.Compiler.html#code_ifso">code_ifso</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ <span class="id"><a href="compiler.Compiler.html#Ibranch_forward">Ibranch_forward</a></span> (<span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id"><a href="compiler.Compiler.html#code_ifnot">code_ifnot</a></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:: <span class="id"><a href="compiler.Compiler.html#code_ifnot">code_ifnot</a></span><br/>
&nbsp;&nbsp;| <span class="id">WHILE</span> <span class="id">b</span> <span class="id">DO</span> <span class="id">body</span> <span class="id">END</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">code_body</span> := <span class="id"><a href="compiler.Compiler.html#compile_com">compile_com</a></span> <span class="id">body</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">code_test</span> := <span class="id"><a href="compiler.Compiler.html#compile_bexp">compile_bexp</a></span> <span class="id">b</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#false">false</a></span> (<span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id"><a href="compiler.Compiler.html#code_body">code_body</a></span> + 1) <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#code_test">code_test</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ <span class="id"><a href="compiler.Compiler.html#code_body">code_body</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ <span class="id"><a href="compiler.Compiler.html#Ibranch_backward">Ibranch_backward</a></span> (<span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id"><a href="compiler.Compiler.html#code_test">code_test</a></span> + <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id"><a href="compiler.Compiler.html#code_body">code_body</a></span> + 1)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<div class="doc">The code for a program <span class="bracket"><span class="id">p</span></span> (a command) is similar, but terminates
  cleanly on an <span class="bracket"><span class="id">Ihalt</span></span> instruction. </div>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="compile_program">compile_program</a></span> (<span class="id">p</span>: <span class="id"><a href="../SF/lf/Imp.html#com">com</a></span>) : <span class="id"><a href="compiler.Compiler.html#code">code</a></span> :=<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#compile_com">compile_com</a></span> <span class="id"><a href="compiler.Compiler.html#p">p</a></span> ++ <span class="id"><a href="compiler.Compiler.html#Ihalt">Ihalt</a></span> :: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span>.<br/>
<br/>
<div class="doc">Examples of compilation: </div>
<br/>
<span class="id">Compute</span> (<span class="id"><a href="compiler.Compiler.html#compile_program">compile_program</a></span> (<span class="id"><a href="compiler.Compiler.html#vx">vx</a></span> ::= <span class="id"><a href="../SF/lf/Imp.html#APlus">APlus</a></span> (<span class="id"><a href="../SF/lf/Imp.html#AId">AId</a></span> <span class="id"><a href="compiler.Compiler.html#vx">vx</a></span>) (<span class="id"><a href="../SF/lf/Imp.html#ANum">ANum</a></span> 1))).<br/>
<br/>
<div class="doc">Result is: <span class="bracket"> [<span class="id">Ivar</span> <span class="id">vx</span>, <span class="id">Iconst</span> 1, <span class="id">Iadd</span>, <span class="id">Isetvar</span> <span class="id">vx</span>, <span class="id">Ihalt</span>] </span> </div>
<br/>
<span class="id">Compute</span> (<span class="id"><a href="compiler.Compiler.html#compile_program">compile_program</a></span> (<span class="id">WHILE</span> <span class="id"><a href="../SF/lf/Imp.html#BTrue">BTrue</a></span> <span class="id">DO</span> <span class="id">SKIP</span> <span class="id">END</span>)).<br/>
<br/>
<div class="doc">Result is: <span class="bracket"> [<span class="id">Ibranch_backward</span> 1, <span class="id">Ihalt</span>] </span>.  That's a tight loop indeed! </div>
<br/>
<span class="id">Compute</span> (<span class="id"><a href="compiler.Compiler.html#compile_program">compile_program</a></span> (<span class="id">IFB</span> <span class="id"><a href="../SF/lf/Imp.html#BEq">BEq</a></span> (<span class="id"><a href="../SF/lf/Imp.html#AId">AId</a></span> <span class="id"><a href="compiler.Compiler.html#vx">vx</a></span>) (<span class="id"><a href="../SF/lf/Imp.html#ANum">ANum</a></span> 1) <span class="id">THEN</span> <span class="id"><a href="compiler.Compiler.html#vx">vx</a></span> ::= <span class="id"><a href="../SF/lf/Imp.html#ANum">ANum</a></span> 0 <span class="id">ELSE</span> <span class="id">SKIP</span> <span class="id">FI</span>)).<br/>
<br/>
<div class="doc">Result is: <span class="bracket"> [<span class="id">Ivar</span> <span class="id">vx</span>, <span class="id">Iconst</span> 1, <span class="id">Ibne</span> 3, <span class="id">Iconst</span> 0, <span class="id">Isetvar</span> <span class="id">vx</span>, <span class="id">Ibranch_forward</span> 0, <span class="id">Ihalt</span>] </span> </div>
<br/>
<h3> Exercise (1 star, recommended) </h3>
<div class="doc">The last example shows a slight inefficiency in the code generated for
  <span class="bracket"><span class="id">IFB</span> ... <span class="id">THEN</span> ... <span class="id">ELSE</span> <span class="id">SKIP</span> <span class="id">FI</span></span>.  How would you change <span class="bracket"><span class="id">compile_com</span></span>
  to generate better code?  Hint: ponder the following function. </div>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="smart_Ibranch_forward">smart_Ibranch_forward</a></span> (<span class="id">ofs</span>: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>) : <span class="id"><a href="compiler.Compiler.html#code">code</a></span> :=<br/>
&nbsp;&nbsp;<span class="kwd">if</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Arith.EqNat.html#beq_nat">beq_nat</a></span> <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span> 0 <span class="kwd">then</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span> <span class="kwd">else</span> <span class="id"><a href="compiler.Compiler.html#Ibranch_forward">Ibranch_forward</a></span>(<span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span>) :: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span>.<br/>
<br/>
<h1> 3. Semantic preservation </h1>
<br/>
<h2> Auxiliary results about code sequences. </h2>
<br/>
<div class="doc">To reason about the execution of compiled code, we need to consider
  code sequences <span class="bracket"><span class="id">C2</span></span> that are at position <span class="bracket"><span class="id">pc</span></span> in a bigger code
  sequence <span class="bracket"><span class="id">C</span> = <span class="id">C1</span> ++ <span class="id">C2</span> ++ <span class="id">C3</span></span>.  The following predicate
  <span class="bracket"><span class="id">codeseq_at</span> <span class="id">C</span> <span class="id">pc</span> <span class="id">C2</span></span> does just this. </div>
<br/>
<span class="kwd">Inductive</span> <span class="id"><a name="codeseq_at">codeseq_at</a></span>: <span class="id"><a href="compiler.Compiler.html#code">code</a></span> -&gt; <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span> -&gt; <span class="id"><a href="compiler.Compiler.html#code">code</a></span> -&gt; <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id"><a name="codeseq_at_intro">codeseq_at_intro</a></span>: <span class="kwd">forall</span> <span class="id">C1</span> <span class="id">C2</span> <span class="id">C3</span> <span class="id">pc</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id"><a href="compiler.Compiler.html#C1">C1</a></span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#codeseq_at">codeseq_at</a></span> (<span class="id"><a href="compiler.Compiler.html#C1">C1</a></span> ++ <span class="id"><a href="compiler.Compiler.html#C2">C2</a></span> ++ <span class="id"><a href="compiler.Compiler.html#C3">C3</a></span>) <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> <span class="id"><a href="compiler.Compiler.html#C2">C2</a></span>.<br/>
<br/>
<div class="doc">We show a number of no-brainer lemmas about <span class="bracket"><span class="id">code_at</span></span> and <span class="bracket"><span class="id">codeseq_at</span></span>,
  then populate a "hint database" so that Coq can use them automatically. </div>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="code_at_app">code_at_app</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">i</span> <span class="id">c2</span> <span class="id">c1</span> <span class="id">pc</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id"><a href="compiler.Compiler.html#c1">c1</a></span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#code_at">code_at</a></span> (<span class="id"><a href="compiler.Compiler.html#c1">c1</a></span> ++ <span class="id"><a href="compiler.Compiler.html#i">i</a></span> :: <span class="id"><a href="compiler.Compiler.html#c2">c2</a></span>) <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id"><a href="compiler.Compiler.html#i">i</a></span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof7')">Proof.</div>
<div class="proofscript" id="proof7">
&nbsp;&nbsp;<span class="tactic">induction</span> <span class="id">c1</span>; <span class="tactic">simpl</span>; <span class="tactic">intros</span>; <span class="tactic">subst</span> <span class="id">pc</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="codeseq_at_head">codeseq_at_head</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">C</span> <span class="id">pc</span> <span class="id">i</span> <span class="id">C</span>',<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#codeseq_at">codeseq_at</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> (<span class="id"><a href="compiler.Compiler.html#i">i</a></span> :: <span class="id">C</span>') -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#code_at">code_at</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id"><a href="compiler.Compiler.html#i">i</a></span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof8')">Proof.</div>
<div class="proofscript" id="proof8">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">inversion</span> <span class="id">H</span>. <span class="tactic">simpl</span>. <span class="tactic">apply</span> <span class="id"><a href="compiler.Compiler.html#code_at_app">code_at_app</a></span>. <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="codeseq_at_tail">codeseq_at_tail</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">C</span> <span class="id">pc</span> <span class="id">i</span> <span class="id">C</span>',<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#codeseq_at">codeseq_at</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> (<span class="id"><a href="compiler.Compiler.html#i">i</a></span> :: <span class="id">C</span>') -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#codeseq_at">codeseq_at</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + 1) <span class="id">C</span>'.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof9')">Proof.</div>
<div class="proofscript" id="proof9">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">inversion</span> <span class="id">H</span>. <br/>
&nbsp;&nbsp;<span class="id">change</span> (<span class="id">C1</span> ++ (<span class="id">i</span> :: <span class="id">C</span>') ++ <span class="id">C3</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">with</span> (<span class="id">C1</span> ++ (<span class="id">i</span> :: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span>) ++ <span class="id">C</span>' ++ <span class="id">C3</span>).<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> &lt;- <span class="id"><a href="http://coq.inria.fr/library/Coq.Lists.List.html#app_ass">app_ass</a></span>. <span class="id">constructor</span>. <span class="tactic">rewrite</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Lists.List.html#app_length">app_length</a></span>. <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="codeseq_at_app_left">codeseq_at_app_left</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">C</span> <span class="id">pc</span> <span class="id">C1</span> <span class="id">C2</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#codeseq_at">codeseq_at</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> (<span class="id"><a href="compiler.Compiler.html#C1">C1</a></span> ++ <span class="id"><a href="compiler.Compiler.html#C2">C2</a></span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#codeseq_at">codeseq_at</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> <span class="id"><a href="compiler.Compiler.html#C1">C1</a></span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof10')">Proof.</div>
<div class="proofscript" id="proof10">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">inversion</span> <span class="id">H</span>. <span class="tactic">rewrite</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Lists.List.html#app_ass">app_ass</a></span>. <span class="id">constructor</span>. <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="codeseq_at_app_right">codeseq_at_app_right</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">C</span> <span class="id">pc</span> <span class="id">C1</span> <span class="id">C2</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#codeseq_at">codeseq_at</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> (<span class="id"><a href="compiler.Compiler.html#C1">C1</a></span> ++ <span class="id"><a href="compiler.Compiler.html#C2">C2</a></span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#codeseq_at">codeseq_at</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id"><a href="compiler.Compiler.html#C1">C1</a></span>) <span class="id"><a href="compiler.Compiler.html#C2">C2</a></span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof11')">Proof.</div>
<div class="proofscript" id="proof11">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">inversion</span> <span class="id">H</span>. <span class="tactic">rewrite</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Lists.List.html#app_ass">app_ass</a></span>. <span class="tactic">rewrite</span> &lt;- <span class="id"><a href="http://coq.inria.fr/library/Coq.Lists.List.html#app_ass">app_ass</a></span>. <span class="id">constructor</span>. <span class="tactic">rewrite</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Lists.List.html#app_length">app_length</a></span>. <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="codeseq_at_app_right2">codeseq_at_app_right2</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">C</span> <span class="id">pc</span> <span class="id">C1</span> <span class="id">C2</span> <span class="id">C3</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#codeseq_at">codeseq_at</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> (<span class="id"><a href="compiler.Compiler.html#C1">C1</a></span> ++ <span class="id"><a href="compiler.Compiler.html#C2">C2</a></span> ++ <span class="id"><a href="compiler.Compiler.html#C3">C3</a></span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#codeseq_at">codeseq_at</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id"><a href="compiler.Compiler.html#C1">C1</a></span>) <span class="id"><a href="compiler.Compiler.html#C2">C2</a></span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof12')">Proof.</div>
<div class="proofscript" id="proof12">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">inversion</span> <span class="id">H</span>. <span class="tactic">repeat</span> <span class="tactic">rewrite</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Lists.List.html#app_ass">app_ass</a></span>. <span class="tactic">rewrite</span> &lt;- <span class="id"><a href="http://coq.inria.fr/library/Coq.Lists.List.html#app_ass">app_ass</a></span>. <span class="id">constructor</span>. <span class="tactic">rewrite</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Lists.List.html#app_length">app_length</a></span>. <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Hint</span> <span class="kwd">Resolve</span> <span class="id">codeseq_at_head</span> <span class="id">codeseq_at_tail</span> <span class="id">codeseq_at_app_left</span> <span class="id">codeseq_at_app_right</span> <span class="id">codeseq_at_app_right2</span>: <span class="id">codeseq</span>.<br/>
<br/>
<span class="kwd">Ltac</span> <span class="id">normalize</span> :=<br/>
&nbsp;&nbsp;<span class="tactic">repeat</span> <span class="tactic">rewrite</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Lists.List.html#app_length">app_length</a></span> <span class="kwd">in</span> *;<br/>
&nbsp;&nbsp;<span class="tactic">repeat</span> <span class="tactic">rewrite</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Arith.Plus.html#plus_assoc">plus_assoc</a></span> <span class="kwd">in</span> *;<br/>
&nbsp;&nbsp;<span class="tactic">repeat</span> <span class="tactic">rewrite</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Arith.Plus.html#plus_0_r">plus_0_r</a></span> <span class="kwd">in</span> *;<br/>
&nbsp;&nbsp;<span class="tactic">simpl</span> <span class="kwd">in</span> *.<br/>
<br/>
<h2> Correctness of generated code for expressions. </h2>
<br/>
<div class="doc">Remember the informal specification we gave for the code generated
  for an arithmetic expression <span class="bracket"><span class="id">a</span></span>.  It should
<ul>
<li>
 execute in sequence (no branches)
</li>
<li>
 deposit the value of <span class="bracket"><span class="id">a</span></span> at the top of the stack
</li>
<li>
 preserve the variable state.
</li>
</ul>
We now prove that the code <span class="bracket"><span class="id">compile_aexp</span> <span class="id">a</span></span> fulfills this contract.
The proof is a nice induction on the structure of <span class="bracket"><span class="id">a</span></span>. </div>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="compile_aexp_correct">compile_aexp_correct</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">C</span> <span class="id">st</span> <span class="id">a</span> <span class="id">pc</span> <span class="id">stk</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#codeseq_at">codeseq_at</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> (<span class="id"><a href="compiler.Compiler.html#compile_aexp">compile_aexp</a></span> <span class="id"><a href="compiler.Compiler.html#a">a</a></span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Sequences.html#star">star</a></span> (<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>, <span class="id"><a href="compiler.Compiler.html#st">st</a></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> (<span class="id"><a href="compiler.Compiler.html#compile_aexp">compile_aexp</a></span> <span class="id"><a href="compiler.Compiler.html#a">a</a></span>), <span class="id"><a href="../SF/lf/Imp.html#aeval">aeval</a></span> <span class="id"><a href="compiler.Compiler.html#st">st</a></span> <span class="id"><a href="compiler.Compiler.html#a">a</a></span> :: <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>, <span class="id"><a href="compiler.Compiler.html#st">st</a></span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof13')">Proof.</div>
<div class="proofscript" id="proof13">
&nbsp;&nbsp;<span class="tactic">induction</span> <span class="id">a</span>; <span class="tactic">simpl</span>; <span class="tactic">intros</span>.<br/>
<br/>
- <span class="comment">(*&nbsp;ANum&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id"><a href="compiler.Sequences.html#star_one">star_one</a></span>. <span class="tactic">apply</span> <span class="id"><a href="compiler.Compiler.html#trans_const">trans_const</a></span>. <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>. <br/>
<br/>
- <span class="comment">(*&nbsp;AId&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id"><a href="compiler.Sequences.html#star_one">star_one</a></span>. <span class="tactic">apply</span> <span class="id"><a href="compiler.Compiler.html#trans_var">trans_var</a></span>. <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>. <br/>
<br/>
- <span class="comment">(*&nbsp;APlus&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id"><a href="compiler.Sequences.html#star_trans">star_trans</a></span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">IHa1</span>. <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>. <br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id"><a href="compiler.Sequences.html#star_trans">star_trans</a></span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">IHa2</span>. <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>. <br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id"><a href="compiler.Sequences.html#star_one">star_one</a></span>. <span class="id">normalize</span>. <span class="tactic">apply</span> <span class="id"><a href="compiler.Compiler.html#trans_add">trans_add</a></span>. <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>. <br/>
<br/>
- <span class="comment">(*&nbsp;AMinus&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id"><a href="compiler.Sequences.html#star_trans">star_trans</a></span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">IHa1</span>. <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>. <br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id"><a href="compiler.Sequences.html#star_trans">star_trans</a></span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">IHa2</span>. <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>. <br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id"><a href="compiler.Sequences.html#star_one">star_one</a></span>. <span class="id">normalize</span>. <span class="tactic">apply</span> <span class="id"><a href="compiler.Compiler.html#trans_sub">trans_sub</a></span>. <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>. <br/>
<br/>
- <span class="comment">(*&nbsp;AMult&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id"><a href="compiler.Sequences.html#star_trans">star_trans</a></span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">IHa1</span>. <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>. <br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id"><a href="compiler.Sequences.html#star_trans">star_trans</a></span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">IHa2</span>. <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>. <br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id"><a href="compiler.Sequences.html#star_one">star_one</a></span>. <span class="id">normalize</span>. <span class="tactic">apply</span> <span class="id"><a href="compiler.Compiler.html#trans_mul">trans_mul</a></span>. <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>. <br/>
Qed.</div>
<br/>
<div class="doc">Here is a similar proof for the compilation of boolean expressions. </div>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="compile_bexp_correct">compile_bexp_correct</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">C</span> <span class="id">st</span> <span class="id">b</span> <span class="id">cond</span> <span class="id">ofs</span> <span class="id">pc</span> <span class="id">stk</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#codeseq_at">codeseq_at</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> (<span class="id"><a href="compiler.Compiler.html#compile_bexp">compile_bexp</a></span> <span class="id"><a href="compiler.Compiler.html#b">b</a></span> <span class="id"><a href="compiler.Compiler.html#cond">cond</a></span> <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Sequences.html#star">star</a></span> (<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>, <span class="id"><a href="compiler.Compiler.html#st">st</a></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> (<span class="id"><a href="compiler.Compiler.html#compile_bexp">compile_bexp</a></span> <span class="id"><a href="compiler.Compiler.html#b">b</a></span> <span class="id"><a href="compiler.Compiler.html#cond">cond</a></span> <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span>) + <span class="kwd">if</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Bool.Bool.html#eqb">eqb</a></span> (<span class="id"><a href="../SF/lf/Imp.html#beval">beval</a></span> <span class="id"><a href="compiler.Compiler.html#st">st</a></span> <span class="id"><a href="compiler.Compiler.html#b">b</a></span>) <span class="id"><a href="compiler.Compiler.html#cond">cond</a></span> <span class="kwd">then</span> <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span> <span class="kwd">else</span> 0, <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>, <span class="id"><a href="compiler.Compiler.html#st">st</a></span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof14')">Proof.</div>
<div class="proofscript" id="proof14">
&nbsp;&nbsp;<span class="tactic">induction</span> <span class="id">b</span>; <span class="tactic">simpl</span>; <span class="tactic">intros</span>.<br/>
<br/>
- <span class="comment">(*&nbsp;BTrue&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">cond</span>; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;+ <span class="comment">(*&nbsp;BTrue,&nbsp;true&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id"><a href="compiler.Sequences.html#star_one">star_one</a></span>. <span class="tactic">apply</span> <span class="id"><a href="compiler.Compiler.html#trans_branch_forward">trans_branch_forward</a></span> <span class="kwd">with</span> <span class="id">ofs</span>. <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;+ <span class="comment">(*&nbsp;BTrue,&nbsp;false&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">repeat</span> <span class="tactic">rewrite</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Arith.Plus.html#plus_0_r">plus_0_r</a></span>. <span class="tactic">apply</span> <span class="id"><a href="compiler.Sequences.html#star_refl">star_refl</a></span>.<br/>
&nbsp;<br/>
- <span class="comment">(*&nbsp;BFalse&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">cond</span>; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;+ <span class="comment">(*&nbsp;BFalse,&nbsp;true&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">repeat</span> <span class="tactic">rewrite</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Arith.Plus.html#plus_0_r">plus_0_r</a></span>. <span class="tactic">apply</span> <span class="id"><a href="compiler.Sequences.html#star_refl">star_refl</a></span>.<br/>
&nbsp;&nbsp;+ <span class="comment">(*&nbsp;BFalse,&nbsp;false&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id"><a href="compiler.Sequences.html#star_one">star_one</a></span>. <span class="tactic">apply</span> <span class="id"><a href="compiler.Compiler.html#trans_branch_forward">trans_branch_forward</a></span> <span class="kwd">with</span> <span class="id">ofs</span>. <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>. <span class="tactic">auto</span>.<br/>
<br/>
- <span class="comment">(*&nbsp;BEq&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id"><a href="compiler.Sequences.html#star_trans">star_trans</a></span>. <br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id"><a href="compiler.Compiler.html#compile_aexp_correct">compile_aexp_correct</a></span> <span class="kwd">with</span> (<span class="id">a</span> := <span class="id">a</span>). <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>. <br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id"><a href="compiler.Sequences.html#star_trans">star_trans</a></span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id"><a href="compiler.Compiler.html#compile_aexp_correct">compile_aexp_correct</a></span> <span class="kwd">with</span> (<span class="id">a</span> := <span class="id">a0</span>). <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>. <br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id"><a href="compiler.Sequences.html#star_one">star_one</a></span>. <span class="id">normalize</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">cond</span>.<br/>
&nbsp;&nbsp;+ <span class="comment">(*&nbsp;BEq,&nbsp;true&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id"><a href="compiler.Compiler.html#trans_beq">trans_beq</a></span> <span class="kwd">with</span> <span class="id">ofs</span>. <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id"><a href="http://coq.inria.fr/library/Coq.Arith.EqNat.html#beq_nat">beq_nat</a></span> (<span class="id"><a href="../SF/lf/Imp.html#aeval">aeval</a></span> <span class="id">st</span> <span class="id">a</span>) (<span class="id"><a href="../SF/lf/Imp.html#aeval">aeval</a></span> <span class="id">st</span> <span class="id">a0</span>)); <span class="tactic">simpl</span>; <span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;+ <span class="comment">(*&nbsp;BEq,&nbsp;false&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id"><a href="compiler.Compiler.html#trans_bne">trans_bne</a></span> <span class="kwd">with</span> <span class="id">ofs</span>. <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>. <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id"><a href="http://coq.inria.fr/library/Coq.Arith.EqNat.html#beq_nat">beq_nat</a></span> (<span class="id"><a href="../SF/lf/Imp.html#aeval">aeval</a></span> <span class="id">st</span> <span class="id">a</span>) (<span class="id"><a href="../SF/lf/Imp.html#aeval">aeval</a></span> <span class="id">st</span> <span class="id">a0</span>)); <span class="tactic">simpl</span>; <span class="tactic">omega</span>.<br/>
<br/>
- <span class="comment">(*&nbsp;BLe&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id"><a href="compiler.Sequences.html#star_trans">star_trans</a></span>. <br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id"><a href="compiler.Compiler.html#compile_aexp_correct">compile_aexp_correct</a></span> <span class="kwd">with</span> (<span class="id">a</span> := <span class="id">a</span>). <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>. <br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id"><a href="compiler.Sequences.html#star_trans">star_trans</a></span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id"><a href="compiler.Compiler.html#compile_aexp_correct">compile_aexp_correct</a></span> <span class="kwd">with</span> (<span class="id">a</span> := <span class="id">a0</span>). <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>. <br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id"><a href="compiler.Sequences.html#star_one">star_one</a></span>. <span class="id">normalize</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">cond</span>.<br/>
&nbsp;&nbsp;+ <span class="comment">(*&nbsp;BLe,&nbsp;true&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id"><a href="compiler.Compiler.html#trans_ble">trans_ble</a></span> <span class="kwd">with</span> <span class="id">ofs</span>. <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id"><a href="http://coq.inria.fr/library/Coq.Arith.Compare_dec.html#leb">leb</a></span> (<span class="id"><a href="../SF/lf/Imp.html#aeval">aeval</a></span> <span class="id">st</span> <span class="id">a</span>) (<span class="id"><a href="../SF/lf/Imp.html#aeval">aeval</a></span> <span class="id">st</span> <span class="id">a0</span>)); <span class="tactic">simpl</span>; <span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;+ <span class="comment">(*&nbsp;BLe,&nbsp;false&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id"><a href="compiler.Compiler.html#trans_bgt">trans_bgt</a></span> <span class="kwd">with</span> <span class="id">ofs</span>. <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>. <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id"><a href="http://coq.inria.fr/library/Coq.Arith.Compare_dec.html#leb">leb</a></span> (<span class="id"><a href="../SF/lf/Imp.html#aeval">aeval</a></span> <span class="id">st</span> <span class="id">a</span>) (<span class="id"><a href="../SF/lf/Imp.html#aeval">aeval</a></span> <span class="id">st</span> <span class="id">a0</span>)); <span class="tactic">simpl</span>; <span class="tactic">omega</span>.<br/>
<br/>
- <span class="comment">(*&nbsp;BNot&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="tactic">replace</span> (<span class="id"><a href="http://coq.inria.fr/library/Coq.Bool.Bool.html#eqb">eqb</a></span> (<span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#negb">negb</a></span> (<span class="id"><a href="../SF/lf/Imp.html#beval">beval</a></span> <span class="id">st</span> <span class="id">b</span>)) <span class="id">cond</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">with</span> (<span class="id"><a href="http://coq.inria.fr/library/Coq.Bool.Bool.html#eqb">eqb</a></span> (<span class="id"><a href="../SF/lf/Imp.html#beval">beval</a></span> <span class="id">st</span> <span class="id">b</span>) (<span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#negb">negb</a></span> <span class="id">cond</span>)).<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">IHb</span>; <span class="tactic">auto</span>. <br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id"><a href="../SF/lf/Imp.html#beval">beval</a></span> <span class="id">st</span> <span class="id">b</span>); <span class="tactic">destruct</span> <span class="id">cond</span>; <span class="tactic">auto</span>.<br/>
<br/>
- <span class="comment">(*&nbsp;BAnd&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="tactic">set</span> (<span class="id">code_b2</span> := <span class="id"><a href="compiler.Compiler.html#compile_bexp">compile_bexp</a></span> <span class="id">b2</span> <span class="id">cond</span> <span class="id">ofs</span>) <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;<span class="tactic">set</span> (<span class="id">ofs</span>' := <span class="kwd">if</span> <span class="id">cond</span> <span class="kwd">then</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id">code_b2</span> <span class="kwd">else</span> <span class="id">ofs</span> + <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id">code_b2</span>) <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;<span class="tactic">set</span> (<span class="id">code_b1</span> := <span class="id"><a href="compiler.Compiler.html#compile_bexp">compile_bexp</a></span> <span class="id">b1</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#false">false</a></span> <span class="id">ofs</span>') <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id"><a href="compiler.Sequences.html#star_trans">star_trans</a></span> <span class="kwd">with</span> (<span class="id">pc</span> + <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id">code_b1</span> + (<span class="kwd">if</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Bool.Bool.html#eqb">eqb</a></span> (<span class="id"><a href="../SF/lf/Imp.html#beval">beval</a></span> <span class="id">st</span> <span class="id">b1</span>) <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#false">false</a></span> <span class="kwd">then</span> <span class="id">ofs</span>' <span class="kwd">else</span> 0), <span class="id">stk</span>, <span class="id">st</span>).<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">IHb1</span>. <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">cond</span>.<br/>
&nbsp;&nbsp;+ <span class="comment">(*&nbsp;BAnd,&nbsp;true&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id"><a href="../SF/lf/Imp.html#beval">beval</a></span> <span class="id">st</span> <span class="id">b1</span>); <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;* <span class="comment">(*&nbsp;b1&nbsp;evaluates&nbsp;to&nbsp;true&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">normalize</span>. <span class="tactic">apply</span> <span class="id">IHb2</span>. <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>. <br/>
&nbsp;&nbsp;&nbsp;&nbsp;* <span class="comment">(*&nbsp;b1&nbsp;evaluates&nbsp;to&nbsp;false&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">normalize</span>. <span class="tactic">apply</span> <span class="id"><a href="compiler.Sequences.html#star_refl">star_refl</a></span>.<br/>
&nbsp;&nbsp;+ <span class="comment">(*&nbsp;BAnd,&nbsp;false&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id"><a href="../SF/lf/Imp.html#beval">beval</a></span> <span class="id">st</span> <span class="id">b1</span>); <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;* <span class="comment">(*&nbsp;b1&nbsp;evaluates&nbsp;to&nbsp;true&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">normalize</span>. <span class="tactic">apply</span> <span class="id">IHb2</span>. <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>. <br/>
&nbsp;&nbsp;&nbsp;&nbsp;* <span class="comment">(*&nbsp;b1&nbsp;evaluates&nbsp;to&nbsp;false&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">replace</span> <span class="id">ofs</span>' <span class="kwd">with</span> (<span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id">code_b2</span> + <span class="id">ofs</span>). <span class="id">normalize</span>. <span class="tactic">apply</span> <span class="id"><a href="compiler.Sequences.html#star_refl">star_refl</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">ofs</span>'; <span class="tactic">omega</span>.<br/>
Qed.</div>
<br/>
<h2> Correctness of generated code for commands: terminating case. </h2>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="compile_com_correct_terminating">compile_com_correct_terminating</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">C</span> <span class="id">st</span> <span class="id">c</span> <span class="id">st</span>',<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#c">c</a></span> / <span class="id"><a href="compiler.Compiler.html#st">st</a></span> \\ <span class="id">st</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">stk</span> <span class="id">pc</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#codeseq_at">codeseq_at</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> (<span class="id"><a href="compiler.Compiler.html#compile_com">compile_com</a></span> <span class="id"><a href="compiler.Compiler.html#c">c</a></span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Sequences.html#star">star</a></span> (<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>, <span class="id"><a href="compiler.Compiler.html#st">st</a></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> (<span class="id"><a href="compiler.Compiler.html#compile_com">compile_com</a></span> <span class="id"><a href="compiler.Compiler.html#c">c</a></span>), <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>, <span class="id">st</span>').<br/>
<div class="toggleproof" onclick="toggleDisplay('proof15')">Proof.</div>
<div class="proofscript" id="proof15">
&nbsp;&nbsp;<span class="tactic">induction</span> 1; <span class="tactic">intros</span> <span class="id">stk</span> <span class="id">pc</span> <span class="id">AT</span>.<br/>
<br/>
- <span class="comment">(*&nbsp;SKIP&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="tactic">simpl</span> <span class="kwd">in</span> *. <span class="tactic">rewrite</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Arith.Plus.html#plus_0_r">plus_0_r</a></span>. <span class="tactic">apply</span> <span class="id"><a href="compiler.Sequences.html#star_refl">star_refl</a></span>.<br/>
<br/>
- <span class="comment">(*&nbsp;:=&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="tactic">simpl</span> <span class="kwd">in</span> *. <span class="tactic">subst</span> <span class="id">n</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id"><a href="compiler.Sequences.html#star_trans">star_trans</a></span>. <span class="tactic">apply</span> <span class="id"><a href="compiler.Compiler.html#compile_aexp_correct">compile_aexp_correct</a></span>. <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id"><a href="compiler.Sequences.html#star_one">star_one</a></span>. <span class="id">normalize</span>. <span class="tactic">apply</span> <span class="id"><a href="compiler.Compiler.html#trans_setvar">trans_setvar</a></span>. <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>. <br/>
<br/>
- <span class="comment">(*&nbsp;sequence&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="tactic">simpl</span> <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id"><a href="compiler.Sequences.html#star_trans">star_trans</a></span>. <span class="tactic">apply</span> <span class="id">IHceval1</span>. <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>. <br/>
&nbsp;&nbsp;<span class="id">normalize</span>. <span class="tactic">apply</span> <span class="id">IHceval2</span>. <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>. <br/>
<br/>
- <span class="comment">(*&nbsp;if&nbsp;true&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="tactic">simpl</span> <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;<span class="tactic">set</span> (<span class="id">code1</span> := <span class="id"><a href="compiler.Compiler.html#compile_com">compile_com</a></span> <span class="id">c1</span>) <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;<span class="tactic">set</span> (<span class="id">codeb</span> := <span class="id"><a href="compiler.Compiler.html#compile_bexp">compile_bexp</a></span> <span class="id">b</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#false">false</a></span> (<span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id">code1</span> + 1)) <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;<span class="tactic">set</span> (<span class="id">code2</span> := <span class="id"><a href="compiler.Compiler.html#compile_com">compile_com</a></span> <span class="id">c2</span>) <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id"><a href="compiler.Sequences.html#star_trans">star_trans</a></span>. <br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id"><a href="compiler.Compiler.html#compile_bexp_correct">compile_bexp_correct</a></span> <span class="kwd">with</span> (<span class="id">b</span> := <span class="id">b</span>) (<span class="id">cond</span> := <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#false">false</a></span>) (<span class="id">ofs</span> := <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id">code1</span> + 1).<br/>
&nbsp;&nbsp;<span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>. <br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H</span>. <span class="tactic">simpl</span>. <span class="tactic">rewrite</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Arith.Plus.html#plus_0_r">plus_0_r</a></span>. <span class="id">fold</span> <span class="id">codeb</span>. <span class="id">normalize</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id"><a href="compiler.Sequences.html#star_trans">star_trans</a></span>. <span class="tactic">apply</span> <span class="id">IHceval</span>. <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>. <br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id"><a href="compiler.Sequences.html#star_one">star_one</a></span>. <span class="tactic">eapply</span> <span class="id"><a href="compiler.Compiler.html#trans_branch_forward">trans_branch_forward</a></span>. <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>. <span class="tactic">omega</span>.<br/>
<br/>
- <span class="comment">(*&nbsp;if&nbsp;false&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="tactic">simpl</span> <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;<span class="tactic">set</span> (<span class="id">code1</span> := <span class="id"><a href="compiler.Compiler.html#compile_com">compile_com</a></span> <span class="id">c1</span>) <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;<span class="tactic">set</span> (<span class="id">codeb</span> := <span class="id"><a href="compiler.Compiler.html#compile_bexp">compile_bexp</a></span> <span class="id">b</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#false">false</a></span> (<span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id">code1</span> + 1)) <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;<span class="tactic">set</span> (<span class="id">code2</span> := <span class="id"><a href="compiler.Compiler.html#compile_com">compile_com</a></span> <span class="id">c2</span>) <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id"><a href="compiler.Sequences.html#star_trans">star_trans</a></span>. <br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id"><a href="compiler.Compiler.html#compile_bexp_correct">compile_bexp_correct</a></span> <span class="kwd">with</span> (<span class="id">b</span> := <span class="id">b</span>) (<span class="id">cond</span> := <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#false">false</a></span>) (<span class="id">ofs</span> := <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id">code1</span> + 1).<br/>
&nbsp;&nbsp;<span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>. <br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H</span>. <span class="tactic">simpl</span>. <span class="id">fold</span> <span class="id">codeb</span>. <span class="id">normalize</span>.<br/>
&nbsp;&nbsp;<span class="tactic">replace</span> (<span class="id">pc</span> + <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id">codeb</span> + <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id">code1</span> + <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#S">S</a></span>(<span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id">code2</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">with</span> (<span class="id">pc</span> + <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id">codeb</span> + <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id">code1</span> + 1 + <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id">code2</span>).<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">IHceval</span>. <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>. <span class="tactic">omega</span>. <br/>
<br/>
- <span class="comment">(*&nbsp;while&nbsp;false&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="tactic">simpl</span> <span class="kwd">in</span> *. <br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id"><a href="compiler.Sequences.html#star_trans">star_trans</a></span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id"><a href="compiler.Compiler.html#compile_bexp_correct">compile_bexp_correct</a></span> <span class="kwd">with</span> (<span class="id">b</span> := <span class="id">b</span>) (<span class="id">cond</span> := <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#false">false</a></span>) (<span class="id">ofs</span> := <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> (<span class="id"><a href="compiler.Compiler.html#compile_com">compile_com</a></span> <span class="id">c</span>) + 1). <br/>
&nbsp;&nbsp;<span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H</span>. <span class="tactic">simpl</span>. <span class="id">normalize</span>. <span class="tactic">apply</span> <span class="id"><a href="compiler.Sequences.html#star_refl">star_refl</a></span>.<br/>
<br/>
- <span class="comment">(*&nbsp;while&nbsp;true&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id"><a href="compiler.Sequences.html#star_trans">star_trans</a></span> <span class="kwd">with</span> (<span class="id">pc</span>, <span class="id">stk</span>, <span class="id">st</span>').<br/>
&nbsp;&nbsp;<span class="tactic">simpl</span> <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id"><a href="compiler.Sequences.html#star_trans">star_trans</a></span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id"><a href="compiler.Compiler.html#compile_bexp_correct">compile_bexp_correct</a></span> <span class="kwd">with</span> (<span class="id">b</span> := <span class="id">b</span>) (<span class="id">cond</span> := <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#false">false</a></span>) (<span class="id">ofs</span> := <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> (<span class="id"><a href="compiler.Compiler.html#compile_com">compile_com</a></span> <span class="id">c</span>) + 1). <br/>
&nbsp;&nbsp;<span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>. <br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H</span>; <span class="tactic">simpl</span>. <span class="tactic">rewrite</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Arith.Plus.html#plus_0_r">plus_0_r</a></span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id"><a href="compiler.Sequences.html#star_trans">star_trans</a></span>. <span class="tactic">apply</span> <span class="id">IHceval1</span>. <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>. <br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id"><a href="compiler.Sequences.html#star_one">star_one</a></span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id"><a href="compiler.Compiler.html#trans_branch_backward">trans_branch_backward</a></span>. <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>. <span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">IHceval2</span>. <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Theorem</span> <span class="id"><a name="compile_program_correct_terminating">compile_program_correct_terminating</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">c</span> <span class="id">st</span> <span class="id">st</span>',<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#c">c</a></span> / <span class="id"><a href="compiler.Compiler.html#st">st</a></span> \\ <span class="id">st</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#mach_terminates">mach_terminates</a></span> (<span class="id"><a href="compiler.Compiler.html#compile_program">compile_program</a></span> <span class="id"><a href="compiler.Compiler.html#c">c</a></span>) <span class="id"><a href="compiler.Compiler.html#st">st</a></span> <span class="id">st</span>'.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof16')">Proof.</div>
<div class="proofscript" id="proof16">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">unfold</span> <span class="id"><a href="compiler.Compiler.html#compile_program">compile_program</a></span>. <span class="tactic">red</span>.<br/>
&nbsp;&nbsp;<span class="id">exists</span> (<span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> (<span class="id"><a href="compiler.Compiler.html#compile_com">compile_com</a></span> <span class="id">c</span>)); <span class="tactic">split</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id"><a href="compiler.Compiler.html#code_at_app">code_at_app</a></span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id"><a href="compiler.Compiler.html#compile_com_correct_terminating">compile_com_correct_terminating</a></span> <span class="kwd">with</span> (<span class="id">pc</span> := 0). <span class="tactic">auto</span>. <br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id"><a href="compiler.Compiler.html#codeseq_at_intro">codeseq_at_intro</a></span> <span class="kwd">with</span> (<span class="id">C1</span> := <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span>). <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<br/>
<h3> Exercise (2 stars, recommended) </h3>
<div class="doc">The previous exercise in this chapter suggested to use
  <span class="bracket"><span class="id">smart_Ibranch_forward</span></span> to avoid generating useless "branch forward"
  instructions when compiling <span class="bracket"><span class="id">IFB</span> ... <span class="id">THEN</span> ... <span class="id">ELSE</span> <span class="id">SKIP</span> <span class="id">FI</span></span> commands.
  Once you have modified <span class="bracket"><span class="id">compile_com</span></span> to use <span class="bracket"><span class="id">smart_Ibranch_forward</span></span>,
  adapt the proof of <span class="bracket"><span class="id">compile_com_correct_terminating</span></span> accordingly.
  The following lemma will come handy: </div>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="trans_smart_branch_forward">trans_smart_branch_forward</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">C</span> <span class="id">ofs</span> <span class="id">pc</span> <span class="id">stk</span> <span class="id">st</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#codeseq_at">codeseq_at</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> (<span class="id"><a href="compiler.Compiler.html#smart_Ibranch_forward">smart_Ibranch_forward</a></span> <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Sequences.html#star">star</a></span> (<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span>) (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>, <span class="id"><a href="compiler.Compiler.html#st">st</a></span>) (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> (<span class="id"><a href="compiler.Compiler.html#smart_Ibranch_forward">smart_Ibranch_forward</a></span> <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span>) + <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span>, <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>, <span class="id"><a href="compiler.Compiler.html#st">st</a></span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof17')">Proof.</div>
<div class="proofscript" id="proof17">
&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id"><a href="compiler.Compiler.html#smart_Ibranch_forward">smart_Ibranch_forward</a></span>; <span class="tactic">intros</span>.<br/>
&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span>Admitted.</div>
<br/>
<h3> Exercise (3 stars, optional) </h3>
<div class="doc">The manufacturer of our virtual machine offers a cheaper variant
  that lacks the <span class="bracket"><span class="id">Ibge</span></span> and <span class="bracket"><span class="id">Ibgt</span></span> conditional branches.  The only
  conditional branches available are <span class="bracket"><span class="id">Ibeq</span></span> (branch if equal) and 
  <span class="bracket"><span class="id">Ibne</span></span> (branch if different).  Modify the definition of <span class="bracket"><span class="id">compile_bexp</span></span> and
  its correctness proof to target this cheaper virtual machine.
  Hint: study Coq's definition of subtraction between natural numbers
  (do <span class="bracket"><span class="kwd">Print</span> <span class="id">Nat.sub</span></span>). </div>
<br/>
<h2> Correctness of generated code for commands: general case. </h2>
<br/>
<div class="doc">We would like to strengthen the correctness result above so that it
  is not restricted to terminating source programs, but also applies to
  source program that diverge.  To this end, we abandon the big-step
  semantics for commands and switch to the small-step semantics with continuations.
  We then show a simulation theorem, establishing that every transition
  of the small-step semantics in the source program is simulated (in a sense
  to be made precise below) by zero, one or several transitions of the
  machine executing the compiled code for the source program. </div>
<br/>
<div class="doc">Our first task is to relate configurations <span class="bracket">(<span class="id">c</span>, <span class="id">k</span>, <span class="id">st</span>)</span> of the small-step
  semantics with configurations <span class="bracket">(<span class="id">C</span>, <span class="id">pc</span>, <span class="id">stk</span>, <span class="id">st</span>)</span> of the machine.
  We already know how to relate a command <span class="bracket"><span class="id">c</span></span> with the machine code,
  using the <span class="bracket"><span class="id">codeseq_at</span></span> predicate.  What needs to be defined is a relation
  between the continuation <span class="bracket"><span class="id">k</span></span> and the machine code.
  Intuitively, when the machine finishes executing the generated code for
  command <span class="bracket"><span class="id">c</span></span>, that is, when it reaches the program point
  <span class="bracket"><span class="id">pc</span> + <span class="id">length</span>(<span class="id">compile_com</span> <span class="id">c</span>)</span>, the machine should continue by executing
  instructions that perform the pending computations described by
  continuation <span class="bracket"><span class="id">k</span></span>, then reach an <span class="bracket"><span class="id">Ihalt</span></span> instruction to stop cleanly.
  We formalize this intution by the following inductive predicate
  <span class="bracket"><span class="id">compile_cont</span> <span class="id">C</span> <span class="id">k</span> <span class="id">pc</span></span>, which states that, starting at program point <span class="bracket"><span class="id">pc</span></span>,
  there are instructions that perform the computations described in <span class="bracket"><span class="id">k</span></span>
  and reach an <span class="bracket"><span class="id">Ihalt</span></span> instruction. </div>
<br/>
<span class="kwd">Inductive</span> <span class="id"><a name="compile_cont">compile_cont</a></span> (<span class="id">C</span>: <span class="id"><a href="compiler.Compiler.html#code">code</a></span>): <span class="id"><a href="compiler.Semantics.html#cont">cont</a></span> -&gt; <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span> -&gt; <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id"><a name="ccont_stop">ccont_stop</a></span>: <span class="kwd">forall</span> <span class="id">pc</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#code_at">code_at</a></span> <span class="id">C</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id"><a href="compiler.Compiler.html#Ihalt">Ihalt</a></span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#compile_cont">compile_cont</a></span> <span class="id">C</span> <span class="id"><a href="compiler.Semantics.html#Kstop">Kstop</a></span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span><br/>
&nbsp;&nbsp;| <span class="id"><a name="ccont_seq">ccont_seq</a></span>: <span class="kwd">forall</span> <span class="id">c</span> <span class="id">k</span> <span class="id">pc</span> <span class="id">pc</span>',<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#codeseq_at">codeseq_at</a></span> <span class="id">C</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> (<span class="id"><a href="compiler.Compiler.html#compile_com">compile_com</a></span> <span class="id"><a href="compiler.Compiler.html#c">c</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">pc</span>' = <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> (<span class="id"><a href="compiler.Compiler.html#compile_com">compile_com</a></span> <span class="id"><a href="compiler.Compiler.html#c">c</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#compile_cont">compile_cont</a></span> <span class="id">C</span> <span class="id"><a href="compiler.Compiler.html#k">k</a></span> <span class="id">pc</span>' -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#compile_cont">compile_cont</a></span> <span class="id">C</span> (<span class="id"><a href="compiler.Semantics.html#Kseq">Kseq</a></span> <span class="id"><a href="compiler.Compiler.html#c">c</a></span> <span class="id"><a href="compiler.Compiler.html#k">k</a></span>) <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span><br/>
&nbsp;&nbsp;| <span class="id"><a name="ccont_while">ccont_while</a></span>: <span class="kwd">forall</span> <span class="id">b</span> <span class="id">c</span> <span class="id">k</span> <span class="id">pc</span> <span class="id">ofs</span> <span class="id">pc</span>' <span class="id">pc</span>'',<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#code_at">code_at</a></span> <span class="id">C</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span>(<span class="id"><a href="compiler.Compiler.html#Ibranch_backward">Ibranch_backward</a></span> <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">pc</span>' = <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + 1 - <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#codeseq_at">codeseq_at</a></span> <span class="id">C</span> <span class="id">pc</span>' (<span class="id"><a href="compiler.Compiler.html#compile_com">compile_com</a></span> (<span class="id">WHILE</span> <span class="id"><a href="compiler.Compiler.html#b">b</a></span> <span class="id">DO</span> <span class="id"><a href="compiler.Compiler.html#c">c</a></span> <span class="id">END</span>)) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">pc</span>'' = <span class="id">pc</span>' + <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> (<span class="id"><a href="compiler.Compiler.html#compile_com">compile_com</a></span> (<span class="id">WHILE</span> <span class="id"><a href="compiler.Compiler.html#b">b</a></span> <span class="id">DO</span> <span class="id"><a href="compiler.Compiler.html#c">c</a></span> <span class="id">END</span>)) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#compile_cont">compile_cont</a></span> <span class="id">C</span> <span class="id"><a href="compiler.Compiler.html#k">k</a></span> <span class="id">pc</span>'' -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#compile_cont">compile_cont</a></span> <span class="id">C</span> (<span class="id"><a href="compiler.Semantics.html#Kwhile">Kwhile</a></span> <span class="id"><a href="compiler.Compiler.html#b">b</a></span> <span class="id"><a href="compiler.Compiler.html#c">c</a></span> <span class="id"><a href="compiler.Compiler.html#k">k</a></span>) <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span><br/>
&nbsp;&nbsp;| <span class="id"><a name="ccont_branch">ccont_branch</a></span>: <span class="kwd">forall</span> <span class="id">ofs</span> <span class="id">k</span> <span class="id">pc</span> <span class="id">pc</span>',<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#code_at">code_at</a></span> <span class="id">C</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span>(<span class="id"><a href="compiler.Compiler.html#Ibranch_forward">Ibranch_forward</a></span> <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">pc</span>' = <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + 1 + <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#compile_cont">compile_cont</a></span> <span class="id">C</span> <span class="id"><a href="compiler.Compiler.html#k">k</a></span> <span class="id">pc</span>' -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#compile_cont">compile_cont</a></span> <span class="id">C</span> <span class="id"><a href="compiler.Compiler.html#k">k</a></span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>.<br/>
<br/>
<div class="doc">Then, a configuration <span class="bracket">(<span class="id">c</span>,<span class="id">k</span>,<span class="id">st</span>)</span> of the small-step semantics matches
  a configuration <span class="bracket">(<span class="id">C</span>, <span class="id">pc</span>, <span class="id">stk</span>, <span class="id">st</span>')</span> of the machine if the following conditions hold:
<ul>
<li>
 The memory states are identical: <span class="bracket"><span class="id">st</span>' = <span class="id">st</span></span>.
</li>
<li>
 The machine stack is empty: <span class="bracket"><span class="id">stk</span> = <span class="id">nil</span></span>.
</li>
<li>
 The machine code at point <span class="bracket"><span class="id">pc</span></span> is the compiled code for <span class="bracket"><span class="id">c</span></span>:
  <span class="bracket"><span class="id">codeseq_at</span> <span class="id">C</span> <span class="id">pc</span> (<span class="id">compile_com</span> <span class="id">c</span>)</span>.
</li>
<li>
 The machine code at point <span class="bracket"><span class="id">pc</span> + <span class="id">length</span> (<span class="id">compile_com</span> <span class="id">c</span>)</span> matches continuation
  <span class="bracket"><span class="id">k</span></span>, in the sense of <span class="bracket"><span class="id">compile_cont</span></span> above.
</li>
</ul>
</div>
<br/>
<span class="kwd">Inductive</span> <span class="id"><a name="match_config">match_config</a></span> (<span class="id">C</span>: <span class="id"><a href="compiler.Compiler.html#code">code</a></span>): <span class="id"><a href="../SF/lf/Imp.html#com">com</a></span> * <span class="id"><a href="compiler.Semantics.html#cont">cont</a></span> * <span class="id"><a href="../SF/lf/Imp.html#state">state</a></span> -&gt; <span class="id"><a href="compiler.Compiler.html#configuration">configuration</a></span> -&gt; <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id"><a name="match_config_intro">match_config_intro</a></span>: <span class="kwd">forall</span> <span class="id">c</span> <span class="id">k</span> <span class="id">st</span> <span class="id">pc</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#codeseq_at">codeseq_at</a></span> <span class="id">C</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> (<span class="id"><a href="compiler.Compiler.html#compile_com">compile_com</a></span> <span class="id"><a href="compiler.Compiler.html#c">c</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#compile_cont">compile_cont</a></span> <span class="id">C</span> <span class="id"><a href="compiler.Compiler.html#k">k</a></span> (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> (<span class="id"><a href="compiler.Compiler.html#compile_com">compile_com</a></span> <span class="id"><a href="compiler.Compiler.html#c">c</a></span>)) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#match_config">match_config</a></span> <span class="id">C</span> (<span class="id"><a href="compiler.Compiler.html#c">c</a></span>, <span class="id"><a href="compiler.Compiler.html#k">k</a></span>, <span class="id"><a href="compiler.Compiler.html#st">st</a></span>) (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span>, <span class="id"><a href="compiler.Compiler.html#st">st</a></span>).<br/>
<br/>
<div class="doc">We are now ready to prove the expected simulation property.  Our first
  attempt is to show a diagram of the following form:
<pre>
                      match_config
     c / k / st  ----------------------- machstate
       |                                   |
       |                                   | *
       |                                   |
       v                                   v
    c' / k' / st' ----------------------- machstate'
                      match_config </pre>
Hypotheses:
<ul>
<li>
 Left: one transition in the small-step continuation semantics for Imp.
</li>
<li>
 Top: the <span class="bracket"><span class="id">match_config</span></span> invariant.
</li>
</ul>
Conclusions:
<ul>
<li>
 Bottom: the <span class="bracket"><span class="id">match_config</span></span> invariant, which must be preserved.
</li>
<li>
 Right: zero, one or several transitions of the virtual machine.
</li>
</ul>
Why "zero, one, or several"?  Some transitions of the Imp semantics involve
the evaluation of a complex expression, which requires several machine instructions
to be executed.  However, other transitions of the Imp semantics, such as
the <span class="bracket"><span class="id">KS_Seq</span></span> and <span class="bracket"><span class="id">KS_SkipSeq</span></span> rules, just change the focus on a sub-command,
but the machine need not execute any instruction to reflect this change of focus.
</div>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="simulation_step_first_attempt">simulation_step_first_attempt</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">C</span> <span class="id">impstate1</span> <span class="id">impstate2</span> <span class="id">machstate1</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Semantics.html#kstep">kstep</a></span> <span class="id"><a href="compiler.Compiler.html#impstate1">impstate1</a></span> <span class="id"><a href="compiler.Compiler.html#impstate2">impstate2</a></span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#match_config">match_config</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id"><a href="compiler.Compiler.html#impstate1">impstate1</a></span> <span class="id"><a href="compiler.Compiler.html#machstate1">machstate1</a></span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">machstate2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Sequences.html#star">star</a></span> (<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span>) <span class="id"><a href="compiler.Compiler.html#machstate1">machstate1</a></span> <span class="id"><a href="compiler.Compiler.html#machstate2">machstate2</a></span><br/>
&nbsp;&nbsp;&nbsp;/\ <span class="id"><a href="compiler.Compiler.html#match_config">match_config</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id"><a href="compiler.Compiler.html#impstate2">impstate2</a></span> <span class="id"><a href="compiler.Compiler.html#machstate2">machstate2</a></span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof18')">Proof.</div>
<div class="proofscript" id="proof18">
Abort.</div>
<br/>
<div class="doc">This simulation lemma is true and can be proved, but it is too weak to
  imply the preservation of diverging behaviors: we have an issue with
  "infinite stuttering".  Imagine a situation where the source program
  takes infinitely many transitions, but every such transition is matched
  by zero transitions of the virtual machine.  In this case, the source
  program diverges, but the machine code can do anything: it can diverge,
  as expected, but it can also terminate cleanly or go wrong. 
  The simulation lemma above is too weak to rule out the last two cases!
  We therefore need a stronger simulation result that rules out stuttering.
  To this end, we are going to require that if a source transition is
  matched by zero machine transition, some nonnegative measure of the source
  configuration must strictly decrease.  This ensures that only a finite
  number of stuttering steps can be taken before the machine actually does
  a transition.  Here is the revised simulation diagram:
 
<pre>
                      match_config
     c / k / st  ----------------------- machconfig
       |                                   |
       |                                   | + or ( * and |c',k'| &lt; |c,k} )
       |                                   |
       v                                   v
    c' / k' / st' ----------------------- machconfig'
                      match_config </pre>
Note the stronger conclusion on the right:
<ul>
<li>
 either the virtual machine does one or several transitions
</li>
<li>
 or it does zero, one or several transitions, but the size of the <span class="bracket"><span class="id">c</span>,<span class="id">k</span></span>
  pair decreases strictly.
</li>
</ul>
It would be equivalent to state:
<ul>
<li>
 either the virtual machine does one or several transitions
</li>
<li>
 or it does zero transitions, but the size of the <span class="bracket"><span class="id">c</span>,<span class="id">k</span></span> pair decreases strictly.
</li>
</ul>
However, the formulation above, with the "star" case, is often more convenient.
</div>
<br/>
<div class="doc">Finding an appropriate "anti-stuttering" measure is a bit of a black art.
After trial and error, we find that the following measure works.  It is
the sum of the sizes of the command <span class="bracket"><span class="id">c</span></span> under focus and all the commands
appearing in the continuation <span class="bracket"><span class="id">k</span></span>. </div>
<br/>
<span class="kwd">Fixpoint</span> <span class="id"><a name="com_size">com_size</a></span> (<span class="id">c</span>: <span class="id"><a href="../SF/lf/Imp.html#com">com</a></span>) : <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id"><a href="compiler.Compiler.html#c">c</a></span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">SKIP</span> =&gt; 1<br/>
&nbsp;&nbsp;| <span class="id">x</span> ::= <span class="id">a</span> =&gt; 1<br/>
&nbsp;&nbsp;| (<span class="id">c1</span> ;; <span class="id">c2</span>) =&gt; <span class="id"><a href="compiler.Compiler.html#com_size">com_size</a></span> <span class="id">c1</span> + <span class="id"><a href="compiler.Compiler.html#com_size">com_size</a></span> <span class="id">c2</span> + 1<br/>
&nbsp;&nbsp;| <span class="id">IFB</span> <span class="id">b</span> <span class="id">THEN</span> <span class="id">ifso</span> <span class="id">ELSE</span> <span class="id">ifnot</span> <span class="id">FI</span> =&gt; <span class="id"><a href="compiler.Compiler.html#com_size">com_size</a></span> <span class="id">ifso</span> + <span class="id"><a href="compiler.Compiler.html#com_size">com_size</a></span> <span class="id">ifnot</span> + 1<br/>
&nbsp;&nbsp;| <span class="id">WHILE</span> <span class="id">b</span> <span class="id">DO</span> <span class="id">c1</span> <span class="id">END</span> =&gt; <span class="id"><a href="compiler.Compiler.html#com_size">com_size</a></span> <span class="id">c1</span> + 1<br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Remark</span> <span class="id"><a name="com_size_nonzero">com_size_nonzero</a></span>: <span class="kwd">forall</span> <span class="id">c</span>, <span class="id"><a href="compiler.Compiler.html#com_size">com_size</a></span> <span class="id"><a href="compiler.Compiler.html#c">c</a></span> &gt; 0. <br/>
<div class="toggleproof" onclick="toggleDisplay('proof19')">Proof.</div>
<div class="proofscript" id="proof19">
&nbsp;&nbsp;<span class="tactic">induction</span> <span class="id">c</span>; <span class="tactic">simpl</span>; <span class="tactic">omega</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Fixpoint</span> <span class="id"><a name="cont_size">cont_size</a></span> (<span class="id">k</span>: <span class="id"><a href="compiler.Semantics.html#cont">cont</a></span>) : <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id"><a href="compiler.Compiler.html#k">k</a></span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id"><a href="compiler.Semantics.html#Kstop">Kstop</a></span> =&gt; 0<br/>
&nbsp;&nbsp;| <span class="id"><a href="compiler.Semantics.html#Kseq">Kseq</a></span> <span class="id">c</span> <span class="id">k</span>' =&gt; <span class="id"><a href="compiler.Compiler.html#com_size">com_size</a></span> <span class="id">c</span> + <span class="id"><a href="compiler.Compiler.html#cont_size">cont_size</a></span> <span class="id">k</span>'<br/>
&nbsp;&nbsp;| <span class="id"><a href="compiler.Semantics.html#Kwhile">Kwhile</a></span> <span class="id">b</span> <span class="id">c</span> <span class="id">k</span>' =&gt; <span class="id"><a href="compiler.Compiler.html#cont_size">cont_size</a></span> <span class="id">k</span>'<br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="kwd">measure</span> (<span class="id">impconf</span>: <span class="id"><a href="../SF/lf/Imp.html#com">com</a></span> * <span class="id"><a href="compiler.Semantics.html#cont">cont</a></span> * <span class="id"><a href="../SF/lf/Imp.html#state">state</a></span>) : <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id"><a href="compiler.Compiler.html#impconf">impconf</a></span> <span class="kwd">with</span> (<span class="id">c</span>, <span class="id">k</span>, <span class="id">m</span>) =&gt; <span class="id"><a href="compiler.Compiler.html#com_size">com_size</a></span> <span class="id">c</span> + <span class="id"><a href="compiler.Compiler.html#cont_size">cont_size</a></span> <span class="id">k</span> <span class="kwd">end</span>.<br/>
<br/>
<div class="doc">A few technical lemmas to help with the simulation proof. </div>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="compile_cont_Kstop_inv">compile_cont_Kstop_inv</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">C</span> <span class="id">pc</span> <span class="id">m</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#compile_cont">compile_cont</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id"><a href="compiler.Semantics.html#Kstop">Kstop</a></span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">pc</span>',<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Sequences.html#star">star</a></span> (<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span>) (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span>, <span class="id"><a href="compiler.Compiler.html#m">m</a></span>) (<span class="id">pc</span>', <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span>, <span class="id"><a href="compiler.Compiler.html#m">m</a></span>)<br/>
&nbsp;&nbsp;/\ <span class="id"><a href="compiler.Compiler.html#code_at">code_at</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id">pc</span>' = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id"><a href="compiler.Compiler.html#Ihalt">Ihalt</a></span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof20')">Proof.</div>
<div class="proofscript" id="proof20">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">dependent</span> <span class="tactic">induction</span> <span class="id">H</span>. <br/>
- <span class="id">exists</span> <span class="id">pc</span>; <span class="tactic">split</span>. <span class="tactic">apply</span> <span class="id"><a href="compiler.Sequences.html#star_refl">star_refl</a></span>. <span class="tactic">auto</span>.<br/>
- <span class="tactic">destruct</span> <span class="id">IHcompile_cont</span> <span class="kwd">as</span> [<span class="id">pc</span>'' [<span class="id">A</span> <span class="id">B</span>]]; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">pc</span>''; <span class="tactic">split</span>; <span class="tactic">auto</span>. <span class="tactic">eapply</span> <span class="id"><a href="compiler.Sequences.html#star_step">star_step</a></span>; <span class="tactic">eauto</span>. <span class="tactic">eapply</span> <span class="id"><a href="compiler.Compiler.html#trans_branch_forward">trans_branch_forward</a></span>; <span class="tactic">eauto</span>. <br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="compile_cont_Kseq_inv">compile_cont_Kseq_inv</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">C</span> <span class="id">c</span> <span class="id">k</span> <span class="id">pc</span> <span class="id">m</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#compile_cont">compile_cont</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> (<span class="id"><a href="compiler.Semantics.html#Kseq">Kseq</a></span> <span class="id"><a href="compiler.Compiler.html#c">c</a></span> <span class="id"><a href="compiler.Compiler.html#k">k</a></span>) <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">pc</span>',<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Sequences.html#star">star</a></span> (<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span>) (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span>, <span class="id"><a href="compiler.Compiler.html#m">m</a></span>) (<span class="id">pc</span>', <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span>, <span class="id"><a href="compiler.Compiler.html#m">m</a></span>)<br/>
&nbsp;&nbsp;/\ <span class="id"><a href="compiler.Compiler.html#codeseq_at">codeseq_at</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id">pc</span>' (<span class="id"><a href="compiler.Compiler.html#compile_com">compile_com</a></span> <span class="id"><a href="compiler.Compiler.html#c">c</a></span>)<br/>
&nbsp;&nbsp;/\ <span class="id"><a href="compiler.Compiler.html#compile_cont">compile_cont</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id"><a href="compiler.Compiler.html#k">k</a></span> (<span class="id">pc</span>' + <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span>(<span class="id"><a href="compiler.Compiler.html#compile_com">compile_com</a></span> <span class="id"><a href="compiler.Compiler.html#c">c</a></span>)).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof21')">Proof.</div>
<div class="proofscript" id="proof21">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">dependent</span> <span class="tactic">induction</span> <span class="id">H</span>. <br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">pc</span>; <span class="tactic">split</span>. <span class="tactic">apply</span> <span class="id"><a href="compiler.Sequences.html#star_refl">star_refl</a></span>. <span class="tactic">split</span>; <span class="tactic">congruence</span>. <br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">IHcompile_cont</span> <span class="id">_</span> <span class="id">_</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Logic.html#eq_refl">eq_refl</a></span>) <span class="kwd">as</span> [<span class="id">pc</span>'' [<span class="id">A</span> [<span class="id">B</span> <span class="id">D</span>]]].<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">pc</span>''; <span class="tactic">split</span>; <span class="tactic">auto</span>. <span class="tactic">eapply</span> <span class="id"><a href="compiler.Sequences.html#star_step">star_step</a></span>; <span class="tactic">eauto</span>. <span class="tactic">eapply</span> <span class="id"><a href="compiler.Compiler.html#trans_branch_forward">trans_branch_forward</a></span>; <span class="tactic">eauto</span>. <br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="compile_cont_Kwhile_inv">compile_cont_Kwhile_inv</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">C</span> <span class="id">b</span> <span class="id">c</span> <span class="id">k</span> <span class="id">pc</span> <span class="id">m</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#compile_cont">compile_cont</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> (<span class="id"><a href="compiler.Semantics.html#Kwhile">Kwhile</a></span> <span class="id"><a href="compiler.Compiler.html#b">b</a></span> <span class="id"><a href="compiler.Compiler.html#c">c</a></span> <span class="id"><a href="compiler.Compiler.html#k">k</a></span>) <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">pc</span>',<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Sequences.html#plus">plus</a></span> (<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span>) (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span>, <span class="id"><a href="compiler.Compiler.html#m">m</a></span>) (<span class="id">pc</span>', <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span>, <span class="id"><a href="compiler.Compiler.html#m">m</a></span>)<br/>
&nbsp;&nbsp;/\ <span class="id"><a href="compiler.Compiler.html#codeseq_at">codeseq_at</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id">pc</span>' (<span class="id"><a href="compiler.Compiler.html#compile_com">compile_com</a></span> (<span class="id">WHILE</span> <span class="id"><a href="compiler.Compiler.html#b">b</a></span> <span class="id">DO</span> <span class="id"><a href="compiler.Compiler.html#c">c</a></span> <span class="id">END</span>))<br/>
&nbsp;&nbsp;/\ <span class="id"><a href="compiler.Compiler.html#compile_cont">compile_cont</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id"><a href="compiler.Compiler.html#k">k</a></span> (<span class="id">pc</span>' + <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span>(<span class="id"><a href="compiler.Compiler.html#compile_com">compile_com</a></span> (<span class="id">WHILE</span> <span class="id"><a href="compiler.Compiler.html#b">b</a></span> <span class="id">DO</span> <span class="id"><a href="compiler.Compiler.html#c">c</a></span> <span class="id">END</span>))).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof22')">Proof.</div>
<div class="proofscript" id="proof22">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">dependent</span> <span class="tactic">induction</span> <span class="id">H</span>.<br/>
- <span class="id">exists</span> (<span class="id">pc</span> + 1 - <span class="id">ofs</span>); <span class="tactic">split</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id"><a href="compiler.Sequences.html#plus_one">plus_one</a></span>. <span class="tactic">eapply</span> <span class="id"><a href="compiler.Compiler.html#trans_branch_backward">trans_branch_backward</a></span>; <span class="tactic">eauto</span>. <br/>
&nbsp;&nbsp;<span class="tactic">split</span>; <span class="tactic">congruence</span>.<br/>
- <span class="tactic">destruct</span> (<span class="id">IHcompile_cont</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> (<span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Logic.html#refl_equal">refl_equal</a></span> <span class="id">_</span>)) <span class="kwd">as</span> [<span class="id">pc</span>'' [<span class="id">A</span> [<span class="id">B</span> <span class="id">D</span>]]].<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">pc</span>''; <span class="tactic">split</span>; <span class="tactic">auto</span>. <span class="tactic">eapply</span> <span class="id"><a href="compiler.Sequences.html#plus_left">plus_left</a></span>. <span class="tactic">eapply</span> <span class="id"><a href="compiler.Compiler.html#trans_branch_forward">trans_branch_forward</a></span>; <span class="tactic">eauto</span>. <span class="tactic">apply</span> <span class="id"><a href="compiler.Sequences.html#plus_star">plus_star</a></span>; <span class="tactic">auto</span>. <br/>
Qed.</div>
<br/>
<span class="kwd">Remark</span> <span class="id"><a name="code_at_inv">code_at_inv</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">C</span> <span class="id">pc</span> <span class="id">i</span>, <span class="id"><a href="compiler.Compiler.html#code_at">code_at</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id"><a href="compiler.Compiler.html#i">i</a></span> -&gt; <span class="id">exists</span> <span class="id">C1</span>, <span class="id">exists</span> <span class="id">C2</span>, <span class="id"><a href="compiler.Compiler.html#C">C</a></span> = <span class="id"><a href="compiler.Compiler.html#C1">C1</a></span> ++ <span class="id"><a href="compiler.Compiler.html#C2">C2</a></span> /\ <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id"><a href="compiler.Compiler.html#C1">C1</a></span> = <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof23')">Proof.</div>
<div class="proofscript" id="proof23">
&nbsp;&nbsp;<span class="tactic">induction</span> <span class="id">C</span>; <span class="tactic">simpl</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">inversion</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">pc</span>. <span class="tactic">inversion</span> <span class="id">H</span>. <span class="id">exists</span> (@<span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span> <span class="id"><a href="compiler.Compiler.html#instruction">instruction</a></span>); <span class="id">exists</span> (<span class="id">i</span> :: <span class="id">C</span>); <span class="tactic">auto</span>. <br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">IHC</span> <span class="id">_</span> <span class="id">_</span> <span class="id">H</span>) <span class="kwd">as</span> [<span class="id">C1</span> [<span class="id">C2</span> [<span class="id">A</span> <span class="id">B</span>]]].<br/>
&nbsp;&nbsp;<span class="id">exists</span> (<span class="id">a</span> :: <span class="id">C1</span>); <span class="id">exists</span> <span class="id">C2</span>; <span class="tactic">split</span>. <span class="tactic">simpl</span>; <span class="tactic">congruence</span>. <span class="tactic">simpl</span>; <span class="tactic">congruence</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Remark</span> <span class="id"><a name="code_at_codeseq">code_at_codeseq</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">C</span> <span class="id">pc</span> <span class="id">i</span>, <span class="id"><a href="compiler.Compiler.html#code_at">code_at</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id"><a href="compiler.Compiler.html#i">i</a></span> -&gt; <span class="id"><a href="compiler.Compiler.html#codeseq_at">codeseq_at</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof24')">Proof.</div>
<div class="proofscript" id="proof24">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">destruct</span> (<span class="id"><a href="compiler.Compiler.html#code_at_inv">code_at_inv</a></span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">H</span>) <span class="kwd">as</span> [<span class="id">C1</span> [<span class="id">C2</span> [<span class="id">A</span> <span class="id">B</span>]]]. <br/>
&nbsp;&nbsp;<span class="tactic">subst</span>. <span class="id">change</span> <span class="id">C2</span> <span class="kwd">with</span> (<span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span> ++ <span class="id">C2</span>). <span class="id">constructor</span>. <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="match_config_skip">match_config_skip</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">C</span> <span class="id">k</span> <span class="id">m</span> <span class="id">pc</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#compile_cont">compile_cont</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id"><a href="compiler.Compiler.html#k">k</a></span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#match_config">match_config</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> (<span class="id">SKIP</span>, <span class="id"><a href="compiler.Compiler.html#k">k</a></span>, <span class="id"><a href="compiler.Compiler.html#m">m</a></span>) (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span>, <span class="id"><a href="compiler.Compiler.html#m">m</a></span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof25')">Proof.</div>
<div class="proofscript" id="proof25">
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">C</span>.<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="kwd">forall</span> <span class="id">k</span> <span class="id">pc</span>, <span class="id"><a href="compiler.Compiler.html#compile_cont">compile_cont</a></span> <span class="id">C</span> <span class="id"><a href="compiler.Compiler.html#k">k</a></span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> -&gt; <span class="id"><a href="compiler.Compiler.html#codeseq_at">codeseq_at</a></span> <span class="id">C</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">induction</span> 1.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id"><a href="compiler.Compiler.html#code_at_codeseq">code_at_codeseq</a></span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">change</span> (<span class="id"><a href="compiler.Compiler.html#compile_com">compile_com</a></span> <span class="id">c</span>) <span class="kwd">with</span> (<span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span> ++ <span class="id"><a href="compiler.Compiler.html#compile_com">compile_com</a></span> <span class="id">c</span>) <span class="kwd">in</span> <span class="id">H</span>. <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id"><a href="compiler.Compiler.html#code_at_codeseq">code_at_codeseq</a></span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id"><a href="compiler.Compiler.html#code_at_codeseq">code_at_codeseq</a></span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="id">constructor</span>. <span class="tactic">simpl</span>. <span class="tactic">eauto</span>. <span class="tactic">simpl</span>. <span class="tactic">rewrite</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Arith.Plus.html#plus_0_r">plus_0_r</a></span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<div class="doc">At long last, we can state and prove the right simulation diagram. </div>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="simulation_step">simulation_step</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">C</span> <span class="id">impstate1</span> <span class="id">impstate2</span> <span class="id">machstate1</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Semantics.html#kstep">kstep</a></span> <span class="id"><a href="compiler.Compiler.html#impstate1">impstate1</a></span> <span class="id"><a href="compiler.Compiler.html#impstate2">impstate2</a></span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#match_config">match_config</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id"><a href="compiler.Compiler.html#impstate1">impstate1</a></span> <span class="id"><a href="compiler.Compiler.html#machstate1">machstate1</a></span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">machstate2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id"><a href="compiler.Sequences.html#plus">plus</a></span> (<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span>) <span class="id"><a href="compiler.Compiler.html#machstate1">machstate1</a></span> <span class="id"><a href="compiler.Compiler.html#machstate2">machstate2</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\/ (<span class="id"><a href="compiler.Sequences.html#star">star</a></span> (<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span>) <span class="id"><a href="compiler.Compiler.html#machstate1">machstate1</a></span> <span class="id"><a href="compiler.Compiler.html#machstate2">machstate2</a></span> /\ <span class="kwd">measure</span> <span class="id"><a href="compiler.Compiler.html#impstate2">impstate2</a></span> &lt; <span class="kwd">measure</span> <span class="id"><a href="compiler.Compiler.html#impstate1">impstate1</a></span>))<br/>
&nbsp;&nbsp;&nbsp;/\ <span class="id"><a href="compiler.Compiler.html#match_config">match_config</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id"><a href="compiler.Compiler.html#impstate2">impstate2</a></span> <span class="id"><a href="compiler.Compiler.html#machstate2">machstate2</a></span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof26')">Proof.</div>
<div class="proofscript" id="proof26">
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">until</span> <span class="id">machstate1</span>; <span class="tactic">intros</span> <span class="id">KSTEP</span> <span class="id">MATCH</span>. <br/>
&nbsp;&nbsp;<span class="tactic">inversion</span> <span class="id">KSTEP</span>; <span class="tactic">clear</span> <span class="id">KSTEP</span>; <span class="tactic">subst</span>; <span class="tactic">inversion</span> <span class="id">MATCH</span>; <span class="tactic">clear</span> <span class="id">MATCH</span>; <span class="tactic">subst</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> *.<br/>
<br/>
- <span class="comment">(*&nbsp;assign&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">econstructor</span>; <span class="tactic">split</span>.<br/>
&nbsp;&nbsp;<span class="id">left</span>. <span class="tactic">eapply</span> <span class="id"><a href="compiler.Sequences.html#plus_right">plus_right</a></span>. <span class="tactic">eapply</span> <span class="id"><a href="compiler.Compiler.html#compile_aexp_correct">compile_aexp_correct</a></span>; <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>. <br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id"><a href="compiler.Compiler.html#trans_setvar">trans_setvar</a></span>; <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>. <br/>
&nbsp;&nbsp;<span class="id">normalize</span>. <span class="tactic">apply</span> <span class="id"><a href="compiler.Compiler.html#match_config_skip">match_config_skip</a></span>. <span class="tactic">auto</span>.<br/>
<br/>
- <span class="comment">(*&nbsp;seq&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">econstructor</span>; <span class="tactic">split</span>.<br/>
&nbsp;&nbsp;<span class="id">right</span>; <span class="tactic">split</span>. <span class="tactic">apply</span> <span class="id"><a href="compiler.Sequences.html#star_refl">star_refl</a></span>. <span class="tactic">omega</span>. <br/>
&nbsp;&nbsp;<span class="id">normalize</span>. <span class="id">constructor</span>. <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>. <span class="tactic">eapply</span> <span class="id"><a href="compiler.Compiler.html#ccont_seq">ccont_seq</a></span>; <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>. <br/>
<br/>
- <span class="comment">(*&nbsp;if&nbsp;true&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="tactic">set</span> (<span class="id">code1</span> := <span class="id"><a href="compiler.Compiler.html#compile_com">compile_com</a></span> <span class="id">c1</span>) <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;<span class="tactic">set</span> (<span class="id">codeb</span> := <span class="id"><a href="compiler.Compiler.html#compile_bexp">compile_bexp</a></span> <span class="id">b</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#false">false</a></span> (<span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id">code1</span> + 1)) <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;<span class="tactic">set</span> (<span class="id">code2</span> := <span class="id"><a href="compiler.Compiler.html#compile_com">compile_com</a></span> <span class="id">c2</span>) <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;<span class="id">econstructor</span>; <span class="tactic">split</span>.<br/>
&nbsp;&nbsp;<span class="id">right</span>; <span class="tactic">split</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id"><a href="compiler.Compiler.html#compile_bexp_correct">compile_bexp_correct</a></span> <span class="kwd">with</span> (<span class="id">b</span> := <span class="id">b</span>) (<span class="id">cond</span> := <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#false">false</a></span>) (<span class="id">ofs</span> := <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id">code1</span> + 1).<br/>
&nbsp;&nbsp;<span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>.<br/>
&nbsp;&nbsp;<span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H</span>; <span class="tactic">simpl</span>. <span class="id">fold</span> <span class="id">codeb</span>. <span class="id">normalize</span>. <span class="id">constructor</span>; <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>. <br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id"><a href="compiler.Compiler.html#ccont_branch">ccont_branch</a></span>; <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>. <br/>
&nbsp;&nbsp;<span class="id">change</span> (<span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#S">S</a></span> (<span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id">code2</span>)) <span class="kwd">with</span> (1 + <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id">code2</span>) <span class="kwd">in</span> <span class="id">H5</span>. <span class="id">normalize</span>. <span class="tactic">auto</span>.<br/>
<br/>
- <span class="comment">(*&nbsp;if&nbsp;false&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="tactic">set</span> (<span class="id">code1</span> := <span class="id"><a href="compiler.Compiler.html#compile_com">compile_com</a></span> <span class="id">c1</span>) <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;<span class="tactic">set</span> (<span class="id">codeb</span> := <span class="id"><a href="compiler.Compiler.html#compile_bexp">compile_bexp</a></span> <span class="id">b</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#false">false</a></span> (<span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id">code1</span> + 1)) <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;<span class="tactic">set</span> (<span class="id">code2</span> := <span class="id"><a href="compiler.Compiler.html#compile_com">compile_com</a></span> <span class="id">c2</span>) <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;<span class="id">econstructor</span>; <span class="tactic">split</span>.<br/>
&nbsp;&nbsp;<span class="id">right</span>; <span class="tactic">split</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id"><a href="compiler.Compiler.html#compile_bexp_correct">compile_bexp_correct</a></span> <span class="kwd">with</span> (<span class="id">b</span> := <span class="id">b</span>) (<span class="id">cond</span> := <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#false">false</a></span>) (<span class="id">ofs</span> := <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id">code1</span> + 1).<br/>
&nbsp;&nbsp;<span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>.<br/>
&nbsp;&nbsp;<span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H</span>; <span class="tactic">simpl</span>. <span class="id">fold</span> <span class="id">codeb</span>. <span class="id">normalize</span>. <span class="id">constructor</span>; <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>. <br/>
&nbsp;&nbsp;<span class="id">change</span> (<span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#S">S</a></span> (<span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id">code2</span>)) <span class="kwd">with</span> (1 + <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id">code2</span>) <span class="kwd">in</span> <span class="id">H5</span>. <span class="id">normalize</span>. <span class="tactic">auto</span>.<br/>
<br/>
- <span class="comment">(*&nbsp;while&nbsp;true&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="tactic">set</span> (<span class="id">codec</span> := <span class="id"><a href="compiler.Compiler.html#compile_com">compile_com</a></span> <span class="id">c</span>) <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;<span class="tactic">set</span> (<span class="id">codeb</span> := <span class="id"><a href="compiler.Compiler.html#compile_bexp">compile_bexp</a></span> <span class="id">b</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#false">false</a></span> (<span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id">codec</span> + 1)) <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;<span class="id">econstructor</span>; <span class="tactic">split</span>.<br/>
&nbsp;&nbsp;<span class="id">right</span>; <span class="tactic">split</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id"><a href="compiler.Compiler.html#compile_bexp_correct">compile_bexp_correct</a></span> <span class="kwd">with</span> (<span class="id">b</span> := <span class="id">b</span>) (<span class="id">cond</span> := <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#false">false</a></span>) (<span class="id">ofs</span> := <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id">codec</span> + 1).<br/>
&nbsp;&nbsp;<span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>.<br/>
&nbsp;&nbsp;<span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H</span>; <span class="tactic">simpl</span>. <span class="id">fold</span> <span class="id">codeb</span>. <span class="id">normalize</span>. <span class="id">constructor</span>; <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>.<br/>
&nbsp;&nbsp;<span class="id">fold</span> <span class="id">codec</span>.<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">PC</span>: <span class="id">pc</span> + <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id">codeb</span> + <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id">codec</span> + 1 - (<span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id">codeb</span> + <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id">codec</span> + 1) = <span class="id">pc</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">by</span> <span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id"><a href="compiler.Compiler.html#ccont_while">ccont_while</a></span>; <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>. <span class="tactic">rewrite</span> <span class="id">PC</span>; <span class="tactic">auto</span>. <span class="tactic">rewrite</span> <span class="id">PC</span>.<br/>
&nbsp;&nbsp;<span class="tactic">simpl</span>. <span class="id">normalize</span>. <span class="tactic">auto</span>.<br/>
<br/>
- <span class="comment">(*&nbsp;while&nbsp;false&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="tactic">set</span> (<span class="id">codec</span> := <span class="id"><a href="compiler.Compiler.html#compile_com">compile_com</a></span> <span class="id">c</span>) <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;<span class="tactic">set</span> (<span class="id">codeb</span> := <span class="id"><a href="compiler.Compiler.html#compile_bexp">compile_bexp</a></span> <span class="id">b</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#false">false</a></span> (<span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id">codec</span> + 1)) <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;<span class="id">econstructor</span>; <span class="tactic">split</span>.<br/>
&nbsp;&nbsp;<span class="id">right</span>; <span class="tactic">split</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id"><a href="compiler.Compiler.html#compile_bexp_correct">compile_bexp_correct</a></span> <span class="kwd">with</span> (<span class="id">b</span> := <span class="id">b</span>) (<span class="id">cond</span> := <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#false">false</a></span>) (<span class="id">ofs</span> := <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id">codec</span> + 1).<br/>
&nbsp;&nbsp;<span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">codeseq</span>.<br/>
&nbsp;&nbsp;<span class="tactic">generalize</span> (<span class="id"><a href="compiler.Compiler.html#com_size_nonzero">com_size_nonzero</a></span> <span class="id">c</span>). <span class="tactic">omega</span>. <br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H</span>; <span class="tactic">simpl</span>. <span class="id">fold</span> <span class="id">codeb</span>. <span class="id">normalize</span>. <span class="tactic">apply</span> <span class="id"><a href="compiler.Compiler.html#match_config_skip">match_config_skip</a></span>. <span class="tactic">auto</span>. <br/>
<br/>
- <span class="comment">(*&nbsp;skip&nbsp;seq&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">normalize</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id"><a href="compiler.Compiler.html#compile_cont_Kseq_inv">compile_cont_Kseq_inv</a></span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">st</span> <span class="id">H4</span>) <span class="kwd">as</span> [<span class="id">pc</span>' [<span class="id">X</span> [<span class="id">Y</span> <span class="id">Z</span>]]].<br/>
&nbsp;&nbsp;<span class="id">econstructor</span>; <span class="tactic">split</span>.<br/>
&nbsp;&nbsp;<span class="id">right</span>; <span class="tactic">split</span>. <span class="id">eexact</span> <span class="id">X</span>. <span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;<span class="id">constructor</span>; <span class="tactic">auto</span>. <br/>
<br/>
- <span class="comment">(*&nbsp;skip&nbsp;while&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">normalize</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id"><a href="compiler.Compiler.html#compile_cont_Kwhile_inv">compile_cont_Kwhile_inv</a></span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">st</span> <span class="id">H4</span>) <span class="kwd">as</span> [<span class="id">pc</span>' [<span class="id">X</span> [<span class="id">Y</span> <span class="id">Z</span>]]].<br/>
&nbsp;&nbsp;<span class="id">econstructor</span>; <span class="tactic">split</span>.<br/>
&nbsp;&nbsp;<span class="id">left</span>. <span class="id">eexact</span> <span class="id">X</span>. <br/>
&nbsp;&nbsp;<span class="id">constructor</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<div class="doc">Simulation diagrams such as <span class="bracket"><span class="id">simulation_step</span></span> above imply semantic preservation
  for terminating programs and for diverging programs.  We now develop a generic
  proof of this fact that we can reuse later for other program transformations. </div>
<br/>
<span class="kwd">Section</span> <span class="id"><a name="SIMULATION_DIAGRAM">SIMULATION_DIAGRAM</a></span>.<br/>
<br/>
<div class="doc">The generic proof is parameterized over the small-step semantics for the
  source and target languages, and over an invariant between their states. </div>
<br/>
<span class="kwd">Variable</span> <span class="id"><a name="SIMULATION_DIAGRAM.state1">state1</a></span>: <span class="kwd">Type</span>.	     <span class="docright">(* the type of configurations for the source language  *)</span><br/>
<span class="kwd">Variable</span> <span class="id"><a name="SIMULATION_DIAGRAM.step1">step1</a></span>: <span class="id"><a href="compiler.Compiler.html#SIMULATION_DIAGRAM.state1">state1</a></span> -&gt; <span class="id"><a href="compiler.Compiler.html#SIMULATION_DIAGRAM.state1">state1</a></span> -&gt; <span class="kwd">Prop</span>.   <span class="docright">(* the small-step semantics for the source language  *)</span><br/>
<br/>
<span class="kwd">Variable</span> <span class="id"><a name="SIMULATION_DIAGRAM.state2">state2</a></span>: <span class="kwd">Type</span>.	     <span class="docright">(* the type of configurations for the target language  *)</span><br/>
<span class="kwd">Variable</span> <span class="id"><a name="SIMULATION_DIAGRAM.step2">step2</a></span>: <span class="id"><a href="compiler.Compiler.html#SIMULATION_DIAGRAM.state2">state2</a></span> -&gt; <span class="id"><a href="compiler.Compiler.html#SIMULATION_DIAGRAM.state2">state2</a></span> -&gt; <span class="kwd">Prop</span>.   <span class="docright">(* the small-step semantics for the target language  *)</span><br/>
<br/>
<span class="kwd">Variable</span> <span class="id"><a name="SIMULATION_DIAGRAM.match_states">match_states</a></span>: <span class="id"><a href="compiler.Compiler.html#SIMULATION_DIAGRAM.state1">state1</a></span> -&gt; <span class="id"><a href="compiler.Compiler.html#SIMULATION_DIAGRAM.state2">state2</a></span> -&gt; <span class="kwd">Prop</span>.  <span class="docright">(* the invariant  *)</span><br/>
<br/>
<span class="kwd">Variable</span> <span class="kwd">measure</span>: <span class="id"><a href="compiler.Compiler.html#SIMULATION_DIAGRAM.state1">state1</a></span> -&gt; <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>.                  <span class="docright">(* the anti-stuttering measure  *)</span><br/>
<br/>
<span class="kwd">Hypothesis</span> <span class="id"><a name="SIMULATION_DIAGRAM.simulation">simulation</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">S1</span> <span class="id">S1</span>' <span class="id">S2</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#SIMULATION_DIAGRAM.step1">step1</a></span> <span class="id"><a href="compiler.Compiler.html#S1">S1</a></span> <span class="id">S1</span>' -&gt; <span class="id"><a href="compiler.Compiler.html#SIMULATION_DIAGRAM.match_states">match_states</a></span> <span class="id"><a href="compiler.Compiler.html#S1">S1</a></span> <span class="id"><a href="compiler.Compiler.html#S2">S2</a></span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">S2</span>',<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id"><a href="compiler.Sequences.html#plus">plus</a></span> <span class="id"><a href="compiler.Compiler.html#SIMULATION_DIAGRAM.step2">step2</a></span> <span class="id"><a href="compiler.Compiler.html#S2">S2</a></span> <span class="id">S2</span>' \/ (<span class="id"><a href="compiler.Sequences.html#star">star</a></span> <span class="id"><a href="compiler.Compiler.html#SIMULATION_DIAGRAM.step2">step2</a></span> <span class="id"><a href="compiler.Compiler.html#S2">S2</a></span> <span class="id">S2</span>' /\ <span class="kwd">measure</span> <span class="id">S1</span>' &lt; <span class="kwd">measure</span> <span class="id"><a href="compiler.Compiler.html#S1">S1</a></span>))<br/>
&nbsp;&nbsp;/\ <span class="id"><a href="compiler.Compiler.html#SIMULATION_DIAGRAM.match_states">match_states</a></span> <span class="id">S1</span>' <span class="id">S2</span>'.<br/>
<br/>
<div class="doc">We first extend the simulation to finite sequences of source transitions.
  This will show semantic preservation for terminating programs. </div>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="simulation_star">simulation_star</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">S1</span> <span class="id">S1</span>', <span class="id"><a href="compiler.Sequences.html#star">star</a></span> <span class="id"><a href="compiler.Compiler.html#SIMULATION_DIAGRAM.step1">step1</a></span> <span class="id"><a href="compiler.Compiler.html#S1">S1</a></span> <span class="id">S1</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">S2</span>, <span class="id"><a href="compiler.Compiler.html#SIMULATION_DIAGRAM.match_states">match_states</a></span> <span class="id"><a href="compiler.Compiler.html#S1">S1</a></span> <span class="id"><a href="compiler.Compiler.html#S2">S2</a></span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">S2</span>', <span class="id"><a href="compiler.Sequences.html#star">star</a></span> <span class="id"><a href="compiler.Compiler.html#SIMULATION_DIAGRAM.step2">step2</a></span> <span class="id"><a href="compiler.Compiler.html#S2">S2</a></span> <span class="id">S2</span>' /\ <span class="id"><a href="compiler.Compiler.html#SIMULATION_DIAGRAM.match_states">match_states</a></span> <span class="id">S1</span>' <span class="id">S2</span>'.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof27')">Proof.</div>
<div class="proofscript" id="proof27">
&nbsp;&nbsp;<span class="tactic">induction</span> 1; <span class="tactic">intros</span>.<br/>
- <span class="comment">(*&nbsp;zero&nbsp;transition&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">S2</span>; <span class="tactic">split</span>. <span class="tactic">apply</span> <span class="id"><a href="compiler.Sequences.html#star_refl">star_refl</a></span>. <span class="tactic">auto</span>.<br/>
- <span class="comment">(*&nbsp;one&nbsp;or&nbsp;more&nbsp;transitions&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id"><a href="compiler.Compiler.html#SIMULATION_DIAGRAM.simulation">simulation</a></span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">H</span> <span class="id">H1</span>) <span class="kwd">as</span> [<span class="id">S2</span>' [<span class="id">P</span> <span class="id">Q</span>]].<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">IHstar</span> <span class="id">_</span> <span class="id">Q</span>) <span class="kwd">as</span> [<span class="id">S2</span>'' [<span class="id">U</span> <span class="id">V</span>]].<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">S2</span>''; <span class="tactic">split</span>. <br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id"><a href="compiler.Sequences.html#star_trans">star_trans</a></span>; <span class="tactic">eauto</span>. <span class="tactic">destruct</span> <span class="id">P</span>. <span class="tactic">apply</span> <span class="id"><a href="compiler.Sequences.html#plus_star">plus_star</a></span>; <span class="tactic">auto</span>. <span class="tactic">destruct</span> <span class="id">H2</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<div class="doc">Turning to infinite sequences, we first show that the target program
  can always make progress, while preserving the <span class="bracket"><span class="id">match_states</span></span> relation,
  if the source diverges.  The proof is an induction on the maximal number
  <span class="bracket"><span class="id">N</span></span> of stutterings the target can make before performing at least one transition. </div>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="simulation_infseq_productive">simulation_infseq_productive</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">N</span> <span class="id">S1</span> <span class="id">S2</span>,<br/>
&nbsp;&nbsp;<span class="kwd">measure</span> <span class="id"><a href="compiler.Compiler.html#S1">S1</a></span> &lt; <span class="id"><a href="compiler.Compiler.html#N">N</a></span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Sequences.html#infseq">infseq</a></span> <span class="id"><a href="compiler.Compiler.html#SIMULATION_DIAGRAM.step1">step1</a></span> <span class="id"><a href="compiler.Compiler.html#S1">S1</a></span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#SIMULATION_DIAGRAM.match_states">match_states</a></span> <span class="id"><a href="compiler.Compiler.html#S1">S1</a></span> <span class="id"><a href="compiler.Compiler.html#S2">S2</a></span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">S1</span>', <span class="id">exists</span> <span class="id">S2</span>',<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Sequences.html#plus">plus</a></span> <span class="id"><a href="compiler.Compiler.html#SIMULATION_DIAGRAM.step2">step2</a></span> <span class="id"><a href="compiler.Compiler.html#S2">S2</a></span> <span class="id">S2</span>'<br/>
&nbsp;&nbsp;&nbsp;/\ <span class="id"><a href="compiler.Sequences.html#infseq">infseq</a></span> <span class="id"><a href="compiler.Compiler.html#SIMULATION_DIAGRAM.step1">step1</a></span> <span class="id">S1</span>'<br/>
&nbsp;&nbsp;&nbsp;/\ <span class="id"><a href="compiler.Compiler.html#SIMULATION_DIAGRAM.match_states">match_states</a></span> <span class="id">S1</span>' <span class="id">S2</span>'.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof28')">Proof.</div>
<div class="proofscript" id="proof28">
&nbsp;&nbsp;<span class="tactic">induction</span> <span class="id">N</span>; <span class="tactic">intros</span>. <br/>
- <span class="comment">(*&nbsp;N&nbsp;=&nbsp;0&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">exfalso</span>. <span class="tactic">omega</span>.<br/>
- <span class="comment">(*&nbsp;N&nbsp;&gt;&nbsp;0&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="tactic">inversion</span> <span class="id">H0</span>; <span class="tactic">clear</span> <span class="id">H0</span>; <span class="tactic">subst</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id"><a href="compiler.Compiler.html#SIMULATION_DIAGRAM.simulation">simulation</a></span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">H2</span> <span class="id">H1</span>) <span class="kwd">as</span> [<span class="id">S2</span>' [<span class="id">P</span> <span class="id">Q</span>]].<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">P</span>.<br/>
&nbsp;&nbsp;+ <span class="comment">(*&nbsp;one&nbsp;or&nbsp;several&nbsp;transitions&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exists</span> <span class="id">b</span>; <span class="id">exists</span> <span class="id">S2</span>'; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;+ <span class="comment">(*&nbsp;zero,&nbsp;one&nbsp;or&nbsp;several&nbsp;transitions&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">H0</span>. <span class="tactic">inversion</span> <span class="id">H0</span>; <span class="tactic">clear</span> <span class="id">H0</span>; <span class="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;* <span class="comment">(*&nbsp;zero&nbsp;transitions&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">IHN</span>; <span class="tactic">eauto</span>. <span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;* <span class="comment">(*&nbsp;one&nbsp;or&nbsp;several&nbsp;transitions&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exists</span> <span class="id">b</span>; <span class="id">exists</span> <span class="id">S2</span>'; <span class="tactic">split</span>. <span class="tactic">eapply</span> <span class="id"><a href="compiler.Sequences.html#plus_left">plus_left</a></span>; <span class="tactic">eauto</span>. <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<div class="doc">It follows that the target performs infinitely many transitions if
  started in a configuration that matches a diverging source configuration. </div>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="simulation_infseq">simulation_infseq</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">S1</span> <span class="id">S2</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Sequences.html#infseq">infseq</a></span> <span class="id"><a href="compiler.Compiler.html#SIMULATION_DIAGRAM.step1">step1</a></span> <span class="id"><a href="compiler.Compiler.html#S1">S1</a></span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#SIMULATION_DIAGRAM.match_states">match_states</a></span> <span class="id"><a href="compiler.Compiler.html#S1">S1</a></span> <span class="id"><a href="compiler.Compiler.html#S2">S2</a></span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Sequences.html#infseq">infseq</a></span> <span class="id"><a href="compiler.Compiler.html#SIMULATION_DIAGRAM.step2">step2</a></span> <span class="id"><a href="compiler.Compiler.html#S2">S2</a></span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof29')">Proof.</div>
<div class="proofscript" id="proof29">
&nbsp;&nbsp;<span class="tactic">intros</span>. <br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id"><a href="compiler.Sequences.html#infseq_coinduction_principle_2">infseq_coinduction_principle_2</a></span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">X</span> := <span class="kwd">fun</span> <span class="id">S2</span> =&gt; <span class="id">exists</span> <span class="id">S1</span>, <span class="id"><a href="compiler.Sequences.html#infseq">infseq</a></span> <span class="id"><a href="compiler.Compiler.html#SIMULATION_DIAGRAM.step1">step1</a></span> <span class="id"><a href="compiler.Compiler.html#S1">S1</a></span> /\ <span class="id"><a href="compiler.Compiler.html#SIMULATION_DIAGRAM.match_states">match_states</a></span> <span class="id"><a href="compiler.Compiler.html#S1">S1</a></span> <span class="id"><a href="compiler.Compiler.html#S2">S2</a></span>).<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">destruct</span> <span class="id">H1</span> <span class="kwd">as</span> [<span class="id">S</span> [<span class="id">A</span> <span class="id">B</span>]]. <br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id"><a href="compiler.Compiler.html#simulation_infseq_productive">simulation_infseq_productive</a></span> (<span class="kwd">measure</span> <span class="id">S</span> + 1) <span class="id">S</span> <span class="id">a</span>) <br/>
&nbsp;&nbsp;<span class="kwd">as</span> [<span class="id">S1</span>' [<span class="id">S2</span>' [<span class="id">P</span> [<span class="id">Q</span> <span class="id">R</span>]]]].<br/>
&nbsp;&nbsp;<span class="tactic">omega</span>. <span class="tactic">auto</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">S2</span>'; <span class="tactic">split</span>. <span class="tactic">auto</span>. <span class="id">exists</span> <span class="id">S1</span>'; <span class="tactic">auto</span>. <br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">S1</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">End</span> <span class="id"><a href="compiler.Compiler.html#SIMULATION_DIAGRAM">SIMULATION_DIAGRAM</a></span>.<br/>
<br/>
<div class="doc">We now apply these results to the Imp compiler.  We first obtain
  an alternate proof of semantic preservation for terminating Imp programs. </div>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="match_config_initial">match_config_initial</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">c</span> <span class="id">st</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#match_config">match_config</a></span> (<span class="id"><a href="compiler.Compiler.html#compile_program">compile_program</a></span> <span class="id"><a href="compiler.Compiler.html#c">c</a></span>) (<span class="id"><a href="compiler.Compiler.html#c">c</a></span>, <span class="id"><a href="compiler.Semantics.html#Kstop">Kstop</a></span>, <span class="id"><a href="compiler.Compiler.html#st">st</a></span>) (0, <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span>, <span class="id"><a href="compiler.Compiler.html#st">st</a></span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof30')">Proof.</div>
<div class="proofscript" id="proof30">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="id">constructor</span>.<br/>
&nbsp;&nbsp;<span class="id">change</span> (<span class="id"><a href="compiler.Compiler.html#compile_program">compile_program</a></span> <span class="id">c</span>) <span class="kwd">with</span> (<span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span> ++ <span class="id"><a href="compiler.Compiler.html#compile_com">compile_com</a></span> <span class="id">c</span> ++ <span class="id"><a href="compiler.Compiler.html#Ihalt">Ihalt</a></span> :: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span>). <span class="id">constructor</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">simpl</span>. <span class="tactic">unfold</span> <span class="id"><a href="compiler.Compiler.html#compile_program">compile_program</a></span>. <span class="id">constructor</span>. <span class="tactic">apply</span> <span class="id"><a href="compiler.Compiler.html#code_at_app">code_at_app</a></span>. <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Theorem</span> <span class="id"><a name="compile_program_correct_terminating_2">compile_program_correct_terminating_2</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">c</span> <span class="id">st</span> <span class="id">st</span>',<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Semantics.html#kterminates">kterminates</a></span> <span class="id"><a href="compiler.Compiler.html#c">c</a></span> <span class="id"><a href="compiler.Compiler.html#st">st</a></span> <span class="id">st</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#mach_terminates">mach_terminates</a></span> (<span class="id"><a href="compiler.Compiler.html#compile_program">compile_program</a></span> <span class="id"><a href="compiler.Compiler.html#c">c</a></span>) <span class="id"><a href="compiler.Compiler.html#st">st</a></span> <span class="id">st</span>'.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof31')">Proof.</div>
<div class="proofscript" id="proof31">
&nbsp;&nbsp;<span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">exists</span> <span class="id">machconf2</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Sequences.html#star">star</a></span> (<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> (<span class="id"><a href="compiler.Compiler.html#compile_program">compile_program</a></span> <span class="id">c</span>)) (0, <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span>, <span class="id">st</span>) <span class="id"><a href="compiler.Compiler.html#machconf2">machconf2</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/\ <span class="id"><a href="compiler.Compiler.html#match_config">match_config</a></span> (<span class="id"><a href="compiler.Compiler.html#compile_program">compile_program</a></span> <span class="id">c</span>) (<span class="id">SKIP</span>, <span class="id"><a href="compiler.Semantics.html#Kstop">Kstop</a></span>, <span class="id">st</span>') <span class="id"><a href="compiler.Compiler.html#machconf2">machconf2</a></span>).<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id"><a href="compiler.Compiler.html#simulation_star">simulation_star</a></span>; <span class="tactic">eauto</span>. <span class="tactic">eapply</span> <span class="id"><a href="compiler.Compiler.html#simulation_step">simulation_step</a></span>. <span class="tactic">apply</span> <span class="id"><a href="compiler.Compiler.html#match_config_initial">match_config_initial</a></span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">H0</span> <span class="kwd">as</span> [<span class="id">machconf2</span> [<span class="id">STAR</span> <span class="id">MS</span>]]. <br/>
&nbsp;&nbsp;<span class="tactic">inversion</span> <span class="id">MS</span>; <span class="tactic">subst</span>. <span class="tactic">simpl</span> <span class="kwd">in</span> *. <span class="id">normalize</span>. <br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id"><a href="compiler.Compiler.html#compile_cont_Kstop_inv">compile_cont_Kstop_inv</a></span> <span class="id">_</span> <span class="id">_</span> <span class="id">st</span>' <span class="id">H5</span>) <span class="kwd">as</span> [<span class="id">pc</span>' [<span class="id">A</span> <span class="id">B</span>]].<br/>
&nbsp;&nbsp;<span class="tactic">red</span>. <span class="id">exists</span> <span class="id">pc</span>'; <span class="tactic">split</span>. <span class="tactic">auto</span>. <span class="tactic">eapply</span> <span class="id"><a href="compiler.Sequences.html#star_trans">star_trans</a></span>; <span class="tactic">eauto</span>.<br/>
Qed.</div>
<br/>
<div class="doc">More interestingly, we also prove semantic preservation for diverging
  Imp programs. </div>
<br/>
<span class="kwd">Theorem</span> <span class="id"><a name="compile_program_correct_diverging">compile_program_correct_diverging</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">c</span> <span class="id">st</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Semantics.html#kdiverges">kdiverges</a></span> <span class="id"><a href="compiler.Compiler.html#c">c</a></span> <span class="id"><a href="compiler.Compiler.html#st">st</a></span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#mach_diverges">mach_diverges</a></span> (<span class="id"><a href="compiler.Compiler.html#compile_program">compile_program</a></span> <span class="id"><a href="compiler.Compiler.html#c">c</a></span>) <span class="id"><a href="compiler.Compiler.html#st">st</a></span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof32')">Proof.</div>
<div class="proofscript" id="proof32">
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">red</span>; <span class="tactic">intros</span>. <br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id"><a href="compiler.Compiler.html#simulation_infseq">simulation_infseq</a></span> <span class="kwd">with</span> (<span class="id">match_states</span> := <span class="id"><a href="compiler.Compiler.html#match_config">match_config</a></span> (<span class="id"><a href="compiler.Compiler.html#compile_program">compile_program</a></span> <span class="id">c</span>)); <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id"><a href="compiler.Compiler.html#simulation_step">simulation_step</a></span>. <span class="tactic">apply</span> <span class="id"><a href="compiler.Compiler.html#match_config_initial">match_config_initial</a></span>.<br/>
Qed.</div>
<br/>
<h3> Mini-project (4 stars) </h3>
<br/>
<div class="doc">Our compiler for arithmetic expressions implements a left-to-right
  evaluation order: in <span class="bracket"><span class="id">a1</span> + <span class="id">a2</span></span>, <span class="bracket"><span class="id">a1</span></span> is evaluated first, and its value
  left on the stack; then <span class="bracket"><span class="id">a2</span></span> is evaluated; then an <span class="bracket"><span class="id">Iadd</span></span> instruction
  is performed.  For commutative operators like <span class="bracket">+</span> and <span class="bracket">*</span>, we
  could just as well evaluate <span class="bracket"><span class="id">a2</span></span> first, then <span class="bracket"><span class="id">a1</span></span>, then combine
  their results.  
  This can help producing more efficient code in terms of how much
  stack space is required by the evaluation.  Consider the expression
  <span class="bracket">1 + (2 + (3 + ... (<span class="id">N</span>-1 + <span class="id">N</span>)))</span>.  With left-to-right evaluation,
  it uses <span class="bracket"><span class="id">N</span>+1</span> stack entries.  With right-to-left evaluation,
  it uses only 2 stack entries.  
  In this exercise, we explore the effect of different evaluation orders
  on stack usage.  Let us first parameterize <span class="bracket"><span class="id">compile_aexp</span></span> with
  a heuristic function <span class="bracket"><span class="id">ord</span></span> that, given the two arguments of a <span class="bracket">+</span>
  or <span class="bracket">*</span> operator, decides whether to evaluate them left-to-right
  or right-to-left: </div>
<br/>
<span class="kwd">Inductive</span> <span class="id"><a name="eval_order">eval_order</a></span> : <span class="kwd">Type</span> := <span class="id"><a name="LtoR">LtoR</a></span> | <span class="id"><a name="RtoL">RtoL</a></span>.<br/>
<br/>
<span class="kwd">Fixpoint</span> <span class="id"><a name="compile_aexp_gen">compile_aexp_gen</a></span> (<span class="id">ord</span>: <span class="id"><a href="../SF/lf/Imp.html#aexp">aexp</a></span> -&gt; <span class="id"><a href="../SF/lf/Imp.html#aexp">aexp</a></span> -&gt; <span class="id"><a href="compiler.Compiler.html#eval_order">eval_order</a></span>) (<span class="id">a</span>: <span class="id"><a href="../SF/lf/Imp.html#aexp">aexp</a></span>) : <span class="id"><a href="compiler.Compiler.html#code">code</a></span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id"><a href="compiler.Compiler.html#a">a</a></span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id"><a href="../SF/lf/Imp.html#ANum">ANum</a></span> <span class="id">n</span> =&gt; <span class="id"><a href="compiler.Compiler.html#Iconst">Iconst</a></span> <span class="id">n</span> :: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span><br/>
&nbsp;&nbsp;| <span class="id"><a href="../SF/lf/Imp.html#AId">AId</a></span> <span class="id">v</span> =&gt; <span class="id"><a href="compiler.Compiler.html#Ivar">Ivar</a></span> <span class="id">v</span> :: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span><br/>
&nbsp;&nbsp;| <span class="id"><a href="../SF/lf/Imp.html#APlus">APlus</a></span> <span class="id">a1</span> <span class="id">a2</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id"><a href="compiler.Compiler.html#ord">ord</a></span> <span class="id">a1</span> <span class="id">a2</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id"><a href="compiler.Compiler.html#LtoR">LtoR</a></span> =&gt; <span class="id"><a href="compiler.Compiler.html#compile_aexp_gen">compile_aexp_gen</a></span> <span class="id"><a href="compiler.Compiler.html#ord">ord</a></span> <span class="id">a1</span> ++ <span class="id"><a href="compiler.Compiler.html#compile_aexp_gen">compile_aexp_gen</a></span> <span class="id"><a href="compiler.Compiler.html#ord">ord</a></span> <span class="id">a2</span> ++ <span class="id"><a href="compiler.Compiler.html#Iadd">Iadd</a></span> :: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id"><a href="compiler.Compiler.html#RtoL">RtoL</a></span> =&gt; <span class="id"><a href="compiler.Compiler.html#compile_aexp_gen">compile_aexp_gen</a></span> <span class="id"><a href="compiler.Compiler.html#ord">ord</a></span> <span class="id">a2</span> ++ <span class="id"><a href="compiler.Compiler.html#compile_aexp_gen">compile_aexp_gen</a></span> <span class="id"><a href="compiler.Compiler.html#ord">ord</a></span> <span class="id">a1</span> ++ <span class="id"><a href="compiler.Compiler.html#Iadd">Iadd</a></span> :: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;| <span class="id"><a href="../SF/lf/Imp.html#AMinus">AMinus</a></span> <span class="id">a1</span> <span class="id">a2</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#compile_aexp_gen">compile_aexp_gen</a></span> <span class="id"><a href="compiler.Compiler.html#ord">ord</a></span> <span class="id">a1</span> ++ <span class="id"><a href="compiler.Compiler.html#compile_aexp_gen">compile_aexp_gen</a></span> <span class="id"><a href="compiler.Compiler.html#ord">ord</a></span> <span class="id">a2</span> ++ <span class="id"><a href="compiler.Compiler.html#Isub">Isub</a></span> :: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span><br/>
&nbsp;&nbsp;| <span class="id"><a href="../SF/lf/Imp.html#AMult">AMult</a></span> <span class="id">a1</span> <span class="id">a2</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id"><a href="compiler.Compiler.html#ord">ord</a></span> <span class="id">a1</span> <span class="id">a2</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id"><a href="compiler.Compiler.html#LtoR">LtoR</a></span> =&gt; <span class="id"><a href="compiler.Compiler.html#compile_aexp_gen">compile_aexp_gen</a></span> <span class="id"><a href="compiler.Compiler.html#ord">ord</a></span> <span class="id">a1</span> ++ <span class="id"><a href="compiler.Compiler.html#compile_aexp_gen">compile_aexp_gen</a></span> <span class="id"><a href="compiler.Compiler.html#ord">ord</a></span> <span class="id">a2</span> ++ <span class="id"><a href="compiler.Compiler.html#Imul">Imul</a></span> :: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id"><a href="compiler.Compiler.html#RtoL">RtoL</a></span> =&gt; <span class="id"><a href="compiler.Compiler.html#compile_aexp_gen">compile_aexp_gen</a></span> <span class="id"><a href="compiler.Compiler.html#ord">ord</a></span> <span class="id">a2</span> ++ <span class="id"><a href="compiler.Compiler.html#compile_aexp_gen">compile_aexp_gen</a></span> <span class="id"><a href="compiler.Compiler.html#ord">ord</a></span> <span class="id">a1</span> ++ <span class="id"><a href="compiler.Compiler.html#Imul">Imul</a></span> :: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<div class="doc">First show that, whatever the <span class="bracket"><span class="id">ord</span></span> heuristic is, the code generated
by <span class="bracket"><span class="id">compile_aexp_gen</span> <span class="id">ord</span></span> is correct.  This is a simple extension of
the proof of <span class="bracket"><span class="id">compile_aexp_correct</span></span>. </div>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="compile_aexp_gen_correct">compile_aexp_gen_correct</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">ord</span> <span class="id">C</span> <span class="id">st</span> <span class="id">a</span> <span class="id">pc</span> <span class="id">stk</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#codeseq_at">codeseq_at</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> (<span class="id"><a href="compiler.Compiler.html#compile_aexp_gen">compile_aexp_gen</a></span> <span class="id"><a href="compiler.Compiler.html#ord">ord</a></span> <span class="id"><a href="compiler.Compiler.html#a">a</a></span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Sequences.html#star">star</a></span> (<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>, <span class="id"><a href="compiler.Compiler.html#st">st</a></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> (<span class="id"><a href="compiler.Compiler.html#compile_aexp_gen">compile_aexp_gen</a></span> <span class="id"><a href="compiler.Compiler.html#ord">ord</a></span> <span class="id"><a href="compiler.Compiler.html#a">a</a></span>), <span class="id"><a href="../SF/lf/Imp.html#aeval">aeval</a></span> <span class="id"><a href="compiler.Compiler.html#st">st</a></span> <span class="id"><a href="compiler.Compiler.html#a">a</a></span> :: <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>, <span class="id"><a href="compiler.Compiler.html#st">st</a></span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof33')">Proof.</div>
<div class="proofscript" id="proof33">
&nbsp;&nbsp;<span class="tactic">induction</span> <span class="id">a</span>; <span class="tactic">simpl</span>; <span class="tactic">intros</span>.<br/>
&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span>Admitted.</div>
<br/>
<div class="doc">Now, let us try to compute the minimum number of stack entries
  needed to evaluate an expression, regardless of the strategy used. </div>
<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Arith.Min.html">Min</a></span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Arith.Max.html">Max</a></span>.     <span class="docright">(* Libraries of lemmas about min and max  *)</span><br/>
<br/>
<span class="kwd">Fixpoint</span> <span class="id"><a name="stack_needs">stack_needs</a></span> (<span class="id">a</span>: <span class="id"><a href="../SF/lf/Imp.html#aexp">aexp</a></span>) : <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id"><a href="compiler.Compiler.html#a">a</a></span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id"><a href="../SF/lf/Imp.html#ANum">ANum</a></span> <span class="id">n</span> =&gt; 1<br/>
&nbsp;&nbsp;| <span class="id"><a href="../SF/lf/Imp.html#AId">AId</a></span> <span class="id">v</span> =&gt; 1<br/>
&nbsp;&nbsp;| <span class="id"><a href="../SF/lf/Imp.html#APlus">APlus</a></span> <span class="id">a1</span> <span class="id">a2</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">n1</span> := <span class="id"><a href="compiler.Compiler.html#stack_needs">stack_needs</a></span> <span class="id">a1</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">n2</span> := <span class="id"><a href="compiler.Compiler.html#stack_needs">stack_needs</a></span> <span class="id">a2</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="http://coq.inria.fr/library/Coq.Arith.Min.html#min">min</a></span> (<span class="id"><a href="http://coq.inria.fr/library/Coq.Arith.Max.html#max">max</a></span> <span class="id"><a href="compiler.Compiler.html#n1">n1</a></span> (<span class="id"><a href="compiler.Compiler.html#n2">n2</a></span> + 1)) (<span class="id"><a href="http://coq.inria.fr/library/Coq.Arith.Max.html#max">max</a></span> <span class="id"><a href="compiler.Compiler.html#n2">n2</a></span> (<span class="id"><a href="compiler.Compiler.html#n1">n1</a></span> + 1))<br/>
&nbsp;&nbsp;| <span class="id"><a href="../SF/lf/Imp.html#AMinus">AMinus</a></span> <span class="id">a1</span> <span class="id">a2</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">n1</span> := <span class="id"><a href="compiler.Compiler.html#stack_needs">stack_needs</a></span> <span class="id">a1</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">n2</span> := <span class="id"><a href="compiler.Compiler.html#stack_needs">stack_needs</a></span> <span class="id">a2</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="http://coq.inria.fr/library/Coq.Arith.Max.html#max">max</a></span> <span class="id"><a href="compiler.Compiler.html#n1">n1</a></span> (<span class="id"><a href="compiler.Compiler.html#n2">n2</a></span> + 1)<br/>
&nbsp;&nbsp;| <span class="id"><a href="../SF/lf/Imp.html#AMult">AMult</a></span> <span class="id">a1</span> <span class="id">a2</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">n1</span> := <span class="id"><a href="compiler.Compiler.html#stack_needs">stack_needs</a></span> <span class="id">a1</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">n2</span> := <span class="id"><a href="compiler.Compiler.html#stack_needs">stack_needs</a></span> <span class="id">a2</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="http://coq.inria.fr/library/Coq.Arith.Min.html#min">min</a></span> (<span class="id"><a href="http://coq.inria.fr/library/Coq.Arith.Max.html#max">max</a></span> <span class="id"><a href="compiler.Compiler.html#n1">n1</a></span> (<span class="id"><a href="compiler.Compiler.html#n2">n2</a></span> + 1)) (<span class="id"><a href="http://coq.inria.fr/library/Coq.Arith.Max.html#max">max</a></span> <span class="id"><a href="compiler.Compiler.html#n2">n2</a></span> (<span class="id"><a href="compiler.Compiler.html#n1">n1</a></span> + 1))<br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<div class="doc">This definition is a variation on the Strahler numbering of a tree.
  Here are some intuitions.  Consider <span class="bracket"><span class="id">APlus</span> <span class="id">a1</span> <span class="id">a2</span></span>.  If we
  evaluate <span class="bracket"><span class="id">a1</span></span> then <span class="bracket"><span class="id">a2</span></span>, we will need at least <span class="bracket"><span class="id">stack_needs</span> <span class="id">a1</span></span>
  space for evaluating <span class="bracket"><span class="id">a1</span></span>, then <span class="bracket"><span class="id">stack_needs</span> <span class="id">a2</span> + 1</span> for <span class="bracket"><span class="id">a2</span></span>:
  plus one, because during the evaluation of <span class="bracket"><span class="id">a2</span></span>, the value of <span class="bracket"><span class="id">a1</span></span>
  sits in the stack.  So, our space usage is the max of these two
  quantities.  But we can also choose the other evaluation order,
  so our space usage is the min of the two max corresponding to the
  two possible evaluation orders. </div>
<br/>
<div class="doc">To show that <span class="bracket"><span class="id">stack_needs</span></span> is the minimal stack size required,
  we can define the stack usage (number of stack entries needed) of
  a given strategy <span class="bracket"><span class="id">ord</span></span>, the show that it is at least <span class="bracket"><span class="id">stack_needs</span></span>. </div>
<br/>
<span class="kwd">Fixpoint</span> <span class="id"><a name="stack_usage">stack_usage</a></span> (<span class="id">ord</span>: <span class="id"><a href="../SF/lf/Imp.html#aexp">aexp</a></span> -&gt; <span class="id"><a href="../SF/lf/Imp.html#aexp">aexp</a></span> -&gt; <span class="id"><a href="compiler.Compiler.html#eval_order">eval_order</a></span>) (<span class="id">a</span>: <span class="id"><a href="../SF/lf/Imp.html#aexp">aexp</a></span>) : <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id"><a href="compiler.Compiler.html#a">a</a></span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id"><a href="../SF/lf/Imp.html#ANum">ANum</a></span> <span class="id">n</span> =&gt; 1<br/>
&nbsp;&nbsp;| <span class="id"><a href="../SF/lf/Imp.html#AId">AId</a></span> <span class="id">v</span> =&gt; 1<br/>
&nbsp;&nbsp;| <span class="id"><a href="../SF/lf/Imp.html#APlus">APlus</a></span> <span class="id">a1</span> <span class="id">a2</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id"><a href="compiler.Compiler.html#ord">ord</a></span> <span class="id">a1</span> <span class="id">a2</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id"><a href="compiler.Compiler.html#LtoR">LtoR</a></span> =&gt; <span class="id"><a href="http://coq.inria.fr/library/Coq.Arith.Max.html#max">max</a></span> (<span class="id"><a href="compiler.Compiler.html#stack_usage">stack_usage</a></span> <span class="id"><a href="compiler.Compiler.html#ord">ord</a></span> <span class="id">a1</span>) (<span class="id"><a href="compiler.Compiler.html#stack_usage">stack_usage</a></span> <span class="id"><a href="compiler.Compiler.html#ord">ord</a></span> <span class="id">a2</span> + 1)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id"><a href="compiler.Compiler.html#RtoL">RtoL</a></span> =&gt; <span class="id"><a href="http://coq.inria.fr/library/Coq.Arith.Max.html#max">max</a></span> (<span class="id"><a href="compiler.Compiler.html#stack_usage">stack_usage</a></span> <span class="id"><a href="compiler.Compiler.html#ord">ord</a></span> <span class="id">a2</span>) (<span class="id"><a href="compiler.Compiler.html#stack_usage">stack_usage</a></span> <span class="id"><a href="compiler.Compiler.html#ord">ord</a></span> <span class="id">a1</span> + 1)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;| <span class="id"><a href="../SF/lf/Imp.html#AMinus">AMinus</a></span> <span class="id">a1</span> <span class="id">a2</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="http://coq.inria.fr/library/Coq.Arith.Max.html#max">max</a></span> (<span class="id"><a href="compiler.Compiler.html#stack_usage">stack_usage</a></span> <span class="id"><a href="compiler.Compiler.html#ord">ord</a></span> <span class="id">a1</span>) (<span class="id"><a href="compiler.Compiler.html#stack_usage">stack_usage</a></span> <span class="id"><a href="compiler.Compiler.html#ord">ord</a></span> <span class="id">a2</span> + 1)<br/>
&nbsp;&nbsp;| <span class="id"><a href="../SF/lf/Imp.html#AMult">AMult</a></span> <span class="id">a1</span> <span class="id">a2</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id"><a href="compiler.Compiler.html#ord">ord</a></span> <span class="id">a1</span> <span class="id">a2</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id"><a href="compiler.Compiler.html#LtoR">LtoR</a></span> =&gt; <span class="id"><a href="http://coq.inria.fr/library/Coq.Arith.Max.html#max">max</a></span> (<span class="id"><a href="compiler.Compiler.html#stack_usage">stack_usage</a></span> <span class="id"><a href="compiler.Compiler.html#ord">ord</a></span> <span class="id">a1</span>) (<span class="id"><a href="compiler.Compiler.html#stack_usage">stack_usage</a></span> <span class="id"><a href="compiler.Compiler.html#ord">ord</a></span> <span class="id">a2</span> + 1)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id"><a href="compiler.Compiler.html#RtoL">RtoL</a></span> =&gt; <span class="id"><a href="http://coq.inria.fr/library/Coq.Arith.Max.html#max">max</a></span> (<span class="id"><a href="compiler.Compiler.html#stack_usage">stack_usage</a></span> <span class="id"><a href="compiler.Compiler.html#ord">ord</a></span> <span class="id">a2</span>) (<span class="id"><a href="compiler.Compiler.html#stack_usage">stack_usage</a></span> <span class="id"><a href="compiler.Compiler.html#ord">ord</a></span> <span class="id">a1</span> + 1)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="stack_needs_is_optimal">stack_needs_is_optimal</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">ord</span> <span class="id">a</span>, <span class="id"><a href="compiler.Compiler.html#stack_needs">stack_needs</a></span> <span class="id"><a href="compiler.Compiler.html#a">a</a></span> &lt;= <span class="id"><a href="compiler.Compiler.html#stack_usage">stack_usage</a></span> <span class="id"><a href="compiler.Compiler.html#ord">ord</a></span> <span class="id"><a href="compiler.Compiler.html#a">a</a></span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof34')">Proof.</div>
<div class="proofscript" id="proof34">
&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span>Admitted.</div>
<br/>
<div class="doc">Useful tip: the tactic <span class="bracket"><span class="id">zify</span>; <span class="tactic">omega</span></span> works very well to prove
    arithmetic properties involving min and max operators. </div>
<br/>
<div class="doc">An optimal strategy (with respect to stack usage) is to always
  compute the biggest subexpression first: </div>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="optimal_ord">optimal_ord</a></span> (<span class="id">a1</span> <span class="id">a2</span>: <span class="id"><a href="../SF/lf/Imp.html#aexp">aexp</a></span>) :=<br/>
&nbsp;&nbsp;<span class="kwd">if</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Arith.Compare_dec.html#leb">leb</a></span> (<span class="id"><a href="compiler.Compiler.html#stack_needs">stack_needs</a></span> <span class="id"><a href="compiler.Compiler.html#a2">a2</a></span>) (<span class="id"><a href="compiler.Compiler.html#stack_needs">stack_needs</a></span> <span class="id"><a href="compiler.Compiler.html#a1">a1</a></span>) <span class="kwd">then</span> <span class="id"><a href="compiler.Compiler.html#LtoR">LtoR</a></span> <span class="kwd">else</span> <span class="id"><a href="compiler.Compiler.html#RtoL">RtoL</a></span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="compile_aexp_optimal">compile_aexp_optimal</a></span> (<span class="id">a</span>: <span class="id"><a href="../SF/lf/Imp.html#aexp">aexp</a></span>) : <span class="id"><a href="compiler.Compiler.html#code">code</a></span> :=<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#compile_aexp_gen">compile_aexp_gen</a></span> <span class="id"><a href="compiler.Compiler.html#optimal_ord">optimal_ord</a></span> <span class="id"><a href="compiler.Compiler.html#a">a</a></span>.<br/>
<br/>
<div class="doc">The intuition is simple: if one of the arguments, say <span class="bracket"><span class="id">a1</span></span>, has
  stack needs strictly less than the other, say <span class="bracket"><span class="id">a2</span></span>, evaluating <span class="bracket"><span class="id">a1</span></span>
  after <span class="bracket"><span class="id">a2</span></span>, with <span class="bracket"><span class="id">a2</span></span>'s value as additional entry on the stack,
  will use no more stack space than evaluating <span class="bracket"><span class="id">a2</span></span>.  So, evaluating
  <span class="bracket"><span class="id">a1</span> + <span class="id">a2</span></span> can be done with no extra space than evaluating just <span class="bracket"><span class="id">a2</span></span>.
  This would not be the case if we started with <span class="bracket"><span class="id">a1</span></span>, then evaluated <span class="bracket"><span class="id">a2</span></span>:
  in this case, one more stack slot would be needed. 
  If both arguments have the same stack needs, the two evaluation
  orders use exactly the same amount of space, so it does not matter
  which one we choose. </div>
<br/>
<div class="doc">We can show the optimality of the strategy by observing that 
  its stack usage is the minimum predicted by <span class="bracket"><span class="id">stack_needs</span></span>. </div>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="stack_usage_optimal_ord">stack_usage_optimal_ord</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">a</span>, <span class="id"><a href="compiler.Compiler.html#stack_usage">stack_usage</a></span> <span class="id"><a href="compiler.Compiler.html#optimal_ord">optimal_ord</a></span> <span class="id"><a href="compiler.Compiler.html#a">a</a></span> = <span class="id"><a href="compiler.Compiler.html#stack_needs">stack_needs</a></span> <span class="id"><a href="compiler.Compiler.html#a">a</a></span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof35')">Proof.</div>
<div class="proofscript" id="proof35">
&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span>Admitted.</div>
<br/>
<div class="doc">So far, we've reasoned informally on the stack usage of a particular
  evaluation strategy.  Now, let us formally connect this reasoning with the
  execution of the compiled code.  First, we need to instrument the
  virtual machine so that it monitors its stack usage and goes wrong
  if the stack size goes over a given maximum <span class="bracket"><span class="id">maxstack</span></span>. </div>
<br/>
<span class="kwd">Inductive</span> <span class="id"><a name="checked_transition">checked_transition</a></span> (<span class="id">C</span>: <span class="id"><a href="compiler.Compiler.html#code">code</a></span>) (<span class="id">maxstack</span>: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>) : <span class="id"><a href="compiler.Compiler.html#configuration">configuration</a></span> -&gt; <span class="id"><a href="compiler.Compiler.html#configuration">configuration</a></span> -&gt; <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id"><a name="ctrans">ctrans</a></span>: <span class="kwd">forall</span> <span class="id">pc</span> <span class="id">stk</span> <span class="id">s</span> <span class="id">pc</span>' <span class="id">stk</span>' <span class="id">s</span>',<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id">C</span> (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>, <span class="id"><a href="compiler.Compiler.html#s">s</a></span>) (<span class="id">pc</span>', <span class="id">stk</span>', <span class="id">s</span>') -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id">stk</span>' &lt;= <span class="id">maxstack</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#checked_transition">checked_transition</a></span> <span class="id">C</span> <span class="id">maxstack</span> (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>, <span class="id"><a href="compiler.Compiler.html#s">s</a></span>) (<span class="id">pc</span>', <span class="id">stk</span>', <span class="id">s</span>').<br/>
<br/>
<div class="doc">Now, we can state and prove the fact that the compiled code for
  expression <span class="bracket"><span class="id">a</span></span> with respect to a strategy <span class="bracket"><span class="id">ord</span></span> execute safely
  if at least <span class="bracket"><span class="id">stack_usage</span> <span class="id">ord</span> <span class="id">a</span></span> stack entries are available. </div>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="compile_aexp_gen_safe">compile_aexp_gen_safe</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">ord</span> <span class="id">C</span> <span class="id">maxstack</span> <span class="id">st</span> <span class="id">a</span> <span class="id">pc</span> <span class="id">stk</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#codeseq_at">codeseq_at</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> (<span class="id"><a href="compiler.Compiler.html#compile_aexp_gen">compile_aexp_gen</a></span> <span class="id"><a href="compiler.Compiler.html#ord">ord</a></span> <span class="id"><a href="compiler.Compiler.html#a">a</a></span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span> + <span class="id"><a href="compiler.Compiler.html#stack_usage">stack_usage</a></span> <span class="id"><a href="compiler.Compiler.html#ord">ord</a></span> <span class="id"><a href="compiler.Compiler.html#a">a</a></span> &lt;= <span class="id"><a href="compiler.Compiler.html#maxstack">maxstack</a></span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Sequences.html#star">star</a></span> (<span class="id"><a href="compiler.Compiler.html#checked_transition">checked_transition</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id"><a href="compiler.Compiler.html#maxstack">maxstack</a></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>, <span class="id"><a href="compiler.Compiler.html#st">st</a></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> (<span class="id"><a href="compiler.Compiler.html#compile_aexp_gen">compile_aexp_gen</a></span> <span class="id"><a href="compiler.Compiler.html#ord">ord</a></span> <span class="id"><a href="compiler.Compiler.html#a">a</a></span>), <span class="id"><a href="../SF/lf/Imp.html#aeval">aeval</a></span> <span class="id"><a href="compiler.Compiler.html#st">st</a></span> <span class="id"><a href="compiler.Compiler.html#a">a</a></span> :: <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>, <span class="id"><a href="compiler.Compiler.html#st">st</a></span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof36')">Proof.</div>
<div class="proofscript" id="proof36">
&nbsp;&nbsp;<span class="tactic">induction</span> <span class="id">a</span>; <span class="tactic">simpl</span>; <span class="tactic">intros</span>.<br/>
Admitted.</div>
<br/>
<div class="doc">Moreover, the size <span class="bracket"><span class="id">stack_usage</span> <span class="id">ord</span> <span class="id">a</span></span> is tight, in that there exists
  a point in the execution of the compiled code for <span class="bracket"><span class="id">a</span></span> where the stack
  is at least that big. </div>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="stack_usage_reached">stack_usage_reached</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">ord</span> <span class="id">C</span> <span class="id">st</span> <span class="id">a</span> <span class="id">pc</span> <span class="id">stk</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#codeseq_at">codeseq_at</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> (<span class="id"><a href="compiler.Compiler.html#compile_aexp_gen">compile_aexp_gen</a></span> <span class="id"><a href="compiler.Compiler.html#ord">ord</a></span> <span class="id"><a href="compiler.Compiler.html#a">a</a></span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">pc</span>', <span class="id">exists</span> <span class="id">stk</span>',<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Sequences.html#star">star</a></span> (<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span>) (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>, <span class="id"><a href="compiler.Compiler.html#st">st</a></span>) (<span class="id">pc</span>', <span class="id">stk</span>', <span class="id"><a href="compiler.Compiler.html#st">st</a></span>)<br/>
&nbsp;&nbsp;/\ <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id">stk</span>' &gt;= <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#length">length</a></span> <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span> + <span class="id"><a href="compiler.Compiler.html#stack_usage">stack_usage</a></span> <span class="id"><a href="compiler.Compiler.html#ord">ord</a></span> <span class="id"><a href="compiler.Compiler.html#a">a</a></span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof37')">Proof.</div>
<div class="proofscript" id="proof37">
&nbsp;&nbsp;<span class="tactic">induction</span> <span class="id">a</span>; <span class="tactic">simpl</span>; <span class="tactic">intros</span>.<br/>
&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span>Admitted.</div>
<br/>
<h3> Full project (5 stars) </h3>
<br/>
<span class="kwd">Module</span> <span class="id"><a name="StorelessMachine">StorelessMachine</a></span>.<br/>
<br/>
<div class="doc">The purpose of this project is to retarget the IMP compiler to a
  different, simpler virtual machine that has no store, just a stack
  that also supports direct accesses, i.e. reading or modifying the
  N-th entry of the stack.  Here is the instruction set of the machine:
</div>
<br/>
<span class="kwd">Inductive</span> <span class="id"><a name="StorelessMachine.instruction">instruction</a></span>: <span class="kwd">Type</span> :=<br/>
&nbsp;&nbsp;| <span class="id"><a name="StorelessMachine.Iconst">Iconst</a></span>(<span class="id">n</span>: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>)                 <span class="docright">(* push integer <span class="bracket"><span class="id">n</span></span> on stack  *)</span><br/>
&nbsp;&nbsp;| <span class="id"><a name="StorelessMachine.Iget">Iget</a></span>(<span class="id">n</span>: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>)                   <span class="docright">(* push the value of the <span class="bracket"><span class="id">n</span></span>-th stack slot  *)</span><br/>
&nbsp;&nbsp;| <span class="id"><a name="StorelessMachine.Iset">Iset</a></span>(<span class="id">n</span>: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>)                   <span class="docright">(* pop an integer, assign it to the <span class="bracket"><span class="id">n</span></span>-th stack slot  *)</span><br/>
&nbsp;&nbsp;| <span class="id"><a name="StorelessMachine.Iadd">Iadd</a></span>                           <span class="docright">(* pop <span class="bracket"><span class="id">n2</span></span>, pop <span class="bracket"><span class="id">n1</span></span>, push back <span class="bracket"><span class="id">n1</span>+<span class="id">n2</span></span>  *)</span><br/>
&nbsp;&nbsp;| <span class="id"><a name="StorelessMachine.Isub">Isub</a></span>                           <span class="docright">(* pop <span class="bracket"><span class="id">n2</span></span>, pop <span class="bracket"><span class="id">n1</span></span>, push back <span class="bracket"><span class="id">n1</span>-<span class="id">n2</span></span>  *)</span><br/>
&nbsp;&nbsp;| <span class="id"><a name="StorelessMachine.Imul">Imul</a></span>                           <span class="docright">(* pop <span class="bracket"><span class="id">n2</span></span>, pop <span class="bracket"><span class="id">n1</span></span>, push back <span class="bracket"><span class="id">n1</span>*<span class="id">n2</span></span>  *)</span><br/>
&nbsp;&nbsp;| <span class="id"><a name="StorelessMachine.Ibranch_forward">Ibranch_forward</a></span>(<span class="id">ofs</span>: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>)      <span class="docright">(* skip <span class="bracket"><span class="id">ofs</span></span> instructions forward  *)</span><br/>
&nbsp;&nbsp;| <span class="id"><a name="StorelessMachine.Ibranch_backward">Ibranch_backward</a></span>(<span class="id">ofs</span>: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>)     <span class="docright">(* skip <span class="bracket"><span class="id">ofs</span></span> instructions backward  *)</span><br/>
&nbsp;&nbsp;| <span class="id"><a name="StorelessMachine.Ibeq">Ibeq</a></span>(<span class="id">ofs</span>: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>)                 <span class="docright">(* pop <span class="bracket"><span class="id">n2</span></span>, pop <span class="bracket"><span class="id">n1</span></span>, skip <span class="bracket"><span class="id">ofs</span></span> forward if <span class="bracket"><span class="id">n1</span>=<span class="id">n2</span></span>  *)</span><br/>
&nbsp;&nbsp;| <span class="id"><a name="StorelessMachine.Ibne">Ibne</a></span>(<span class="id">ofs</span>: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>)                 <span class="docright">(* pop <span class="bracket"><span class="id">n2</span></span>, pop <span class="bracket"><span class="id">n1</span></span>, skip <span class="bracket"><span class="id">ofs</span></span> forward if <span class="bracket"><span class="id">n1</span>&lt;&gt;<span class="id">n2</span></span>  *)</span><br/>
&nbsp;&nbsp;| <span class="id"><a name="StorelessMachine.Ible">Ible</a></span>(<span class="id">ofs</span>: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>)                 <span class="docright">(* pop <span class="bracket"><span class="id">n2</span></span>, pop <span class="bracket"><span class="id">n1</span></span>, skip <span class="bracket"><span class="id">ofs</span></span> forward if <span class="bracket"><span class="id">n1</span>&lt;=<span class="id">n2</span></span>  *)</span><br/>
&nbsp;&nbsp;| <span class="id"><a name="StorelessMachine.Ibgt">Ibgt</a></span>(<span class="id">ofs</span>: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>)                 <span class="docright">(* pop <span class="bracket"><span class="id">n2</span></span>, pop <span class="bracket"><span class="id">n1</span></span>, skip <span class="bracket"><span class="id">ofs</span></span> forward if <span class="bracket"><span class="id">n1</span>&gt;<span class="id">n2</span></span>  *)</span><br/>
&nbsp;&nbsp;| <span class="id"><a name="StorelessMachine.Ihalt">Ihalt</a></span>.                         <span class="docright">(* terminate execution successfully  *)</span><br/>
<br/>
<div class="doc">The only difference with the original virtual machine is that the
  <span class="bracket"><span class="id">Ivar</span></span> and <span class="bracket"><span class="id">Isetvar</span></span> instructions (to access the store by
  identifier) are gone and replaced by <span class="bracket"><span class="id">Iget</span></span> and <span class="bracket"><span class="id">Iset</span></span> instructions
  (to access the stack by position). </div>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="StorelessMachine.code">code</a></span> := <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#list">list</a></span> <span class="id"><a href="compiler.Compiler.html#StorelessMachine.instruction">instruction</a></span>.<br/>
<span class="kwd">Definition</span> <span class="id"><a name="StorelessMachine.stack">stack</a></span> := <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#list">list</a></span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>.<br/>
<span class="kwd">Definition</span> <span class="id"><a name="StorelessMachine.configuration">configuration</a></span> := (<span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span> * <span class="id"><a href="compiler.Compiler.html#StorelessMachine.stack">stack</a></span>)%<span class="id">type</span>.<br/>
<br/>
<span class="kwd">Fixpoint</span> <span class="id"><a name="StorelessMachine.code_at">code_at</a></span> (<span class="id">C</span>: <span class="id"><a href="compiler.Compiler.html#StorelessMachine.code">code</a></span>) (<span class="id">pc</span>: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>) : <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#option">option</a></span> <span class="id"><a href="compiler.Compiler.html#StorelessMachine.instruction">instruction</a></span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span>, <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span>, <span class="id">_</span> =&gt; <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#None">None</a></span><br/>
&nbsp;&nbsp;| <span class="id">i</span> :: <span class="id">C</span>', <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#O">O</a></span> =&gt; <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">i</span><br/>
&nbsp;&nbsp;| <span class="id">i</span> :: <span class="id">C</span>', <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#S">S</a></span> <span class="id">pc</span>' =&gt; <span class="id"><a href="compiler.Compiler.html#code_at">code_at</a></span> <span class="id">C</span>' <span class="id">pc</span>'<br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<div class="doc">To give semantics to the <span class="bracket"><span class="id">Iget</span></span> and <span class="bracket"><span class="id">Iset</span></span> instructions, start by
  defining two stack-manipulating functions, such that
<pre>
     get_nth_slot (v0 :: ... :: vN :: ...) N = Some vN
     set_nth_slot (v0 :: ... :: vN :: ...) N v' = Some (v0 :: ... :: v' :: ...)</pre>
</div>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="StorelessMachine.get_nth_slot">get_nth_slot</a></span> (<span class="id">s</span>: <span class="id"><a href="compiler.Compiler.html#StorelessMachine.stack">stack</a></span>) (<span class="id">n</span>: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>) : <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#option">option</a></span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span> :=<br/>
&nbsp;&nbsp;<span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#None">None</a></span>. <br/>
<br/>
<span class="kwd">Fixpoint</span> <span class="id"><a name="StorelessMachine.set_nth_slot">set_nth_slot</a></span> (<span class="id">s</span>: <span class="id"><a href="compiler.Compiler.html#StorelessMachine.stack">stack</a></span>) (<span class="id">n</span>: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>) (<span class="id">v</span>: <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>) : <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#option">option</a></span> <span class="id"><a href="compiler.Compiler.html#StorelessMachine.stack">stack</a></span> :=<br/>
&nbsp;&nbsp;<span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#None">None</a></span>. <br/>
<br/>
<div class="doc">Then, the semantics of the machine is given by the following transition
  relation.  Note that machine states are just pairs of a program counter
  and a stack.  Note also that many transitions are exactly those of
  the original machine after erasing the store component of the state. </div>
<br/>
<span class="kwd">Inductive</span> <span class="id"><a name="StorelessMachine.transition">transition</a></span> (<span class="id">C</span>: <span class="id"><a href="compiler.Compiler.html#StorelessMachine.code">code</a></span>): <span class="id"><a href="compiler.Compiler.html#StorelessMachine.configuration">configuration</a></span> -&gt; <span class="id"><a href="compiler.Compiler.html#StorelessMachine.configuration">configuration</a></span> -&gt; <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id"><a name="StorelessMachine.trans_const">trans_const</a></span>: <span class="kwd">forall</span> <span class="id">pc</span> <span class="id">stk</span> <span class="id">n</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#StorelessMachine.code_at">code_at</a></span> <span class="id">C</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span>(<span class="id"><a href="compiler.Compiler.html#StorelessMachine.Iconst">Iconst</a></span> <span class="id"><a href="compiler.Compiler.html#n">n</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id">C</span> (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>) (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + 1, <span class="id"><a href="compiler.Compiler.html#n">n</a></span> :: <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>)<br/>
&nbsp;&nbsp;| <span class="id"><a name="StorelessMachine.trans_get">trans_get</a></span>: <span class="kwd">forall</span> <span class="id">pc</span> <span class="id">stk</span> <span class="id">n</span> <span class="id">v</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#StorelessMachine.code_at">code_at</a></span> <span class="id">C</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span>(<span class="id"><a href="compiler.Compiler.html#StorelessMachine.Iget">Iget</a></span> <span class="id"><a href="compiler.Compiler.html#n">n</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#StorelessMachine.get_nth_slot">get_nth_slot</a></span> <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span> <span class="id"><a href="compiler.Compiler.html#n">n</a></span> = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id"><a href="compiler.Compiler.html#v">v</a></span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id">C</span> (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>) (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + 1, <span class="id"><a href="compiler.Compiler.html#v">v</a></span> :: <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>)<br/>
&nbsp;&nbsp;| <span class="id"><a name="StorelessMachine.trans_set">trans_set</a></span>: <span class="kwd">forall</span> <span class="id">pc</span> <span class="id">stk</span> <span class="id">n</span> <span class="id">v</span> <span class="id">stk</span>',<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#StorelessMachine.code_at">code_at</a></span> <span class="id">C</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span>(<span class="id"><a href="compiler.Compiler.html#StorelessMachine.Iset">Iset</a></span> <span class="id"><a href="compiler.Compiler.html#n">n</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#StorelessMachine.set_nth_slot">set_nth_slot</a></span> <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span> <span class="id"><a href="compiler.Compiler.html#n">n</a></span> <span class="id"><a href="compiler.Compiler.html#v">v</a></span> = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">stk</span>' -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id">C</span> (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="compiler.Compiler.html#v">v</a></span> :: <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>) (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + 1, <span class="id">stk</span>')<br/>
&nbsp;&nbsp;| <span class="id"><a name="StorelessMachine.trans_add">trans_add</a></span>: <span class="kwd">forall</span> <span class="id">pc</span> <span class="id">stk</span> <span class="id">n1</span> <span class="id">n2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#StorelessMachine.code_at">code_at</a></span> <span class="id">C</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span>(<span class="id"><a href="compiler.Compiler.html#StorelessMachine.Iadd">Iadd</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id">C</span> (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="compiler.Compiler.html#n2">n2</a></span> :: <span class="id"><a href="compiler.Compiler.html#n1">n1</a></span> :: <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>) (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + 1, (<span class="id"><a href="compiler.Compiler.html#n1">n1</a></span> + <span class="id"><a href="compiler.Compiler.html#n2">n2</a></span>) :: <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>)<br/>
&nbsp;&nbsp;| <span class="id"><a name="StorelessMachine.trans_sub">trans_sub</a></span>: <span class="kwd">forall</span> <span class="id">pc</span> <span class="id">stk</span> <span class="id">n1</span> <span class="id">n2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#StorelessMachine.code_at">code_at</a></span> <span class="id">C</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span>(<span class="id"><a href="compiler.Compiler.html#StorelessMachine.Isub">Isub</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id">C</span> (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="compiler.Compiler.html#n2">n2</a></span> :: <span class="id"><a href="compiler.Compiler.html#n1">n1</a></span> :: <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>) (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + 1, (<span class="id"><a href="compiler.Compiler.html#n1">n1</a></span> - <span class="id"><a href="compiler.Compiler.html#n2">n2</a></span>) :: <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>)<br/>
&nbsp;&nbsp;| <span class="id"><a name="StorelessMachine.trans_mul">trans_mul</a></span>: <span class="kwd">forall</span> <span class="id">pc</span> <span class="id">stk</span> <span class="id">n1</span> <span class="id">n2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#StorelessMachine.code_at">code_at</a></span> <span class="id">C</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span>(<span class="id"><a href="compiler.Compiler.html#StorelessMachine.Imul">Imul</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id">C</span> (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="compiler.Compiler.html#n2">n2</a></span> :: <span class="id"><a href="compiler.Compiler.html#n1">n1</a></span> :: <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>) (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + 1, (<span class="id"><a href="compiler.Compiler.html#n1">n1</a></span> * <span class="id"><a href="compiler.Compiler.html#n2">n2</a></span>) :: <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>)<br/>
&nbsp;&nbsp;| <span class="id"><a name="StorelessMachine.trans_branch_forward">trans_branch_forward</a></span>: <span class="kwd">forall</span> <span class="id">pc</span> <span class="id">stk</span> <span class="id">ofs</span> <span class="id">pc</span>',<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#StorelessMachine.code_at">code_at</a></span> <span class="id">C</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span>(<span class="id"><a href="compiler.Compiler.html#StorelessMachine.Ibranch_forward">Ibranch_forward</a></span> <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">pc</span>' = <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + 1 + <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id">C</span> (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>) (<span class="id">pc</span>', <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>)<br/>
&nbsp;&nbsp;| <span class="id"><a name="StorelessMachine.trans_branch_backward">trans_branch_backward</a></span>: <span class="kwd">forall</span> <span class="id">pc</span> <span class="id">stk</span> <span class="id">ofs</span> <span class="id">pc</span>',<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#StorelessMachine.code_at">code_at</a></span> <span class="id">C</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span>(<span class="id"><a href="compiler.Compiler.html#StorelessMachine.Ibranch_backward">Ibranch_backward</a></span> <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">pc</span>' = <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + 1 - <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id">C</span> (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>) (<span class="id">pc</span>', <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>)<br/>
&nbsp;&nbsp;| <span class="id"><a name="StorelessMachine.trans_beq">trans_beq</a></span>: <span class="kwd">forall</span> <span class="id">pc</span> <span class="id">stk</span> <span class="id">ofs</span> <span class="id">n1</span> <span class="id">n2</span> <span class="id">pc</span>',<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#StorelessMachine.code_at">code_at</a></span> <span class="id">C</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span>(<span class="id"><a href="compiler.Compiler.html#StorelessMachine.Ibeq">Ibeq</a></span> <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">pc</span>' = (<span class="kwd">if</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Arith.EqNat.html#beq_nat">beq_nat</a></span> <span class="id"><a href="compiler.Compiler.html#n1">n1</a></span> <span class="id"><a href="compiler.Compiler.html#n2">n2</a></span> <span class="kwd">then</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + 1 + <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span> <span class="kwd">else</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + 1) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id">C</span> (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="compiler.Compiler.html#n2">n2</a></span> :: <span class="id"><a href="compiler.Compiler.html#n1">n1</a></span> :: <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>) (<span class="id">pc</span>', <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>)<br/>
&nbsp;&nbsp;| <span class="id"><a name="StorelessMachine.trans_bne">trans_bne</a></span>: <span class="kwd">forall</span> <span class="id">pc</span> <span class="id">stk</span> <span class="id">ofs</span> <span class="id">n1</span> <span class="id">n2</span> <span class="id">pc</span>',<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#StorelessMachine.code_at">code_at</a></span> <span class="id">C</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span>(<span class="id"><a href="compiler.Compiler.html#StorelessMachine.Ibne">Ibne</a></span> <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">pc</span>' = (<span class="kwd">if</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Arith.EqNat.html#beq_nat">beq_nat</a></span> <span class="id"><a href="compiler.Compiler.html#n1">n1</a></span> <span class="id"><a href="compiler.Compiler.html#n2">n2</a></span> <span class="kwd">then</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + 1 <span class="kwd">else</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + 1 + <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id">C</span> (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="compiler.Compiler.html#n2">n2</a></span> :: <span class="id"><a href="compiler.Compiler.html#n1">n1</a></span> :: <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>) (<span class="id">pc</span>', <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>)<br/>
&nbsp;&nbsp;| <span class="id"><a name="StorelessMachine.trans_ble">trans_ble</a></span>: <span class="kwd">forall</span> <span class="id">pc</span> <span class="id">stk</span> <span class="id">ofs</span> <span class="id">n1</span> <span class="id">n2</span> <span class="id">pc</span>',<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#StorelessMachine.code_at">code_at</a></span> <span class="id">C</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span>(<span class="id"><a href="compiler.Compiler.html#StorelessMachine.Ible">Ible</a></span> <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">pc</span>' = (<span class="kwd">if</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Arith.Compare_dec.html#leb">leb</a></span> <span class="id"><a href="compiler.Compiler.html#n1">n1</a></span> <span class="id"><a href="compiler.Compiler.html#n2">n2</a></span> <span class="kwd">then</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + 1 + <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span> <span class="kwd">else</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + 1) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id">C</span> (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="compiler.Compiler.html#n2">n2</a></span> :: <span class="id"><a href="compiler.Compiler.html#n1">n1</a></span> :: <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>) (<span class="id">pc</span>', <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>)<br/>
&nbsp;&nbsp;| <span class="id"><a name="StorelessMachine.trans_bgt">trans_bgt</a></span>: <span class="kwd">forall</span> <span class="id">pc</span> <span class="id">stk</span> <span class="id">ofs</span> <span class="id">n1</span> <span class="id">n2</span> <span class="id">pc</span>',<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#StorelessMachine.code_at">code_at</a></span> <span class="id">C</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span>(<span class="id"><a href="compiler.Compiler.html#StorelessMachine.Ibgt">Ibgt</a></span> <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">pc</span>' = (<span class="kwd">if</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Arith.Compare_dec.html#leb">leb</a></span> <span class="id"><a href="compiler.Compiler.html#n1">n1</a></span> <span class="id"><a href="compiler.Compiler.html#n2">n2</a></span> <span class="kwd">then</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + 1 <span class="kwd">else</span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> + 1 + <span class="id"><a href="compiler.Compiler.html#ofs">ofs</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#transition">transition</a></span> <span class="id">C</span> (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="compiler.Compiler.html#n2">n2</a></span> :: <span class="id"><a href="compiler.Compiler.html#n1">n1</a></span> :: <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>) (<span class="id">pc</span>', <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span>).<br/>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="StorelessMachine.mach_terminates">mach_terminates</a></span> (<span class="id">C</span>: <span class="id"><a href="compiler.Compiler.html#StorelessMachine.code">code</a></span>) (<span class="id">stk_init</span> <span class="id">stk_fin</span>: <span class="id"><a href="compiler.Compiler.html#StorelessMachine.stack">stack</a></span>) :=<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">pc</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#StorelessMachine.code_at">code_at</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span> <span class="id"><a href="compiler.Compiler.html#pc">pc</a></span> = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id"><a href="compiler.Compiler.html#StorelessMachine.Ihalt">Ihalt</a></span> /\<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Sequences.html#star">star</a></span> (<span class="id"><a href="compiler.Compiler.html#StorelessMachine.transition">transition</a></span> <span class="id"><a href="compiler.Compiler.html#C">C</a></span>) (0, <span class="id"><a href="compiler.Compiler.html#stk_init">stk_init</a></span>) (<span class="id"><a href="compiler.Compiler.html#pc">pc</a></span>, <span class="id"><a href="compiler.Compiler.html#stk_fin">stk_fin</a></span>).<br/>
<br/>
<div class="doc">Now it's your turn: define a compilation scheme from IMP programs
    to machine code and prove its correctness w.r.t. terminating executions,
    as stated below. </div>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="StorelessMachine.compile_program">compile_program</a></span> (<span class="id">c</span>: <span class="id"><a href="../SF/lf/Imp.html#com">com</a></span>) : <span class="id"><a href="compiler.Compiler.html#StorelessMachine.code">code</a></span> := <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span>. <br/>
<br/>
<span class="kwd">Theorem</span> <span class="id"><a name="StorelessMachine.compile_program_correct_terminating">compile_program_correct_terminating</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">c</span> <span class="id">st</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#c">c</a></span> / <span class="id"><a href="../SF/lf/Imp.html#empty_state">empty_state</a></span> \\ <span class="id"><a href="compiler.Compiler.html#st">st</a></span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">stk</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compiler.Compiler.html#StorelessMachine.mach_terminates">mach_terminates</a></span> (<span class="id"><a href="compiler.Compiler.html#StorelessMachine.compile_program">compile_program</a></span> <span class="id"><a href="compiler.Compiler.html#c">c</a></span>) <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span> <span class="id"><a href="compiler.Compiler.html#stk">stk</a></span><br/>
&nbsp;&nbsp;/\ <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Logic.html#True">True</a></span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof38')">Proof.</div>
<div class="proofscript" id="proof38">
&nbsp;Have&nbsp;fun!&nbsp;*)</span>Admitted.</div>
<br/>
<div class="doc">The <span class="bracket"><span class="id">True</span></span> above is to be replaced by some informative relation between
  the final stack <span class="bracket"><span class="id">stk</span></span> and the final store <span class="bracket"><span class="id">st</span></span>. </div>
<br/>
<div class="doc">Some hints to get you started.  Clearly, we need to use a portion of
  the stack to hold the current values for the program variables.  It may
  seem impossible to represent a store (a function from identifiers to values,
  giving gives values to infinitely many variables) as a stack (a finite
  list of values).  However, only the variables that are ever assigned to
  within the program need to be associated with a stack slot: all
  other variables keep their initial value of 0 throughout the program
  execution. </div>
<br/>
<div class="doc"> Hence, the first order of business is to construct a list of
  variables that are ever assigned in the program, and, from this
  list, to assign a position in the stack for every such variable.
  For example, if the list of assigned variables is <span class="bracket">["<span class="id">x</span>";"<span class="id">y</span>";"<span class="id">z</span>"]</span>
  we could say that the value of <span class="bracket">"<span class="id">x</span>"</span> is at the top of the stack,
  the value of <span class="bracket">"<span class="id">y</span>"</span> one slot below, and that of <span class="bracket">"<span class="id">z</span>"</span> two slots below.
  Those offsets need adjusting during the evaluation of expressions,
  because intermediate results are pushed on the stack on top of the
  values of variables. </div>
<br/>
<div class="doc"> Using this information, the compilation of an expression <span class="bracket"><span class="id">AId</span> <span class="id">id</span></span> is
  either <span class="bracket"><span class="id">Iconst</span> 0</span> if the variable is not assigned in the program,
  or, <span class="bracket"><span class="id">Iget</span> <span class="id">N</span></span> otherwise, for a stack distance <span class="bracket"><span class="id">N</span></span> that reflects the
  stack position of variable <span class="bracket"><span class="id">id</span></span>. </div>
<br/>
<div class="doc">To state and prove semantic preservation for the compilation functions,
  you will need a predicate <span class="bracket"><span class="id">agree</span> <span class="id">st</span> <span class="id">stk</span></span> that relates an IMP store <span class="bracket"><span class="id">st</span></span>
  with a machine stack <span class="bracket"><span class="id">stk</span></span>.  Typically, it will say that
<ul>
<li>
 <span class="bracket"><span class="id">st</span> <span class="id">x</span> = 0</span> for all non-assigned variables <span class="bracket"><span class="id">x</span></span>
</li>
<li>
 <span class="bracket"><span class="id">get_nth_slot</span> <span class="id">stk</span> <span class="id">N</span> = <span class="id">Some</span> (<span class="id">st</span> <span class="id">x</span>)</span> if <span class="bracket"><span class="id">N</span></span> is the stack offset for variable <span class="bracket"><span class="id">x</span></span>
</li>
</ul>
  The predicate <span class="bracket"><span class="id">agree</span> <span class="id">st</span> <span class="id">stk</span></span> acts both as a pre- and a post-condition, e.g.
<pre>
Lemma compile_com_correct_terminating:
  forall C st c st',
  c / st \\ st' -&gt;
  forall stk pc,
  codeseq_at C pc (compile_com c) -&gt;
  agree st stk -&gt;
  exists stk',
     star (transition C) (pc, stk) (pc + length (compile_com c), stk')
  /\ agree st' stk'.</pre>
</div>
<br/>
<span class="kwd">End</span> <span class="id"><a href="compiler.Compiler.html#StorelessMachine">StorelessMachine</a></span>.<br/>

</div>
<div class="footer"><hr/>Generated by <a href="https://github.com/xavierleroy/coq2html/">coq2html</div>
</body>
</html>
