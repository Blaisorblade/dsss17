<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<link href="common/css/sf.css" rel="stylesheet" type="text/css"/>
<title>ListCFG</title>
</head>
<link href="common/jquery-ui/jquery-ui.css" rel="stylesheet">
<script src="common/jquery-ui/external/jquery/jquery.js"></script>
<script src="common/jquery-ui/jquery-ui.js"></script>
<script src="common/toggleproofs.js"></script>
<link href="common/css/lf.css" rel="stylesheet" type="text/css"/>

<body>

<div id="page">

<div id="header">
<a href='https://www.cis.upenn.edu/~bcpierce/sf/current/index.html'>
<img src='common/media/image/sf_logo_sm.png'></a>
<ul id='menu'>
   <a href='index.html'><li class='section_name'>VMinus Development</li></a>
   <a href='toc.html'><li>Table of Contents</li></a>
   <a href='coqindex.html'><li>Index</li></a>
   <a href='deps.html'><li>Roadmap</li></a>
</ul>
</div>

<div id="main">

<h1 class="libtitle">ListCFG</h1>


<div class="doc">
<a name="lab38"></a><h1 class="section">List-based CFG Implementation</h1>

<div class="paragraph"> </div>

  One possible implementation of cfgs 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Module</span> <span class="id" type="var">ListCFG</span> &lt;: <span class="id" type="var">CFG</span>.<br/>
</div>

<div class="doc">
Blocks are labels paired with lists of instructions. 
</div>
<div class="code code-tight">

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Definition</span> <span class="id" type="var">block</span> := (<span class="id" type="var">lbl</span> * <span class="id" type="var">list</span> <span class="id" type="var">insn</span>)%<span class="id" type="var">type</span>.<br/>
</div>

<div class="doc">
A control-flow graph is an entry label with a list of blocks. 
</div>
<div class="code code-tight">

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Definition</span> <span class="id" type="var">t</span> := (<span class="id" type="var">lbl</span> * <span class="id" type="var">list</span> <span class="id" type="var">block</span>)%<span class="id" type="var">type</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Local</span> <span class="id" type="keyword">Notation</span> <span class="id" type="var">cfg</span> := <span class="id" type="var">t</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Definition</span> <span class="id" type="var">entry_block</span> : <span class="id" type="var">cfg</span> → <span class="id" type="var">lbl</span> := @<span class="id" type="var">fst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>.<br/>
</div>

<div class="doc">
<hr/>
 <a name="lab39"></a><h1 class="section">Syntactically Well-formed ListCFGs</h1>

<div class="paragraph"> </div>


<div class="paragraph"> </div>

<ul class="doclist">
<li> no duplicate block names

</li>
<li> no duplicate instruction ids  (i.e. <i>single assignment</i> )

</li>
<li> there is an entry label to the CFG

</li>
<li> there are no empty blocks

</li>
</ul>

<div class="paragraph"> </div>

   
</div>
<div class="code code-tight">

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Inductive</span> <span class="id" type="var">wf_cfg'</span> : <span class="id" type="var">cfg</span> → <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">wf_cfg_intro</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;∀ <span class="id" type="var">l</span> <span class="id" type="var">bs</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">Hlbls</span>: <span class="id" type="var">NoDup</span> (<span class="id" type="var">map</span> (@<span class="id" type="var">fst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">bs</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">Huids</span>: <span class="id" type="var">NoDup</span> (<span class="id" type="var">flat_map</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">b</span> ⇒ <span class="id" type="var">map</span> (@<span class="id" type="var">fst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) (<span class="id" type="var">snd</span> <span class="id" type="var">b</span>)) <span class="id" type="var">bs</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">Hentry</span>: <span class="id" type="var">In</span> <span class="id" type="var">l</span> (<span class="id" type="var">map</span> (@<span class="id" type="var">fst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">bs</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">Hnonnil</span>: ¬ <span class="id" type="var">In</span> [] (<span class="id" type="var">map</span> (@<span class="id" type="var">snd</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">bs</span>)),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">wf_cfg'</span> (<span class="id" type="var">l</span>, <span class="id" type="var">bs</span>).<br/>

<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;hack&nbsp;around&nbsp;some&nbsp;Coq&nbsp;limitation&nbsp;re&nbsp;inductive&nbsp;types&nbsp;&amp;&nbsp;parameters&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">Definition</span> <span class="id" type="var">wf_cfg</span> := <span class="id" type="var">wf_cfg'</span>.<br/>

<br/>
</div>

<div class="doc">
<hr/>
 <a name="lab40"></a><h2 class="section">Implementing the interface requirements:</h2>

</div>
<div class="code code-space">

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Definition</span> <span class="id" type="var">wf_pc</span> (<span class="id" type="var">g</span>:<span class="id" type="var">cfg</span>) (<span class="id" type="var">p</span>:<span class="id" type="var">pc</span>) : <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">let</span> (<span class="id" type="var">l</span>, <span class="id" type="var">n</span>) := <span class="id" type="var">p</span> <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;∃ <span class="id" type="var">is</span> <span class="id" type="var">i</span>, <span class="id" type="var">In</span> (<span class="id" type="var">l</span>, <span class="id" type="var">is</span>) (<span class="id" type="var">snd</span> <span class="id" type="var">g</span>) ∧ <span class="id" type="var">Nth</span> <span class="id" type="var">i</span> <span class="id" type="var">is</span> <span class="id" type="var">n</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Definition</span> <span class="id" type="var">tmn_pc</span> (<span class="id" type="var">g</span>:<span class="id" type="var">cfg</span>) (<span class="id" type="var">p</span>:<span class="id" type="var">pc</span>) : <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">let</span> (<span class="id" type="var">l</span>, <span class="id" type="var">n</span>) := <span class="id" type="var">p</span> <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;∃ <span class="id" type="var">is</span>, <span class="id" type="var">In</span> (<span class="id" type="var">l</span>, <span class="id" type="var">is</span>) (<span class="id" type="var">snd</span> <span class="id" type="var">g</span>) ∧ <span class="id" type="var">n</span> = <span class="id" type="var">pred</span> (<span class="id" type="var">length</span> <span class="id" type="var">is</span>).<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Definition</span> <span class="id" type="var">insn_at_pc</span> (<span class="id" type="var">g</span>:<span class="id" type="var">cfg</span>) (<span class="id" type="var">p</span>:<span class="id" type="var">pc</span>) (<span class="id" type="var">i</span>:<span class="id" type="var">insn</span>) : <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">let</span> (<span class="id" type="var">l</span>, <span class="id" type="var">n</span>) := <span class="id" type="var">p</span> <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;∃ <span class="id" type="var">is</span>, <span class="id" type="var">In</span> (<span class="id" type="var">l</span>, <span class="id" type="var">is</span>) (<span class="id" type="var">snd</span> <span class="id" type="var">g</span>) ∧ <span class="id" type="var">Nth</span> <span class="id" type="var">i</span> <span class="id" type="var">is</span> <span class="id" type="var">n</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Definition</span> <span class="id" type="var">uid_at_pc</span> (<span class="id" type="var">g</span>:<span class="id" type="var">cfg</span>) (<span class="id" type="var">p</span>:<span class="id" type="var">pc</span>) (<span class="id" type="var">uid</span>:<span class="id" type="var">uid</span>) : <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;∃ <span class="id" type="var">c</span>, <span class="id" type="var">insn_at_pc</span> <span class="id" type="var">g</span> <span class="id" type="var">p</span> (<span class="id" type="var">uid</span>, <span class="id" type="var">c</span>).<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">wf_pc_insn</span> : ∀ <span class="id" type="var">g</span>, <span class="id" type="var">wf_cfg</span> <span class="id" type="var">g</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;∀ <span class="id" type="var">p</span>, <span class="id" type="var">wf_pc</span> <span class="id" type="var">g</span> <span class="id" type="var">p</span> → ∃ <span class="id" type="var">i</span>, <span class="id" type="var">insn_at_pc</span> <span class="id" type="var">g</span> <span class="id" type="var">p</span> <span class="id" type="var">i</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">wf_pc</span>, <span class="id" type="var">insn_at_pc</span>. <span class="id" type="tactic">destruct</span> <span class="id" type="var">p</span>; <span class="id" type="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">decompose</span> [<span class="id" type="var">ex</span> <span class="id" type="var">and</span>] <span class="id" type="var">H<sub>0</sub></span>. <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">wf_pc_tmn</span> : ∀ <span class="id" type="var">g</span>, <span class="id" type="var">wf_cfg</span> <span class="id" type="var">g</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;∀ <span class="id" type="var">p</span>, <span class="id" type="var">wf_pc</span> <span class="id" type="var">g</span> <span class="id" type="var">p</span> → ∃ <span class="id" type="var">p'</span>, <span class="id" type="var">tmn_pc</span> <span class="id" type="var">g</span> <span class="id" type="var">p'</span> ∧ <span class="id" type="var">le_pc</span> <span class="id" type="var">p</span> <span class="id" type="var">p'</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
<div class="togglescript" id="proofcontrol1" onclick="toggleDisplay('proof1');toggleDisplay('proofcontrol1')"><span class="show"></span></div>
<div class="proofscript" id="proof1" onclick="toggleDisplay('proof1');toggleDisplay('proofcontrol1')">

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">wf_pc</span>, <span class="id" type="var">tmn_pc</span>. <span class="id" type="tactic">destruct</span> <span class="id" type="var">p</span>. <span class="id" type="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">decompose</span> [<span class="id" type="var">ex</span> <span class="id" type="var">and</span>] <span class="id" type="var">H<sub>0</sub></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;∃ (<span class="id" type="var">t<sub>0</sub></span>, <span class="id" type="var">pred</span> (<span class="id" type="var">length</span> <span class="id" type="var">x</span>)). <span class="id" type="tactic">split</span>. <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">constructor</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">PeanoNat.Nat.lt_le_pred</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">Nth_length</span>; <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Helper&nbsp;lemma:&nbsp;blocks&nbsp;have&nbsp;non-zero&nbsp;length.&nbsp;*)</span><br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">wf_cfg_block_len</span> : ∀ <span class="id" type="var">g</span>, <span class="id" type="var">wf_cfg</span> <span class="id" type="var">g</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;∀ <span class="id" type="var">l</span> <span class="id" type="var">is</span>, <span class="id" type="var">In</span> (<span class="id" type="var">l</span>, <span class="id" type="var">is</span>) (<span class="id" type="var">snd</span> <span class="id" type="var">g</span>) → <span class="id" type="var">length</span> <span class="id" type="var">is</span> ≠ 0.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> 1. <span class="id" type="tactic">intros</span> <span class="id" type="var">l<sub>0</sub></span> <span class="id" type="var">is</span> <span class="id" type="var">H<sub>1</sub></span>. <span class="id" type="tactic">destruct</span> <span class="id" type="var">is</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">contradict</span> <span class="id" type="var">Hnonnil</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">in_map</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">f</span>:=@<span class="id" type="var">snd</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="keyword">in</span> <span class="id" type="var">H<sub>1</sub></span>. <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">wf_pc_le_tmn</span> : ∀ <span class="id" type="var">g</span>, <span class="id" type="var">wf_cfg</span> <span class="id" type="var">g</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;∀ <span class="id" type="var">p'</span>, <span class="id" type="var">tmn_pc</span> <span class="id" type="var">g</span> <span class="id" type="var">p'</span> → ∀ <span class="id" type="var">p</span>, <span class="id" type="var">le_pc</span> <span class="id" type="var">p</span> <span class="id" type="var">p'</span> → <span class="id" type="var">wf_pc</span> <span class="id" type="var">g</span> <span class="id" type="var">p</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
<div class="togglescript" id="proofcontrol2" onclick="toggleDisplay('proof2');toggleDisplay('proofcontrol2')"><span class="show"></span></div>
<div class="proofscript" id="proof2" onclick="toggleDisplay('proof2');toggleDisplay('proofcontrol2')">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">wf_pc</span>, <span class="id" type="var">tmn_pc</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">g</span> <span class="id" type="var">H</span> <span class="id" type="var">p'</span> <span class="id" type="var">H<sub>0</sub></span> <span class="id" type="var">p</span> <span class="id" type="var">H<sub>1</sub></span>. <span class="id" type="tactic">destruct</span> <span class="id" type="var">p</span>, <span class="id" type="var">p'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">decompose</span> [<span class="id" type="var">ex</span> <span class="id" type="var">and</span>] <span class="id" type="var">H<sub>0</sub></span>. ∃ <span class="id" type="var">x</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">x</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">wf_cfg_block_len</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H<sub>3</sub></span>; <span class="id" type="tactic">auto</span>. <span class="id" type="var">contradict</span> <span class="id" type="var">H<sub>3</sub></span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H<sub>1</sub></span>; <span class="id" type="tactic">subst</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">le_lt_n_Sm</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H<sub>5</sub></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">erewrite</span> &lt;- <span class="id" type="var">S_pred</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H<sub>5</sub></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">length_Nth</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H<sub>5</sub></span> <span class="id" type="keyword">as</span> [? ?].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">eexists</span>. <span class="id" type="tactic">split</span>; <span class="id" type="tactic">eauto</span>. <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">wf_entry</span> : ∀ <span class="id" type="var">g</span>, <span class="id" type="var">wf_cfg</span> <span class="id" type="var">g</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">wf_pc</span> <span class="id" type="var">g</span> (<span class="id" type="var">block_entry</span> (<span class="id" type="var">entry_block</span> <span class="id" type="var">g</span>)).<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
<div class="togglescript" id="proofcontrol3" onclick="toggleDisplay('proof3');toggleDisplay('proofcontrol3')"><span class="show"></span></div>
<div class="proofscript" id="proof3" onclick="toggleDisplay('proof3');toggleDisplay('proofcontrol3')">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">wf_pc</span>. <span class="id" type="tactic">inversion</span> 1. <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">in_map_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hentry</span> <span class="id" type="keyword">as</span> [[? ?] [? ?]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">l<sub>0</sub></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">exfalso</span>. <span class="id" type="var">pose</span> <span class="id" type="var">proof</span> (<span class="id" type="var">wf_cfg_block_len</span> <span class="id" type="var">g</span> <span class="id" type="var">H</span> <span class="id" type="var">t<sub>0</sub></span> []) <span class="id" type="keyword">as</span> <span class="id" type="var">contra</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">g</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> *. <span class="id" type="tactic">apply</span> <span class="id" type="var">contra</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">eexists</span>. <span class="id" type="var">eexists</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> *. <span class="id" type="tactic">subst</span> <span class="id" type="var">l</span>. <span class="id" type="tactic">split</span>; <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">insn_at_pc_func</span> : ∀ <span class="id" type="var">g</span>, <span class="id" type="var">wf_cfg</span> <span class="id" type="var">g</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">functional</span> (<span class="id" type="var">insn_at_pc</span> <span class="id" type="var">g</span>).<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
<div class="togglescript" id="proofcontrol4" onclick="toggleDisplay('proof4');toggleDisplay('proofcontrol4')"><span class="show"></span></div>
<div class="proofscript" id="proof4" onclick="toggleDisplay('proof4');toggleDisplay('proofcontrol4')">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">functional</span>, <span class="id" type="var">insn_at_pc</span>. <span class="id" type="tactic">inversion</span> 1. <span class="id" type="tactic">destruct</span> <span class="id" type="var">a</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">b<sub>2</sub></span> [<span class="id" type="var">is<sub>1</sub></span> [<span class="id" type="var">Hin1</span> <span class="id" type="var">Hnth1</span>]] [<span class="id" type="var">is<sub>2</sub></span> [<span class="id" type="var">Hin2</span> <span class="id" type="var">Hnth2</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">cut</span> (<span class="id" type="var">is<sub>1</sub></span> = <span class="id" type="var">is<sub>2</sub></span>). <span class="id" type="tactic">intro</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">is<sub>2</sub></span>. <span class="id" type="tactic">eapply</span> <span class="id" type="var">Nth_eq</span>; <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">NoDup_assoc_func</span>; <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">uid_at_pc_inj</span> : ∀ <span class="id" type="var">g</span>, <span class="id" type="var">wf_cfg</span> <span class="id" type="var">g</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">injective</span> (<span class="id" type="var">uid_at_pc</span> <span class="id" type="var">g</span>).<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
<div class="togglescript" id="proofcontrol5" onclick="toggleDisplay('proof5');toggleDisplay('proofcontrol5')"><span class="show"></span></div>
<div class="proofscript" id="proof5" onclick="toggleDisplay('proof5');toggleDisplay('proofcontrol5')">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">injective</span>, <span class="id" type="var">uid_at_pc</span>, <span class="id" type="var">insn_at_pc</span>. <span class="id" type="tactic">inversion</span> 1.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> [<span class="id" type="var">l<sub>1</sub></span> <span class="id" type="var">n<sub>1</sub></span>] [<span class="id" type="var">l<sub>2</sub></span> <span class="id" type="var">n<sub>2</sub></span>] <span class="id" type="var">uid</span> [<span class="id" type="var">c<sub>1</sub></span> [<span class="id" type="var">is<sub>1</sub></span> [<span class="id" type="var">Hin1</span> <span class="id" type="var">Hnth1</span>]]] [<span class="id" type="var">c<sub>2</sub></span> [<span class="id" type="var">is<sub>2</sub></span> [<span class="id" type="var">Hin2</span> <span class="id" type="var">Hnth2</span>]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">cut</span> ((<span class="id" type="var">l<sub>1</sub></span>, <span class="id" type="var">is<sub>1</sub></span>) = (<span class="id" type="var">l<sub>2</sub></span>, <span class="id" type="var">is<sub>2</sub></span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span> <span class="id" type="var">Heq</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">Heq</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">Heq</span>. <span class="id" type="tactic">f_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">NoDup_flat_map__NoDup</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Huids</span>; <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">change</span> <span class="id" type="var">is<sub>1</sub></span> <span class="id" type="keyword">with</span> (<span class="id" type="var">snd</span> (<span class="id" type="var">l<sub>1</sub></span>, <span class="id" type="var">is<sub>1</sub></span>)) <span class="id" type="keyword">in</span> <span class="id" type="var">Hnth1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">change</span> <span class="id" type="var">is<sub>2</sub></span> <span class="id" type="keyword">with</span> (<span class="id" type="var">snd</span> (<span class="id" type="var">l<sub>2</sub></span>, <span class="id" type="var">is<sub>2</sub></span>)) <span class="id" type="keyword">in</span> <span class="id" type="var">Hnth2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span>; <span class="id" type="tactic">eapply</span> <span class="id" type="var">NoDup_nth_inj</span>; <span class="id" type="tactic">eauto</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">set</span> (<span class="id" type="var">f<sub>1</sub></span> <span class="id" type="var">b</span> := <span class="id" type="var">map</span> (@<span class="id" type="var">fst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) (<span class="id" type="var">snd</span> <span class="id" type="var">b</span>)) <span class="id" type="keyword">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">NoDup_flat_map</span> (<span class="id" type="var">l<sub>1</sub></span>, <span class="id" type="var">is<sub>1</sub></span>) (<span class="id" type="var">l<sub>2</sub></span>, <span class="id" type="var">is<sub>2</sub></span>) <span class="id" type="var">uid</span> <span class="id" type="var">f<sub>1</sub></span> <span class="id" type="var">bs</span>); <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">f<sub>1</sub></span>; <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">in_map_iff</span>. ∃ (<span class="id" type="var">uid</span>, <span class="id" type="var">c<sub>1</sub></span>); <span class="id" type="tactic">eauto</span> <span class="id" type="keyword">using</span> <span class="id" type="var">Nth_In</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">in_map_iff</span>. ∃ (<span class="id" type="var">uid</span>, <span class="id" type="var">c<sub>2</sub></span>); <span class="id" type="tactic">eauto</span> <span class="id" type="keyword">using</span> <span class="id" type="var">Nth_In</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">uid_at_pc_func</span> : ∀ <span class="id" type="var">g</span>, <span class="id" type="var">wf_cfg</span> <span class="id" type="var">g</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">functional</span> (<span class="id" type="var">uid_at_pc</span> <span class="id" type="var">g</span>).<br/>
<div class="togglescript" id="proofcontrol6" onclick="toggleDisplay('proof6');toggleDisplay('proofcontrol6')"><span class="show"></span></div>
<div class="proofscript" id="proof6" onclick="toggleDisplay('proof6');toggleDisplay('proofcontrol6')">
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">g</span> <span class="id" type="var">Hwfc</span>. <span class="id" type="var">specialize</span> (<span class="id" type="var">insn_at_pc_func</span> <span class="id" type="var">g</span> <span class="id" type="var">Hwfc</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">functional</span>, <span class="id" type="var">uid_at_pc</span>. <span class="id" type="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">H<sub>0</sub></span> <span class="id" type="keyword">as</span> [<span class="id" type="var">c<sub>1</sub></span> ?]. <span class="id" type="tactic">destruct</span> <span class="id" type="var">H<sub>1</sub></span> <span class="id" type="keyword">as</span> [<span class="id" type="var">c<sub>2</sub></span> ?].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">cut</span> ((<span class="id" type="var">b<sub>1</sub></span>,<span class="id" type="var">c<sub>1</sub></span>) = (<span class="id" type="var">b<sub>2</sub></span>,<span class="id" type="var">c<sub>2</sub></span>)). <span class="id" type="tactic">inversion</span> 1; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">eq_pc_uid</span> : ∀ <span class="id" type="var">g</span> <span class="id" type="var">pc</span> <span class="id" type="var">id<sub>1</sub></span> <span class="id" type="var">id<sub>2</sub></span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">c<sub>2</sub></span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">wf_cfg</span> <span class="id" type="var">g</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">insn_at_pc</span> <span class="id" type="var">g</span> <span class="id" type="var">pc</span> (<span class="id" type="var">id<sub>1</sub></span>, <span class="id" type="var">c<sub>1</sub></span>) →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">insn_at_pc</span> <span class="id" type="var">g</span> <span class="id" type="var">pc</span> (<span class="id" type="var">id<sub>2</sub></span>, <span class="id" type="var">c<sub>2</sub></span>) →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">id<sub>1</sub></span> = <span class="id" type="var">id<sub>2</sub></span>.<br/>
<div class="togglescript" id="proofcontrol7" onclick="toggleDisplay('proof7');toggleDisplay('proofcontrol7')"><span class="show"></span></div>
<div class="proofscript" id="proof7" onclick="toggleDisplay('proof7');toggleDisplay('proofcontrol7')">
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span>. <span class="id" type="var">pose</span> <span class="id" type="var">proof</span> (<span class="id" type="var">uid_at_pc_func</span> <span class="id" type="var">g</span> <span class="id" type="var">H</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">functional</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H<sub>2</sub></span>. <span class="id" type="tactic">eapply</span> <span class="id" type="var">H<sub>2</sub></span>; <span class="id" type="tactic">red</span>; <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">blocks_inj</span> : ∀ <span class="id" type="var">g</span>, <span class="id" type="var">wf_cfg</span> <span class="id" type="var">g</span> → ∀ <span class="id" type="var">l</span> <span class="id" type="var">is<sub>1</sub></span> <span class="id" type="var">is<sub>2</sub></span>, <span class="id" type="var">In</span> (<span class="id" type="var">l</span>, <span class="id" type="var">is<sub>1</sub></span>) (<span class="id" type="var">snd</span> <span class="id" type="var">g</span>) → <span class="id" type="var">In</span> (<span class="id" type="var">l</span>, <span class="id" type="var">is<sub>2</sub></span>) (<span class="id" type="var">snd</span> <span class="id" type="var">g</span>) → <span class="id" type="var">is<sub>1</sub></span> = <span class="id" type="var">is<sub>2</sub></span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
<div class="togglescript" id="proofcontrol8" onclick="toggleDisplay('proof8');toggleDisplay('proofcontrol8')"><span class="show"></span></div>
<div class="proofscript" id="proof8" onclick="toggleDisplay('proof8');toggleDisplay('proofcontrol8')">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">g</span> <span class="id" type="var">H</span> <span class="id" type="var">l</span> <span class="id" type="var">is<sub>1</sub></span> <span class="id" type="var">is<sub>2</sub></span> <span class="id" type="var">H<sub>0</sub></span> <span class="id" type="var">H<sub>1</sub></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">NoDup_assoc_func</span>; <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">pc_at_uid_inj</span> : ∀ <span class="id" type="var">g</span>, <span class="id" type="var">wf_cfg</span> <span class="id" type="var">g</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">injective</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">x</span> <span class="id" type="var">p</span> ⇒ <span class="id" type="var">uid_at_pc</span> <span class="id" type="var">g</span> <span class="id" type="var">p</span> <span class="id" type="var">x</span>).<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
<div class="togglescript" id="proofcontrol9" onclick="toggleDisplay('proof9');toggleDisplay('proofcontrol9')"><span class="show"></span></div>
<div class="proofscript" id="proof9" onclick="toggleDisplay('proof9');toggleDisplay('proofcontrol9')">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">injective</span>, <span class="id" type="var">uid_at_pc</span>, <span class="id" type="var">insn_at_pc</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">g</span> <span class="id" type="var">Hwf</span> <span class="id" type="var">a<sub>1</sub></span> <span class="id" type="var">a<sub>2</sub></span> [<span class="id" type="var">l</span> <span class="id" type="var">n</span>] [<span class="id" type="var">c<sub>1</sub></span> [<span class="id" type="var">is<sub>1</sub></span> [<span class="id" type="var">Hin1</span> <span class="id" type="var">Hn<sub>1</sub></span>]]] [<span class="id" type="var">c<sub>2</sub></span> [<span class="id" type="var">is<sub>2</sub></span> [<span class="id" type="var">Hin2</span> <span class="id" type="var">Hn<sub>2</sub></span>]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Hwf</span>. <span class="id" type="tactic">subst</span>. <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">is<sub>1</sub></span> = <span class="id" type="var">is<sub>2</sub></span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">NoDup_assoc_func</span>; <span class="id" type="tactic">eauto</span>. <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> ((<span class="id" type="var">a<sub>1</sub></span>, <span class="id" type="var">c<sub>1</sub></span>) = (<span class="id" type="var">a<sub>2</sub></span>, <span class="id" type="var">c<sub>2</sub></span>)) <span class="id" type="keyword">as</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">eapply</span> <span class="id" type="var">Nth_eq</span>; <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
</div>

<div class="doc">
<hr/>
 <a name="lab41"></a><h2 class="section">Working with ListCFG</h2>

</div>
<div class="code code-space">

<br/>
</div>

<div class="doc">
<span class="inlinecode"><span class="id" type="var">update</span></span> Adds the given instruction list as a block labeled <span class="inlinecode"><span class="id" type="var">l</span></span>. 

<div class="paragraph"> </div>

      Note: this function does not enforce the unique-block label property.
  
</div>
<div class="code code-tight">

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Definition</span> <span class="id" type="var">update</span> (<span class="id" type="var">bs</span>:<span class="id" type="var">list</span> <span class="id" type="var">block</span>) (<span class="id" type="var">l</span>:<span class="id" type="var">lbl</span>) (<span class="id" type="var">is</span>:<span class="id" type="var">list</span> <span class="id" type="var">insn</span>) : <span class="id" type="var">list</span> <span class="id" type="var">block</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">l</span>, <span class="id" type="var">is</span>)::<span class="id" type="var">bs</span>.<br/>
</div>

<div class="doc">
Lookup the block in the list. 
</div>
<div class="code code-tight">

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Definition</span> <span class="id" type="var">lookup</span> (<span class="id" type="var">bs</span>:<span class="id" type="var">list</span> <span class="id" type="var">block</span>) (<span class="id" type="var">l</span>:<span class="id" type="var">lbl</span>) : <span class="id" type="var">option</span> (<span class="id" type="var">list</span> <span class="id" type="var">insn</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">assoc</span> <span class="id" type="var">Lbl.eq_dec</span> <span class="id" type="var">l</span> <span class="id" type="var">bs</span>.<br/>
</div>

<div class="doc">
<a name="lab42"></a><h2 class="section">Simple lemmas about CFG modifications.</h2>

</div>
<div class="code code-space">

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">update_eq</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;∀ (<span class="id" type="var">is</span> : <span class="id" type="var">list</span> <span class="id" type="var">insn</span>) (<span class="id" type="var">l<sub>1</sub></span> <span class="id" type="var">l<sub>2</sub></span> : <span class="id" type="var">lbl</span>) (<span class="id" type="var">bs</span> : <span class="id" type="var">list</span> <span class="id" type="var">block</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">l<sub>1</sub></span> = <span class="id" type="var">l<sub>2</sub></span> → <span class="id" type="var">lookup</span> (<span class="id" type="var">update</span> <span class="id" type="var">bs</span> <span class="id" type="var">l<sub>1</sub></span> <span class="id" type="var">is</span>) <span class="id" type="var">l<sub>2</sub></span> = <span class="id" type="var">Some</span> <span class="id" type="var">is</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
<div class="togglescript" id="proofcontrol10" onclick="toggleDisplay('proof10');toggleDisplay('proofcontrol10')"><span class="show"></span></div>
<div class="proofscript" id="proof10" onclick="toggleDisplay('proof10');toggleDisplay('proofcontrol10')">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">update</span>, <span class="id" type="var">lookup</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">subst</span>. <span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">destruct</span> (<span class="id" type="var">Lbl.eq_dec</span> <span class="id" type="var">l<sub>2</sub></span> <span class="id" type="var">l<sub>2</sub></span>); <span class="id" type="tactic">tauto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">update_neq</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;∀ (<span class="id" type="var">l<sub>1</sub></span> <span class="id" type="var">l<sub>2</sub></span> : <span class="id" type="var">lbl</span>) (<span class="id" type="var">is</span> : <span class="id" type="var">list</span> <span class="id" type="var">insn</span>) (<span class="id" type="var">bs</span>: <span class="id" type="var">list</span> <span class="id" type="var">block</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">l<sub>1</sub></span> ≠ <span class="id" type="var">l<sub>2</sub></span> → <span class="id" type="var">lookup</span> (<span class="id" type="var">update</span> <span class="id" type="var">bs</span> <span class="id" type="var">l<sub>1</sub></span> <span class="id" type="var">is</span>) <span class="id" type="var">l<sub>2</sub></span> = <span class="id" type="var">lookup</span> <span class="id" type="var">bs</span> <span class="id" type="var">l<sub>2</sub></span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
<div class="togglescript" id="proofcontrol11" onclick="toggleDisplay('proof11');toggleDisplay('proofcontrol11')"><span class="show"></span></div>
<div class="proofscript" id="proof11" onclick="toggleDisplay('proof11');toggleDisplay('proofcontrol11')">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">Lbl.eq_dec</span> <span class="id" type="var">l<sub>2</sub></span> <span class="id" type="var">l<sub>1</sub></span>); <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">tauto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
</div>

<div class="doc">
<hr/>
 <a name="lab43"></a><h2 class="section">Implementing fetch</h2>

</div>
<div class="code code-space">

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Definition</span> <span class="id" type="var">fetch</span> (<span class="id" type="var">g</span> : <span class="id" type="var">cfg</span>) (<span class="id" type="var">p</span>: <span class="id" type="var">pc</span>): <span class="id" type="var">option</span> <span class="id" type="var">insn</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">let</span> '(<span class="id" type="var">entry_label</span>, <span class="id" type="var">blocks</span>) := <span class="id" type="var">g</span> <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">let</span> '(<span class="id" type="var">trgt_block</span>, <span class="id" type="var">offset</span>) := <span class="id" type="var">p</span> <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> (<span class="id" type="var">lookup</span> <span class="id" type="var">blocks</span> <span class="id" type="var">trgt_block</span>) <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Some</span> <span class="id" type="var">found_block</span> ⇒ <span class="id" type="var">nth_error</span> <span class="id" type="var">found_block</span> <span class="id" type="var">offset</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">None</span> ⇒ <span class="id" type="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
</div>

<div class="doc">
Helper lemma for proving that fetch corresponds to insn_at_pc 
</div>
<div class="code code-tight">

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">fetch_iff_in_cfg</span>: ∀ <span class="id" type="var">entry_label</span> <span class="id" type="var">blks</span> <span class="id" type="var">trgt_label</span> <span class="id" type="var">trgt_offset</span> <span class="id" type="var">i</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">NoDup</span> (<span class="id" type="var">map</span> <span class="id" type="var">fst</span> <span class="id" type="var">blks</span>) → <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">fetch</span> (<span class="id" type="var">entry_label</span>, <span class="id" type="var">blks</span>) (<span class="id" type="var">trgt_label</span>, <span class="id" type="var">trgt_offset</span>) = <span class="id" type="var">Some</span> <span class="id" type="var">i</span> ↔<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;∃ <span class="id" type="var">instrs</span>, <span class="id" type="var">In</span> (<span class="id" type="var">trgt_label</span>, <span class="id" type="var">instrs</span>) <span class="id" type="var">blks</span> ∧ <span class="id" type="var">Nth</span> <span class="id" type="var">i</span> <span class="id" type="var">instrs</span> <span class="id" type="var">trgt_offset</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
<div class="togglescript" id="proofcontrol12" onclick="toggleDisplay('proof12');toggleDisplay('proofcontrol12')"><span class="show"></span></div>
<div class="proofscript" id="proof12" onclick="toggleDisplay('proof12');toggleDisplay('proofcontrol12')">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">entry_label</span> <span class="id" type="var">blks</span> <span class="id" type="var">trgt_label</span> <span class="id" type="var">trgt_offset</span> <span class="id" type="var">i</span> <span class="id" type="var">nodup</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">fetch</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">lookup</span> <span class="id" type="var">blks</span> <span class="id" type="var">trgt_label</span>) <span class="id" type="var">eqn</span>:<span class="id" type="var">found</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id" type="tactic">unfold</span> <span class="id" type="var">lookup</span> <span class="id" type="keyword">in</span> <span class="id" type="var">found</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">assoc_in</span> <span class="id" type="keyword">in</span> <span class="id" type="var">found</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="id" type="tactic">intros</span>. ∃ <span class="id" type="var">l</span>. <span class="id" type="tactic">split</span>; <span class="id" type="tactic">auto</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">nth_error_iff_Nth</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="id" type="tactic">intros</span> [<span class="id" type="var">is</span> [<span class="id" type="var">Hi</span> <span class="id" type="var">Hnth</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">l</span> = <span class="id" type="var">is</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">NoDup_assoc_func</span>; <span class="id" type="tactic">eauto</span>. <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">nth_error_iff_Nth</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="id" type="tactic">intros</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="id" type="tactic">intros</span> [<span class="id" type="var">l</span> [<span class="id" type="var">Hin</span> <span class="id" type="var">Hn</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">nth_error_iff_Nth</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hn</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">lookup</span> <span class="id" type="keyword">in</span> <span class="id" type="var">found</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">in_assoc_none</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">b</span>:=<span class="id" type="var">l</span>) <span class="id" type="keyword">in</span> <span class="id" type="var">found</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">contradiction</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
</div>

<div class="doc">
<span class="inlinecode"><span class="id" type="var">fetch</span></span> is the executable version of <span class="inlinecode"><span class="id" type="var">insn_at_pc</span></span> 
</div>
<div class="code code-tight">

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">insn_at_pc_fetch</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;∀ <span class="id" type="var">g</span> <span class="id" type="var">pc</span> <span class="id" type="var">i</span>, <span class="id" type="var">wf_cfg</span> <span class="id" type="var">g</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">insn_at_pc</span> <span class="id" type="var">g</span> <span class="id" type="var">pc</span> <span class="id" type="var">i</span> ↔ <span class="id" type="var">fetch</span> <span class="id" type="var">g</span> <span class="id" type="var">pc</span> = <span class="id" type="var">Some</span> <span class="id" type="var">i</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
<div class="togglescript" id="proofcontrol13" onclick="toggleDisplay('proof13');toggleDisplay('proofcontrol13')"><span class="show"></span></div>
<div class="proofscript" id="proof13" onclick="toggleDisplay('proof13');toggleDisplay('proofcontrol13')">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> [<span class="id" type="var">l</span> <span class="id" type="var">blks</span>] <span class="id" type="var">pc</span> <span class="id" type="var">i</span> <span class="id" type="var">wf_g</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">wf_g</span> <span class="id" type="keyword">as</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="id" type="var">l'</span> <span class="id" type="var">blks'</span> <span class="id" type="var">nodup</span> <span class="id" type="var">nodup_uid</span> <span class="id" type="var">l_in_blks</span> <span class="id" type="var">blks_not_empty</span> [<span class="id" type="var">l_l'</span> <span class="id" type="var">blks_blk</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">pc</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">curr_label</span> <span class="id" type="var">curr_offset</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">fetch_iff_in_cfg</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">split</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
<span class="id" type="keyword">End</span> <span class="id" type="var">ListCFG</span>.<br/>
</div>
</div>

<div id="footer">
<hr/><a href="coqindex.html">Index</a></div>

</div>

</body>
</html>