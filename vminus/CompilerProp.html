<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<link href="common/css/sf.css" rel="stylesheet" type="text/css"/>
<title>CompilerProp</title>
</head>
<link href="common/jquery-ui/jquery-ui.css" rel="stylesheet">
<script src="common/jquery-ui/external/jquery/jquery.js"></script>
<script src="common/jquery-ui/jquery-ui.js"></script>
<script src="common/toggleproofs.js"></script>
<link href="common/css/lf.css" rel="stylesheet" type="text/css"/>

<body>

<div id="page">

<div id="header">
<a href='https://www.cis.upenn.edu/~bcpierce/sf/current/index.html'>
<img src='common/media/image/sf_logo_sm.png'></a>
<ul id='menu'>
   <a href='index.html'><li class='section_name'>VMinus Development</li></a>
   <a href='toc.html'><li>Table of Contents</li></a>
   <a href='coqindex.html'><li>Index</li></a>
   <a href='deps.html'><li>Roadmap</li></a>
</ul>
</div>

<div id="main">

<h1 class="libtitle">CompilerProp</h1>

<div class="code code-tight">
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">FunctionalExtensionality</span>. <span class="comment">(*&nbsp;TODO:&nbsp;don't&nbsp;really&nbsp;need&nbsp;this&nbsp;*)</span><br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">List</span>.<br/>
<span class="id" type="keyword">Import</span> <span class="id" type="var">ListNotations</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">RelationClasses</span>.<br/>

<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">Vminus.Util</span> <span class="id" type="var">Vminus.Classes</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">Vminus.Vminus</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">Vminus.CFG</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">Vminus.ListCFG</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">Vminus.Sequences</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">Vminus.VminusOpSem</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">Vminus.Imp</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">Vminus.Compiler</span>.<br/>

<br/>
<span class="id" type="keyword">Import</span> <span class="id" type="var">V.Opsem</span>.<br/>

<br/>
<span class="id" type="keyword">Set</span> <span class="id" type="var">Bullet</span> <span class="id" type="var">Behavior</span> "Strict Subproofs".<br/>
<span class="id" type="keyword">Unset</span> <span class="id" type="var">Printing</span> <span class="id" type="var">Records</span>.<br/>
</div>

<div class="doc">
<a name="lab61"></a><h1 class="section">To possibly refactor into CFGProp</h1>
<a name="lab62"></a><h2 class="section">Correspondence between concrete and abstract CFGs.</h2>

<div class="paragraph"> </div>

 Asserts that the instruction sequence found at program point p in 
    the control-flow graph g is exactly the list <span class="inlinecode"><span class="id" type="var">is</span></span>. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">insns_at_pc</span> (<span class="id" type="var">g</span>:<span class="id" type="var">ListCFG.t</span>) (<span class="id" type="var">p</span>:<span class="id" type="var">pc</span>) (<span class="id" type="var">is</span>:<span class="id" type="var">list</span> <span class="id" type="var">insn</span>) : <span class="id" type="keyword">Prop</span> := <br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">is</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">nil</span> ⇒ <span class="id" type="var">True</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">i</span> :: <span class="id" type="var">is'</span> ⇒ <span class="id" type="var">ListCFG.insn_at_pc</span> <span class="id" type="var">g</span> <span class="id" type="var">p</span> <span class="id" type="var">i</span> ∧ <span class="id" type="var">insns_at_pc</span> <span class="id" type="var">g</span> (<span class="id" type="var">incr_pc</span> <span class="id" type="var">p</span>) <span class="id" type="var">is'</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
</div>

<div class="doc">
Looking up the block labeled <span class="inlinecode"><span class="id" type="var">l</span></span> in the concrete represenation
    agrees with the declarative specification. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">cfg_insns_at</span> : ∀ <span class="id" type="var">g</span> <span class="id" type="var">l</span> <span class="id" type="var">is</span> <span class="id" type="var">e</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">ListCFG.lookup</span> <span class="id" type="var">g</span> <span class="id" type="var">l</span> = <span class="id" type="var">Some</span> <span class="id" type="var">is</span> →<br/>
&nbsp;&nbsp;<span class="id" type="var">insns_at_pc</span> (<span class="id" type="var">e</span>, <span class="id" type="var">g</span>) (<span class="id" type="var">block_entry</span> <span class="id" type="var">l</span>) <span class="id" type="var">is</span>.<br/>
<div class="togglescript" id="proofcontrol1" onclick="toggleDisplay('proof1');toggleDisplay('proofcontrol1')"><span class="show"></span></div>
<div class="proofscript" id="proof1" onclick="toggleDisplay('proof1');toggleDisplay('proofcontrol1')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">pose</span> (<span class="id" type="var">k</span>:=@<span class="id" type="var">nil</span> <span class="id" type="var">insn</span>). <span class="id" type="var">change</span> <span class="id" type="var">is</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">k</span> ++ <span class="id" type="var">is</span>) <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">block_entry</span>. <span class="id" type="var">change</span> 0 <span class="id" type="keyword">with</span> (<span class="id" type="var">length</span> <span class="id" type="var">k</span>).<br/>
&nbsp;&nbsp;<span class="id" type="var">clearbody</span> <span class="id" type="var">k</span>. <span class="id" type="tactic">generalize</span> <span class="id" type="tactic">dependent</span> <span class="id" type="var">k</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">is</span>; <span class="id" type="tactic">intros</span>. <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">split</span>. <span class="id" type="var">eexists</span>. <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">ListCFG.lookup</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">assoc_in</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">induction</span> <span class="id" type="var">k</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">replace</span> (<span class="id" type="var">S</span> (<span class="id" type="var">length</span> <span class="id" type="var">k</span>)) <span class="id" type="keyword">with</span> (<span class="id" type="var">length</span> (<span class="id" type="var">k</span> ++ [<span class="id" type="var">a</span>])). <span class="id" type="tactic">apply</span> <span class="id" type="var">IHis</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">app_assoc</span>. <span class="id" type="tactic">auto</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">app_length</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">PeanoNat.Nat.add_1_r</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
</div>

<div class="doc">
<a name="lab63"></a><h1 class="section">End refactoring</h1>

<div class="paragraph"> </div>

<a name="lab64"></a><h2 class="section">Auxiliary definitions.</h2>

</div>
<div class="code code-space">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">ids_preserved</span> (<span class="id" type="var">cs</span>:<span class="id" type="var">list</span> <span class="id" type="var">uid</span>) (<span class="id" type="var">st</span> <span class="id" type="var">st'</span>:<span class="id" type="var">state</span>) : <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;∀ <span class="id" type="var">uid</span> <span class="id" type="var">n</span>, <span class="id" type="var">In</span> <span class="id" type="var">uid</span> <span class="id" type="var">cs</span> → <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">st_loc</span> <span class="id" type="var">st</span> <span class="id" type="var">uid</span> = <span class="id" type="var">Some</span> <span class="id" type="var">n</span> → <span class="id" type="var">st_loc</span> <span class="id" type="var">st'</span> <span class="id" type="var">uid</span> = <span class="id" type="var">Some</span> <span class="id" type="var">n</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">good_return</span> (<span class="id" type="var">cs</span>:<span class="id" type="var">list</span> <span class="id" type="var">uid</span>) (<span class="id" type="var">v</span>:<span class="id" type="var">val</span>) : <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;∀ <span class="id" type="var">uid</span>, <span class="id" type="var">v</span> = <span class="id" type="var">val_uid</span> <span class="id" type="var">uid</span> → <span class="id" type="var">In</span> <span class="id" type="var">uid</span> <span class="id" type="var">cs</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">ctx_incr</span> (<span class="id" type="var">cs</span> <span class="id" type="var">cs'</span>:<span class="id" type="var">list</span> <span class="id" type="var">uid</span>) : <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;∀ <span class="id" type="var">uid</span>, <span class="id" type="var">In</span> <span class="id" type="var">uid</span> <span class="id" type="var">cs</span> → <span class="id" type="var">In</span> <span class="id" type="var">uid</span> <span class="id" type="var">cs'</span>.<br/>

<br/>
<span class="id" type="keyword">Instance</span> <span class="id" type="var">ctx_incr_trans</span> : <span class="id" type="var">Transitive</span> <span class="id" type="var">ctx_incr</span>.<br/>
<div class="togglescript" id="proofcontrol2" onclick="toggleDisplay('proof2');toggleDisplay('proofcontrol2')"><span class="show"></span></div>
<div class="proofscript" id="proof2" onclick="toggleDisplay('proof2');toggleDisplay('proofcontrol2')">
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">red</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">ctx_incr</span>; <span class="id" type="tactic">intuition</span>. <span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
</div>

<div class="doc">
<a name="lab65"></a><h1 class="section">Proofs start here; commented out because of QuickChick for now</h1>

</div>
<div class="code code-space">
<span class="id" type="keyword">Definition</span> <span class="id" type="var">comp_correct</span> (<span class="id" type="var">comp</span> : <span class="id" type="var">ectmon</span> (<span class="id" type="var">val</span> * <span class="id" type="var">list</span> <span class="id" type="var">insn</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">eval</span> : <span class="id" type="var">mem</span> → <span class="id" type="var">nat</span>) : <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;∀ <span class="id" type="var">cs</span> <span class="id" type="var">cs'</span> <span class="id" type="var">g</span> <span class="id" type="var">st</span> <span class="id" type="var">is</span> <span class="id" type="var">k</span> <span class="id" type="var">v</span>,<br/>
&nbsp;&nbsp;(<span class="id" type="var">cs'</span>, (<span class="id" type="var">v</span>, <span class="id" type="var">is</span>)) = <span class="id" type="var">comp</span> <span class="id" type="var">cs</span> →<br/>
&nbsp;&nbsp;<span class="id" type="var">insns_at_pc</span> <span class="id" type="var">g</span> (<span class="id" type="var">st_pc</span> <span class="id" type="var">st</span>) (<span class="id" type="var">is</span> ++ <span class="id" type="var">k</span>) →<br/>
&nbsp;&nbsp;∃ <span class="id" type="var">st'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">st_mem</span> <span class="id" type="var">st'</span> = <span class="id" type="var">st_mem</span> <span class="id" type="var">st</span> ∧<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">insns_at_pc</span> <span class="id" type="var">g</span> (<span class="id" type="var">st_pc</span> <span class="id" type="var">st'</span>) <span class="id" type="var">k</span> ∧<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">star</span> (<span class="id" type="var">step</span> <span class="id" type="var">g</span>) <span class="id" type="var">st</span> <span class="id" type="var">st'</span> ∧<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ids_preserved</span> <span class="id" type="var">cs</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> ∧<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">good_return</span> <span class="id" type="var">cs'</span> <span class="id" type="var">v</span> ∧<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ctx_incr</span> <span class="id" type="var">cs</span> <span class="id" type="var">cs'</span> ∧<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">eval_val</span> (<span class="id" type="var">st_loc</span> <span class="id" type="var">st'</span>) <span class="id" type="var">v</span> = <span class="id" type="var">Some</span> (<span class="id" type="var">eval</span> (<span class="id" type="var">st_mem</span> <span class="id" type="var">st</span>)).<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">comp_bop_correct</span> : ∀ <span class="id" type="var">b</span> <span class="id" type="var">comp1</span> <span class="id" type="var">comp2</span> <span class="id" type="var">eval1</span> <span class="id" type="var">eval2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">IHa1</span>: <span class="id" type="var">comp_correct</span> <span class="id" type="var">comp1</span> <span class="id" type="var">eval1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">IHa2</span>: <span class="id" type="var">comp_correct</span> <span class="id" type="var">comp2</span> <span class="id" type="var">eval2</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">comp_correct</span> (<span class="id" type="var">comp_bop</span> <span class="id" type="var">b</span> <span class="id" type="var">comp1</span> <span class="id" type="var">comp2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">fun</span> <span class="id" type="var">m</span> ⇒ <span class="id" type="var">bop_denote</span> <span class="id" type="var">b</span> (<span class="id" type="var">eval1</span> <span class="id" type="var">m</span>) (<span class="id" type="var">eval2</span> <span class="id" type="var">m</span>)).<br/>
<div class="togglescript" id="proofcontrol3" onclick="toggleDisplay('proof3');toggleDisplay('proofcontrol3')"><span class="show"></span></div>
<div class="proofscript" id="proof3" onclick="toggleDisplay('proof3');toggleDisplay('proofcontrol3')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">comp_correct</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">b</span> <span class="id" type="var">comp1</span> <span class="id" type="var">comp2</span> <span class="id" type="var">eval1</span> <span class="id" type="var">eval2</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">until</span> <span class="id" type="var">v</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">Hcomp</span> <span class="id" type="var">Hinsns</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">comp_bop</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hcomp</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hcomp</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">comp1</span> <span class="id" type="var">cs</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">cs<sub>1</sub></span> [<span class="id" type="var">rl<sub>1</sub></span> <span class="id" type="var">rr<sub>1</sub></span>]] <span class="id" type="var">eqn</span>:<span class="id" type="var">Hc<sub>1</sub></span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">comp2</span> <span class="id" type="var">cs<sub>1</sub></span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">cs<sub>2</sub></span> [<span class="id" type="var">rl<sub>2</sub></span> <span class="id" type="var">rr<sub>2</sub></span>]] <span class="id" type="var">eqn</span>:<span class="id" type="var">Hc<sub>2</sub></span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Hcomp</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">Hcomp</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">repeat</span> <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">app_assoc</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hinsns</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">eelim</span> <span class="id" type="var">IHa1</span>; [| <span class="id" type="tactic">eauto</span> ..].<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st<sub>1</sub></span> (<span class="id" type="var">Hinv1</span> &amp; <span class="id" type="var">His1</span> &amp; <span class="id" type="var">Hstep1</span> &amp; <span class="id" type="var">Hpres1</span> &amp; <span class="id" type="var">Hret1</span> &amp; <span class="id" type="var">Hincr1</span> &amp; <span class="id" type="var">Heval1</span>).<br/>
&nbsp;&nbsp;<span class="id" type="var">eelim</span> <span class="id" type="var">IHa2</span>; [| <span class="id" type="tactic">eauto</span> ..].<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st<sub>2</sub></span> (<span class="id" type="var">Hinv2</span> &amp; <span class="id" type="var">His2</span> &amp; <span class="id" type="var">Hstep2</span> &amp; <span class="id" type="var">Hpres2</span> &amp; <span class="id" type="var">Hret2</span> &amp; <span class="id" type="var">Hincr2</span> &amp; <span class="id" type="var">Heval2</span>).<br/>
&nbsp;&nbsp;<span class="id" type="tactic">clear</span> <span class="id" type="var">IHa1</span> <span class="id" type="var">IHa2</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="tactic">rename</span> <span class="id" type="var">st<sub>2</sub></span> <span class="id" type="var">into</span> <span class="id" type="var">st<sub>2</sub>'</span>; <span class="id" type="tactic">set</span> (<span class="id" type="var">st<sub>2</sub></span>:=<span class="id" type="var">st<sub>2</sub>'</span>) <span class="id" type="keyword">in</span> *; <span class="id" type="tactic">destruct</span> <span class="id" type="var">st<sub>2</sub>'</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">eexists</span> {| <span class="id" type="var">st_pc</span>  := <span class="id" type="var">incr_pc</span> (<span class="id" type="var">st_pc</span> <span class="id" type="var">st<sub>2</sub></span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">st_loc</span> := <span class="id" type="var">Locals.update</span> (<span class="id" type="var">st_loc</span> <span class="id" type="var">st<sub>2</sub></span>) (<span class="id" type="var">Uid.fresh</span> <span class="id" type="var">cs<sub>2</sub></span>) <span class="id" type="var">_</span> |}. <span class="id" type="tactic">simpl</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;exp_invar&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">split</span>. <span class="id" type="tactic">transitivity</span> (<span class="id" type="var">st_mem</span> <span class="id" type="var">st<sub>1</sub></span>). <span class="id" type="tactic">transitivity</span> (<span class="id" type="var">st_mem</span> <span class="id" type="var">st<sub>2</sub></span>). <span class="id" type="tactic">reflexivity</span>. <span class="id" type="tactic">auto</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">Hinv1</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;insns_at_pc&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">split</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">His2</span>; <span class="id" type="tactic">auto</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;star&nbsp;(Opsem.step&nbsp;g)&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">split</span>. <span class="id" type="tactic">eapply</span> <span class="id" type="var">star_trans</span>; <span class="id" type="tactic">eauto</span>. <span class="id" type="tactic">eapply</span> <span class="id" type="var">star_trans</span>; <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">star_one</span>. <span class="id" type="tactic">eapply</span> <span class="id" type="var">step_bop</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">His2</span>; <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">eval_bop</span>. <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heval2</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Heval2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">replace</span> (<span class="id" type="var">eval_val</span> <span class="id" type="var">st_loc0</span> <span class="id" type="var">_</span>) <span class="id" type="keyword">with</span> (<span class="id" type="var">Some</span> (<span class="id" type="var">eval1</span> (<span class="id" type="var">st_mem</span> <span class="id" type="var">st</span>))).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">reflexivity</span>. <span class="id" type="tactic">symmetry</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">rl<sub>1</sub></span>; <span class="id" type="tactic">auto</span>. <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">good_return</span> <span class="id" type="keyword">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rename</span> <span class="id" type="var">t</span> <span class="id" type="var">into</span> <span class="id" type="var">t<sub>0</sub></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">In</span> <span class="id" type="var">t<sub>0</sub></span> <span class="id" type="var">cs<sub>1</sub></span>). <span class="id" type="tactic">apply</span> <span class="id" type="var">Hret1</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">ids_preserved</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hpres2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">Hpres2</span>. <span class="id" type="tactic">auto</span>. <span class="id" type="tactic">auto</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;ids_preserved&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">split</span>. <span class="id" type="tactic">red</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intros</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Locals.update_neq</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">change</span> <span class="id" type="var">st_loc0</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">st_loc</span> <span class="id" type="var">st<sub>2</sub></span>).<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">Hpres2</span>; <span class="id" type="tactic">auto</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">Hincr1</span>, <span class="id" type="var">Hincr2</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Hc<sub>2</sub></span>. <span class="id" type="var">contradict</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">Uid.fresh_not_in</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;good_return&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">split</span>. <span class="id" type="tactic">red</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">uid'</span> <span class="id" type="var">Hid</span>. <span class="id" type="tactic">injection</span> <span class="id" type="var">Hid</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">Hc<sub>2</sub></span>. <span class="id" type="var">left</span>; <span class="id" type="tactic">auto</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;ctx_incr&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">split</span>. <span class="id" type="tactic">transitivity</span> <span class="id" type="var">cs<sub>1</sub></span>; <span class="id" type="tactic">auto</span>. <span class="id" type="tactic">transitivity</span> <span class="id" type="var">cs<sub>2</sub></span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">ctx_incr</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">Hc<sub>2</sub></span>; <span class="id" type="tactic">intros</span>. <span class="id" type="var">right</span>; <span class="id" type="tactic">auto</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;eval_val&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Locals.update_eq</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">replace</span> (<span class="id" type="var">st_mem</span> <span class="id" type="var">st<sub>1</sub></span>) <span class="id" type="keyword">with</span> (<span class="id" type="var">st_mem</span> <span class="id" type="var">st</span>). <span class="id" type="tactic">subst</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Hinv1</span>; <span class="id" type="tactic">auto</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">comp_aexp_correct</span> : ∀ (<span class="id" type="var">a</span>:<span class="id" type="var">aexp</span>),<br/>
&nbsp;&nbsp;<span class="id" type="var">comp_correct</span> (<span class="id" type="var">comp_aexp</span> <span class="id" type="var">a</span>) (<span class="id" type="var">aeval</span> <span class="id" type="var">a</span>).<br/>
<div class="togglescript" id="proofcontrol4" onclick="toggleDisplay('proof4');toggleDisplay('proofcontrol4')"><span class="show"></span></div>
<div class="proofscript" id="proof4" onclick="toggleDisplay('proof4');toggleDisplay('proofcontrol4')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;comp_bop_correct&nbsp;takes&nbsp;care&nbsp;of&nbsp;all&nbsp;the&nbsp;inductive&nbsp;cases&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">a</span>; [ | | <span class="id" type="tactic">eapply</span> <span class="id" type="var">comp_bop_correct</span>; <span class="id" type="tactic">auto</span> ..].<br/>

<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;Case&nbsp;"ANum".&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">comp_correct</span>; <span class="id" type="tactic">intros</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;∃ <span class="id" type="var">st</span>. <span class="id" type="tactic">repeat</span> <span class="id" type="tactic">split</span>; <span class="id" type="tactic">try</span> <span class="id" type="tactic">red</span>; <span class="id" type="tactic">auto</span> <span class="id" type="keyword">using</span> <span class="id" type="var">star_refl</span>. <span class="id" type="tactic">discriminate</span>.<br/>

<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;Case&nbsp;"AId".&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">comp_correct</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">cs</span> <span class="id" type="var">cs'</span> <span class="id" type="var">g</span> <span class="id" type="var">st</span> <span class="id" type="var">is</span> <span class="id" type="var">k</span> <span class="id" type="var">v</span> <span class="id" type="var">Hcomp</span> <span class="id" type="var">Hinsns</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hcomp</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="tactic">fresh</span> <span class="id" type="var">cs</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">cs<sub>1</sub></span> <span class="id" type="var">idr</span>] <span class="id" type="var">eqn</span>:<span class="id" type="var">Hc</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Hcomp</span>. <span class="id" type="tactic">clear</span> <span class="id" type="var">Hcomp</span>. <span class="id" type="tactic">subst</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="tactic">rename</span> <span class="id" type="var">st</span> <span class="id" type="var">into</span> <span class="id" type="var">st'</span>. <span class="id" type="tactic">set</span> (<span class="id" type="var">st</span> := <span class="id" type="var">st'</span>). <span class="id" type="tactic">destruct</span> <span class="id" type="var">st'</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">eexists</span> {| <span class="id" type="var">st_pc</span> := (<span class="id" type="var">incr_pc</span> (<span class="id" type="var">st_pc</span> <span class="id" type="var">st</span>));<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">st_loc</span> := <span class="id" type="var">Locals.update</span> (<span class="id" type="var">st_loc</span> <span class="id" type="var">st</span>) <span class="id" type="var">idr</span> <span class="id" type="var">_</span> |}. <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">split</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">split</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">Hinsns</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">split</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">star_one</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">step_load</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Hinsns</span>; <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> *.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="tactic">fresh</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hc</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">Hc</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">split</span>. <span class="id" type="tactic">red</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intros</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Locals.update_neq</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Hc</span>. <span class="id" type="var">contradict</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">Uid.fresh_not_in</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">split</span>. <span class="id" type="tactic">red</span>. <span class="id" type="tactic">intros</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">Hc</span>. <span class="id" type="tactic">injection</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intro</span>. <span class="id" type="tactic">subst</span> <span class="id" type="var">idr</span> <span class="id" type="var">uid</span>. <span class="id" type="var">left</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">split</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">Hc</span>; <span class="id" type="tactic">red</span>; <span class="id" type="tactic">intuition</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Locals.update_eq</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">Hc</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
<span class="id" type="keyword">Local</span> <span class="id" type="keyword">Hint</span> <span class="id" type="keyword">Resolve</span> <span class="id" type="var">comp_aexp_correct</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">comp_bexp_correct</span> : ∀ (<span class="id" type="var">b</span>:<span class="id" type="var">bexp</span>),<br/>
&nbsp;&nbsp;<span class="id" type="var">comp_correct</span> (<span class="id" type="var">comp_bexp</span> <span class="id" type="var">b</span>) (<span class="id" type="keyword">fun</span> <span class="id" type="var">m</span> ⇒ <span class="id" type="var">b2n</span> (<span class="id" type="var">beval</span> <span class="id" type="var">b</span> <span class="id" type="var">m</span>)).<br/>
<div class="togglescript" id="proofcontrol5" onclick="toggleDisplay('proof5');toggleDisplay('proofcontrol5')"><span class="show"></span></div>
<div class="proofscript" id="proof5" onclick="toggleDisplay('proof5');toggleDisplay('proofcontrol5')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">b</span>.<br/>

<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;Case&nbsp;"BTrue".&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">comp_correct</span>; <span class="id" type="tactic">intros</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;∃ <span class="id" type="var">st</span>; <span class="id" type="tactic">repeat</span> <span class="id" type="tactic">split</span>; <span class="id" type="tactic">try</span> <span class="id" type="tactic">red</span>; <span class="id" type="tactic">auto</span> <span class="id" type="keyword">using</span> <span class="id" type="var">star_refl</span>. <span class="id" type="tactic">discriminate</span>.<br/>

<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;Case&nbsp;"BFalse".&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">comp_correct</span>; <span class="id" type="tactic">intros</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;∃ <span class="id" type="var">st</span>; <span class="id" type="tactic">repeat</span> <span class="id" type="tactic">split</span>; <span class="id" type="tactic">try</span> <span class="id" type="tactic">red</span>; <span class="id" type="tactic">auto</span> <span class="id" type="keyword">using</span> <span class="id" type="var">star_refl</span>. <span class="id" type="tactic">discriminate</span>.<br/>

<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;Case&nbsp;"BEq".&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> (<span class="id" type="var">comp_bop_correct</span> <span class="id" type="var">bop_eq</span>); <span class="id" type="tactic">auto</span>.<br/>

<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;Case&nbsp;"BLe".&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> (<span class="id" type="var">comp_bop_correct</span> <span class="id" type="var">bop_le</span>); <span class="id" type="tactic">auto</span>.<br/>

<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;Case&nbsp;"BNot".&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>. <span class="id" type="var">evar</span> (<span class="id" type="var">SPEC</span> : <span class="id" type="var">mem</span> → <span class="id" type="var">nat</span>). <span class="id" type="tactic">replace</span> (<span class="id" type="keyword">fun</span> (<span class="id" type="var">m</span>:<span class="id" type="var">mem</span>) ⇒ <span class="id" type="var">b2n</span> <span class="id" type="var">_</span>) <span class="id" type="keyword">with</span> <span class="id" type="var">SPEC</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">SPEC</span>. <span class="id" type="tactic">apply</span> (<span class="id" type="var">comp_bop_correct</span> <span class="id" type="var">bop_eq</span>); <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">comp_correct</span>; <span class="id" type="tactic">intros</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">instantiate</span> (1:=<span class="id" type="keyword">fun</span> <span class="id" type="var">m</span> ⇒ 0).<br/>
&nbsp;&nbsp;∃ <span class="id" type="var">st</span>; <span class="id" type="tactic">repeat</span> <span class="id" type="tactic">split</span>; <span class="id" type="tactic">try</span> <span class="id" type="tactic">red</span>; <span class="id" type="tactic">auto</span> <span class="id" type="keyword">using</span> <span class="id" type="var">star_refl</span>. <span class="id" type="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">SPEC</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">functional_extensionality</span>. <span class="id" type="tactic">intro</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">beval</span> <span class="id" type="var">b</span> <span class="id" type="var">x</span>); <span class="id" type="tactic">auto</span>.<br/>

<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;Case&nbsp;"BAnd".&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>. <span class="id" type="var">evar</span> (<span class="id" type="var">SPEC</span> : <span class="id" type="var">mem</span> → <span class="id" type="var">nat</span>). <span class="id" type="tactic">replace</span> (<span class="id" type="keyword">fun</span> (<span class="id" type="var">m</span>:<span class="id" type="var">mem</span>) ⇒ <span class="id" type="var">b2n</span> <span class="id" type="var">_</span>) <span class="id" type="keyword">with</span> <span class="id" type="var">SPEC</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">SPEC</span>. <span class="id" type="tactic">apply</span> (<span class="id" type="var">comp_bop_correct</span> <span class="id" type="var">bop_and</span>); <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">SPEC</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">functional_extensionality</span>. <span class="id" type="tactic">intro</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">destruct</span> (<span class="id" type="var">beval</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">x</span>), (<span class="id" type="var">beval</span> <span class="id" type="var">b<sub>2</sub></span> <span class="id" type="var">x</span>); <span class="id" type="tactic">auto</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
</div>

<div class="doc">

<div class="paragraph"> </div>

<ul class="doclist">
<li> First we define some helper definitions for compiling assignments and 
    conditionals.
<ul class="doclist">
<li> To simplify the simulation: each store is compiled to its own basic block.

</li>
</ul>

</li>
<li> Then we define the command compilation context as a state monad.
<ul class="doclist">
<li> Generate fresh uids (like the <span class="inlinecode"><span class="id" type="var">ectmon</span></span>)

</li>
<li> Generate fresh block labels 

</li>
<li> Add instructions to the (partial) CFG

</li>
</ul>

</li>
<li> Then we define the translation of commands (recursively).

</li>
</ul>

</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">comp_store_correct</span> : <br/>
&nbsp;&nbsp;∀ <span class="id" type="var">g</span> <span class="id" type="var">a</span> <span class="id" type="var">v</span> <span class="id" type="var">le</span> <span class="id" type="var">lr</span> <span class="id" type="var">cs</span> <span class="id" type="var">st</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">insns_at_pc</span> <span class="id" type="var">g</span> (<span class="id" type="var">block_entry</span> <span class="id" type="var">le</span>) (<span class="id" type="var">strun</span> (<span class="id" type="var">comp_store</span> <span class="id" type="var">a</span> <span class="id" type="var">v</span> <span class="id" type="var">lr</span>) <span class="id" type="var">cs</span>) →<br/>
&nbsp;&nbsp;<span class="id" type="var">st_pc</span> <span class="id" type="var">st</span> = (<span class="id" type="var">block_entry</span> <span class="id" type="var">le</span>) →<br/>
&nbsp;&nbsp;∃ <span class="id" type="var">st'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">plus</span> (<span class="id" type="var">step</span> <span class="id" type="var">g</span>) <span class="id" type="var">st</span> <span class="id" type="var">st'</span> ∧<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">st_pc</span> <span class="id" type="var">st'</span> = (<span class="id" type="var">block_entry</span> <span class="id" type="var">lr</span>) ∧<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">st_mem</span> <span class="id" type="var">st'</span> = (<span class="id" type="var">Memory.update</span> (<span class="id" type="var">st_mem</span> <span class="id" type="var">st</span>) <span class="id" type="var">v</span> (<span class="id" type="var">aeval</span> <span class="id" type="var">a</span> (<span class="id" type="var">st_mem</span> <span class="id" type="var">st</span>))).<br/>
<div class="togglescript" id="proofcontrol6" onclick="toggleDisplay('proof6');toggleDisplay('proofcontrol6')"><span class="show"></span></div>
<div class="proofscript" id="proof6" onclick="toggleDisplay('proof6');toggleDisplay('proofcontrol6')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">strun</span>, <span class="id" type="var">comp_store</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">type</span> <span class="id" type="var">of</span> <span class="id" type="var">H</span> <span class="id" type="keyword">with</span> <span class="id" type="var">context</span>[<span class="id" type="keyword">let</span> (<span class="id" type="var">_</span>,_) := ?<span class="id" type="var">x</span> <span class="id" type="keyword">in</span> <span class="id" type="var">_</span>] ⇒ <span class="id" type="tactic">destruct</span> <span class="id" type="var">x</span> <span class="id" type="var">eqn</span>:<span class="id" type="var">Hc</span> <span class="id" type="keyword">end</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">p</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x</span> <span class="id" type="var">is</span>].<br/>
&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">symmetry</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hc</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H<sub>0</sub></span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">eelim</span> (<span class="id" type="var">comp_aexp_correct</span> <span class="id" type="var">a</span>); <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st'</span> <span class="id" type="var">H'</span>. <span class="id" type="var">decompose</span> [<span class="id" type="var">and</span>] <span class="id" type="var">H'</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H'</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">rename</span> <span class="id" type="var">st'</span> <span class="id" type="var">into</span> <span class="id" type="var">st''</span>. <span class="id" type="tactic">set</span> (<span class="id" type="var">st'</span> := <span class="id" type="var">st''</span>) <span class="id" type="keyword">in</span> *. <span class="id" type="tactic">destruct</span> <span class="id" type="var">st''</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="var">eexists</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">split</span>. <span class="id" type="tactic">eapply</span> <span class="id" type="var">plus_star_trans'</span>. <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">plus_left</span>. <span class="id" type="tactic">eapply</span> <span class="id" type="var">step_store</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H<sub>3</sub></span>. <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">star_step</span>. <span class="id" type="tactic">eapply</span> <span class="id" type="var">step_tmn</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H<sub>3</sub></span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H<sub>9</sub></span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">star_refl</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">split</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H<sub>1</sub></span>. <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">comp_cond_correct</span> :<br/>
&nbsp;&nbsp;∀ <span class="id" type="var">g</span> <span class="id" type="var">cs</span> <span class="id" type="var">b</span> <span class="id" type="var">le</span> <span class="id" type="var">l<sub>1</sub></span> <span class="id" type="var">l<sub>2</sub></span> <span class="id" type="var">st</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">insns_at_pc</span> <span class="id" type="var">g</span> (<span class="id" type="var">block_entry</span> <span class="id" type="var">le</span>) (<span class="id" type="var">strun</span> (<span class="id" type="var">comp_cond</span> <span class="id" type="var">b</span> <span class="id" type="var">l<sub>1</sub></span> <span class="id" type="var">l<sub>2</sub></span>) <span class="id" type="var">cs</span>) →<br/>
&nbsp;&nbsp;<span class="id" type="var">st_pc</span> <span class="id" type="var">st</span> = (<span class="id" type="var">block_entry</span> <span class="id" type="var">le</span>) →<br/>
&nbsp;&nbsp;∃ <span class="id" type="var">st'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">plus</span> (<span class="id" type="var">step</span> <span class="id" type="var">g</span>) <span class="id" type="var">st</span> <span class="id" type="var">st'</span> ∧<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">st_pc</span> <span class="id" type="var">st'</span> = <span class="id" type="var">block_entry</span> (<span class="id" type="keyword">if</span> <span class="id" type="var">beval</span> <span class="id" type="var">b</span> (<span class="id" type="var">st_mem</span> <span class="id" type="var">st</span>) <span class="id" type="keyword">then</span> <span class="id" type="var">l<sub>1</sub></span> <span class="id" type="keyword">else</span> <span class="id" type="var">l<sub>2</sub></span>) ∧<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">st_mem</span> <span class="id" type="var">st</span> = <span class="id" type="var">st_mem</span> <span class="id" type="var">st'</span>.<br/>
<div class="togglescript" id="proofcontrol7" onclick="toggleDisplay('proof7');toggleDisplay('proofcontrol7')"><span class="show"></span></div>
<div class="proofscript" id="proof7" onclick="toggleDisplay('proof7');toggleDisplay('proofcontrol7')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">strun</span>, <span class="id" type="var">comp_cond</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">type</span> <span class="id" type="var">of</span> <span class="id" type="var">H</span> <span class="id" type="keyword">with</span> <span class="id" type="var">context</span>[<span class="id" type="keyword">let</span> (<span class="id" type="var">_</span>,_) := ?<span class="id" type="var">x</span> <span class="id" type="keyword">in</span> <span class="id" type="var">_</span>] ⇒ <span class="id" type="tactic">destruct</span> <span class="id" type="var">x</span> <span class="id" type="var">eqn</span>:<span class="id" type="var">Hc</span> <span class="id" type="keyword">end</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">p</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">x</span> <span class="id" type="var">is</span>].<br/>
&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">symmetry</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hc</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H<sub>0</sub></span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">eelim</span> (<span class="id" type="var">comp_bexp_correct</span> <span class="id" type="var">b</span>); <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st'</span> <span class="id" type="var">H'</span>. <span class="id" type="var">decompose</span> [<span class="id" type="var">and</span>] <span class="id" type="var">H'</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H'</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">rename</span> <span class="id" type="var">st'</span> <span class="id" type="var">into</span> <span class="id" type="var">st''</span>. <span class="id" type="tactic">set</span> (<span class="id" type="var">st'</span> := <span class="id" type="var">st''</span>) <span class="id" type="keyword">in</span> *. <span class="id" type="tactic">destruct</span> <span class="id" type="var">st''</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="var">eexists</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">split</span>. <span class="id" type="tactic">eapply</span> <span class="id" type="var">plus_star_trans'</span>. <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">plus_one</span>. <span class="id" type="tactic">eapply</span> <span class="id" type="var">step_tmn</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">H<sub>3</sub></span>. <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> *. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H<sub>8</sub></span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">split</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">beval</span> <span class="id" type="var">b</span> (<span class="id" type="var">st_mem</span> <span class="id" type="var">st</span>)); <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">auto</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
<span class="comment">(*&nbsp;**&nbsp;Compiling&nbsp;Commands&nbsp;*)</span><br/>
</div>

<div class="doc">
State:

<div class="paragraph"> </div>

<ul class="doclist">
<li> list of used block labels

</li>
<li> list of used uids

</li>
<li> current cfg 
</li>
</ul>

</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">cstate</span> := (<span class="id" type="var">list</span> <span class="id" type="var">lbl</span> * <span class="id" type="var">list</span> <span class="id" type="var">uid</span> * <span class="id" type="var">list</span> <span class="id" type="var">ListCFG.block</span>)%<span class="id" type="var">type</span>.<br/>
<span class="id" type="keyword">Notation</span> <span class="id" type="var">ctmon</span> := (<span class="id" type="var">ST</span> <span class="id" type="var">cstate</span>).<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">fresh_lbl</span> : <span class="id" type="var">ctmon</span> <span class="id" type="var">lbl</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">fun</span> <span class="id" type="var">cs</span> ⇒<br/>
&nbsp;&nbsp;<span class="id" type="keyword">let</span> '(<span class="id" type="var">ls</span>, <span class="id" type="var">is</span>, <span class="id" type="var">bs</span>) := <span class="id" type="var">cs</span> <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">l</span> := <span class="id" type="var">Lbl.fresh</span> <span class="id" type="var">ls</span> <span class="id" type="keyword">in</span> <br/>
&nbsp;&nbsp;(<span class="id" type="var">l</span>::<span class="id" type="var">ls</span>, <span class="id" type="var">is</span>, <span class="id" type="var">ListCFG.update</span> <span class="id" type="var">bs</span> <span class="id" type="var">l</span> [], <span class="id" type="var">l</span>).<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">raise_ectmon</span> {<span class="id" type="var">T</span>} (<span class="id" type="var">ec</span>:<span class="id" type="var">ectmon</span> <span class="id" type="var">T</span>) : <span class="id" type="var">ctmon</span> <span class="id" type="var">T</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">fun</span> <span class="id" type="var">cs</span> ⇒<br/>
&nbsp;&nbsp;<span class="id" type="keyword">let</span> '(<span class="id" type="var">ls</span>, <span class="id" type="var">is</span>, <span class="id" type="var">cfg</span>) := <span class="id" type="var">cs</span> <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">let</span> (<span class="id" type="var">is'</span>, <span class="id" type="var">r</span>) := <span class="id" type="var">ec</span> <span class="id" type="var">is</span> <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;(<span class="id" type="var">ls</span>, <span class="id" type="var">is'</span>, <span class="id" type="var">cfg</span>, <span class="id" type="var">r</span>).<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">add_insns</span> (<span class="id" type="var">l</span>:<span class="id" type="var">lbl</span>) (<span class="id" type="var">b</span>:<span class="id" type="var">list</span> <span class="id" type="var">insn</span>) : <span class="id" type="var">ctmon</span> <span class="id" type="var">unit</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">fun</span> <span class="id" type="var">cs</span> ⇒<br/>
&nbsp;&nbsp;<span class="id" type="keyword">let</span> '(<span class="id" type="var">ls</span>, <span class="id" type="var">is</span>, <span class="id" type="var">cfg</span>) := <span class="id" type="var">cs</span> <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;(<span class="id" type="var">ls</span>, <span class="id" type="var">is</span>, <span class="id" type="var">ListCFG.update</span> <span class="id" type="var">cfg</span> <span class="id" type="var">l</span> <span class="id" type="var">b</span>, <span class="id" type="var">tt</span>).<br/>

<br/>
<span class="id" type="keyword">Open</span> <span class="id" type="keyword">Scope</span> <span class="id" type="var">imp_scope</span>.<br/>
</div>

<div class="doc">
<a name="lab66"></a><h1 class="section">Correctness?</h1>

<div class="paragraph"> </div>


<div class="paragraph"> </div>

<ul class="doclist">
<li> Vminus is deterministic
<ul class="doclist">
<li> Suffices to show a forward simulation. 
</li>
</ul>

</li>
</ul>

<div class="paragraph"> </div>

<a name="lab67"></a><h2 class="section">Simulation relation.</h2>

<div class="paragraph"> </div>

 Relate Imp commands to sequences of basic blocks in the cfg. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">match_config</span> : <span class="id" type="var">Imp.com</span> → (<span class="id" type="var">ListCFG.t</span> * <span class="id" type="var">lbl</span> * <span class="id" type="var">lbl</span>) → <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="var">MC_Skip</span> : ∀ <span class="id" type="var">bs</span> <span class="id" type="var">l</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">match_config</span> <span class="id" type="var">SKIP</span> (<span class="id" type="var">bs</span>, <span class="id" type="var">l</span>, <span class="id" type="var">l</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">MC_Ass</span> : ∀ <span class="id" type="var">g</span> <span class="id" type="var">l</span> <span class="id" type="var">l'</span> <span class="id" type="var">uid</span> <span class="id" type="var">a</span> <span class="id" type="var">cs</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">insns_at_pc</span> <span class="id" type="var">g</span> (<span class="id" type="var">block_entry</span> <span class="id" type="var">l</span>) (<span class="id" type="var">strun</span> (<span class="id" type="var">comp_store</span> <span class="id" type="var">a</span> <span class="id" type="var">uid</span> <span class="id" type="var">l'</span>) <span class="id" type="var">cs</span>) →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">match_config</span> (<span class="id" type="var">CAss</span> <span class="id" type="var">uid</span> <span class="id" type="var">a</span>) (<span class="id" type="var">g</span>, <span class="id" type="var">l</span>, <span class="id" type="var">l'</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">MC_Seq</span> : ∀ <span class="id" type="var">g</span> <span class="id" type="var">l<sub>1</sub></span> <span class="id" type="var">l<sub>2</sub></span> <span class="id" type="var">l<sub>3</sub></span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">c<sub>2</sub></span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">match_config</span> <span class="id" type="var">c<sub>1</sub></span> (<span class="id" type="var">g</span>, <span class="id" type="var">l<sub>1</sub></span>, <span class="id" type="var">l<sub>2</sub></span>) →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">match_config</span> <span class="id" type="var">c<sub>2</sub></span> (<span class="id" type="var">g</span>, <span class="id" type="var">l<sub>2</sub></span>, <span class="id" type="var">l<sub>3</sub></span>) →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">match_config</span> (<span class="id" type="var">CSeq</span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">c<sub>2</sub></span>) (<span class="id" type="var">g</span>, <span class="id" type="var">l<sub>1</sub></span>, <span class="id" type="var">l<sub>3</sub></span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">MC_If</span> : ∀ <span class="id" type="var">g</span> <span class="id" type="var">le</span> <span class="id" type="var">lr</span> <span class="id" type="var">l<sub>1</sub></span> <span class="id" type="var">l<sub>2</sub></span> <span class="id" type="var">b</span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">c<sub>2</sub></span> <span class="id" type="var">cs</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">match_config</span> <span class="id" type="var">c<sub>1</sub></span> (<span class="id" type="var">g</span>, <span class="id" type="var">l<sub>1</sub></span>, <span class="id" type="var">lr</span>) →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">match_config</span> <span class="id" type="var">c<sub>2</sub></span> (<span class="id" type="var">g</span>, <span class="id" type="var">l<sub>2</sub></span>, <span class="id" type="var">lr</span>) →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">insns_at_pc</span> <span class="id" type="var">g</span> (<span class="id" type="var">block_entry</span> <span class="id" type="var">le</span>) (<span class="id" type="var">strun</span> (<span class="id" type="var">comp_cond</span> <span class="id" type="var">b</span> <span class="id" type="var">l<sub>1</sub></span> <span class="id" type="var">l<sub>2</sub></span>) <span class="id" type="var">cs</span>) →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">match_config</span> (<span class="id" type="var">CIf</span> <span class="id" type="var">b</span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">c<sub>2</sub></span>) (<span class="id" type="var">g</span>, <span class="id" type="var">le</span>, <span class="id" type="var">lr</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">MC_While</span> : ∀ <span class="id" type="var">g</span> <span class="id" type="var">le</span> <span class="id" type="var">lb</span> <span class="id" type="var">lr</span> <span class="id" type="var">b</span> <span class="id" type="var">c</span> <span class="id" type="var">cs</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">match_config</span> <span class="id" type="var">c</span> (<span class="id" type="var">g</span>, <span class="id" type="var">lb</span>, <span class="id" type="var">le</span>) →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">insns_at_pc</span> <span class="id" type="var">g</span> (<span class="id" type="var">block_entry</span> <span class="id" type="var">le</span>) (<span class="id" type="var">strun</span> (<span class="id" type="var">comp_cond</span> <span class="id" type="var">b</span> <span class="id" type="var">lb</span> <span class="id" type="var">lr</span>) <span class="id" type="var">cs</span>) →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">match_config</span> (<span class="id" type="var">CWhile</span> <span class="id" type="var">b</span> <span class="id" type="var">c</span>) (<span class="id" type="var">g</span>, <span class="id" type="var">le</span>, <span class="id" type="var">lr</span>).<br/>

<br/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">match_states</span> (<span class="id" type="var">g</span>:<span class="id" type="var">ListCFG.t</span>) (<span class="id" type="var">r</span>:<span class="id" type="var">lbl</span>)<br/>
&nbsp;&nbsp;: (<span class="id" type="var">com</span> * <span class="id" type="var">Imp.state</span>) → <span class="id" type="var">state</span> → <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">match_states_intro</span> : ∀ <span class="id" type="var">c</span> <span class="id" type="var">mem</span> <span class="id" type="var">st</span> <span class="id" type="var">l</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">match_config</span> <span class="id" type="var">c</span> (<span class="id" type="var">g</span>, <span class="id" type="var">l</span>, <span class="id" type="var">r</span>) →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">st_pc</span> <span class="id" type="var">st</span> = <span class="id" type="var">block_entry</span> <span class="id" type="var">l</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">st_mem</span> <span class="id" type="var">st</span> = <span class="id" type="var">mem</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">match_states</span> <span class="id" type="var">g</span> <span class="id" type="var">r</span> (<span class="id" type="var">c</span>, <span class="id" type="var">mem</span>) <span class="id" type="var">st</span>.<br/>

<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">Program.Equality</span>.<br/>
</div>

<div class="doc">
<a name="lab68"></a><h2 class="section">Translation simulation: First try.</h2>

</div>
<div class="code code-space">

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">simulation_step'</span> :<br/>
&nbsp;&nbsp;∀ <span class="id" type="var">g</span> <span class="id" type="var">c</span> <span class="id" type="var">c'</span> <span class="id" type="var">mem</span> <span class="id" type="var">mem'</span> <span class="id" type="var">st</span> <span class="id" type="var">r</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">Imp.step</span> (<span class="id" type="var">c</span>, <span class="id" type="var">mem</span>) (<span class="id" type="var">c'</span>, <span class="id" type="var">mem'</span>) →<br/>
&nbsp;&nbsp;<span class="id" type="var">match_states</span> <span class="id" type="var">g</span> <span class="id" type="var">r</span> (<span class="id" type="var">c</span>, <span class="id" type="var">mem</span>) <span class="id" type="var">st</span> →<br/>
&nbsp;&nbsp;∃ <span class="id" type="var">st'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">star</span> (<span class="id" type="var">step</span> <span class="id" type="var">g</span>) <span class="id" type="var">st</span> <span class="id" type="var">st'</span> ∧<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">match_states</span> <span class="id" type="var">g</span> <span class="id" type="var">r</span> (<span class="id" type="var">c'</span>, <span class="id" type="var">mem'</span>) <span class="id" type="var">st'</span>.<br/>
<div class="togglescript" id="proofcontrol8" onclick="toggleDisplay('proof8');toggleDisplay('proofcontrol8')"><span class="show"></span></div>
<div class="proofscript" id="proof8" onclick="toggleDisplay('proof8');toggleDisplay('proofcontrol8')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span>. <span class="id" type="tactic">generalize</span> <span class="id" type="tactic">dependent</span> <span class="id" type="var">st</span>. <span class="id" type="var">revert</span> <span class="id" type="var">r</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="tactic">dependent</span> <span class="id" type="tactic">induction</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intros</span>;<br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H<sub>0</sub></span> <span class="id" type="keyword">as</span> [? ? ? ? <span class="id" type="var">H'</span>]; <span class="id" type="tactic">inversion</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">subst</span>.<br/>

<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;Case&nbsp;"S_Ass".&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">comp_store_correct</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H<sub>6</sub></span> <span class="id" type="keyword">as</span> [<span class="id" type="var">st'</span> [? [? ?]]]; <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">eexists</span>. <span class="id" type="tactic">split</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">plus_star</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H<sub>1</sub></span>. <span class="id" type="var">econstructor</span>; <span class="id" type="tactic">eauto</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">MC_Skip</span>.<br/>

<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;Case&nbsp;"S_Seq".&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">specialize</span> (<span class="id" type="var">IHstep</span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">c<sub>1</sub>'</span> (<span class="id" type="var">st_mem</span> <span class="id" type="var">st</span>) <span class="id" type="var">mem'</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">pose</span> (<span class="id" type="var">K</span>:=<span class="id" type="var">IHstep</span> <span class="id" type="var">ltac</span>:(<span class="id" type="tactic">auto</span>) <span class="id" type="var">ltac</span>:(<span class="id" type="tactic">auto</span>)); <span class="id" type="var">clearbody</span> <span class="id" type="var">K</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">IHstep</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">specialize</span> (<span class="id" type="var">K</span> <span class="id" type="var">l<sub>2</sub></span> <span class="id" type="var">st</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">lapply</span> <span class="id" type="var">K</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> [<span class="id" type="var">st'</span> [? ?]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;∃ <span class="id" type="var">st'</span>. <span class="id" type="tactic">split</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H<sub>3</sub></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">econstructor</span>; <span class="id" type="tactic">eauto</span>. <span class="id" type="var">econstructor</span>; <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">econstructor</span>; <span class="id" type="tactic">eauto</span>.<br/>

<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;Case&nbsp;"S_SeqSkip".&nbsp;*)</span><br/>
&nbsp;&nbsp;∃ <span class="id" type="var">st</span>. <span class="id" type="tactic">split</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">star_refl</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H'</span>; <span class="id" type="tactic">subst</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H<sub>4</sub></span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">econstructor</span>; <span class="id" type="tactic">eauto</span>.<br/>

<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;Case&nbsp;"S_IfTrue".&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">comp_cond_correct</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H<sub>14</sub></span> <span class="id" type="keyword">as</span> [<span class="id" type="var">st'</span> [? [? ?]]].<br/>
&nbsp;&nbsp;∃ <span class="id" type="var">st'</span>. <span class="id" type="tactic">split</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">plus_star</span>; <span class="id" type="tactic">eauto</span>. <span class="id" type="var">econstructor</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eauto</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H<sub>3</sub></span>. <span class="id" type="tactic">auto</span>. <span class="id" type="tactic">symmetry</span>; <span class="id" type="tactic">auto</span>. <span class="id" type="tactic">auto</span>.<br/>

<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;Case&nbsp;"S_IfFalse".&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">comp_cond_correct</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H<sub>14</sub></span> <span class="id" type="keyword">as</span> [<span class="id" type="var">st'</span> [? [? ?]]].<br/>
&nbsp;&nbsp;∃ <span class="id" type="var">st'</span>. <span class="id" type="tactic">split</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">plus_star</span>; <span class="id" type="tactic">eauto</span>. <span class="id" type="var">econstructor</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eauto</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H<sub>3</sub></span>. <span class="id" type="tactic">auto</span>. <span class="id" type="tactic">symmetry</span>; <span class="id" type="tactic">auto</span>. <span class="id" type="tactic">auto</span>.<br/>

<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;Case&nbsp;"S_While".&nbsp;*)</span><br/>
&nbsp;&nbsp;∃ <span class="id" type="var">st</span>. <span class="id" type="tactic">split</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">star_refl</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">econstructor</span>; <span class="id" type="tactic">eauto</span>. <span class="id" type="tactic">eapply</span> <span class="id" type="var">MC_If</span>; <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">econstructor</span>; <span class="id" type="tactic">eauto</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">MC_Skip</span>; <span class="id" type="tactic">eauto</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
</div>

<div class="doc">
<a name="lab69"></a><h1 class="section">Stuttering</h1>

<div class="paragraph"> </div>

 The proof above goes through, but does not ensure that if the
    source program diverges the compiled program does not go wrong! 

<div class="paragraph"> </div>

    To fix it, we need to ensure that there is no "infinite stuttering"
    in which the source program takes an infinite number of steps while 
    the target terminates (or gets stuck).

<div class="paragraph"> </div>

<a name="lab70"></a><h2 class="section">Eliminating Stuttering</h2>

<div class="paragraph"> </div>

 First, define an appropriate measure. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">num_skips</span> (<span class="id" type="var">c</span>:<span class="id" type="var">com</span>) : <span class="id" type="var">nat</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">c</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">c<sub>1</sub></span> ;; <span class="id" type="var">c<sub>2</sub></span>) ⇒ <span class="id" type="var">num_skips</span> <span class="id" type="var">c<sub>1</sub></span> + <span class="id" type="var">num_skips</span> <span class="id" type="var">c<sub>2</sub></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">SKIP</span> ⇒ 2<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">_</span> ⇒ 0<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">while_head</span> (<span class="id" type="var">c</span>:<span class="id" type="var">com</span>) : <span class="id" type="var">nat</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">c</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">c<sub>1</sub></span> ;; <span class="id" type="var">_</span>) ⇒ <span class="id" type="var">while_head</span> <span class="id" type="var">c<sub>1</sub></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">WHILE</span> <span class="id" type="var">_</span> <span class="id" type="var">DO</span> <span class="id" type="var">_</span> <span class="id" type="var">END</span> ⇒ 1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">_</span> ⇒ 0<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">com_size</span> (<span class="id" type="var">c</span>:<span class="id" type="var">com</span>) : <span class="id" type="var">nat</span> := <span class="id" type="var">num_skips</span> <span class="id" type="var">c</span> + <span class="id" type="var">while_head</span> <span class="id" type="var">c</span>.<br/>
</div>

<div class="doc">
<a name="lab71"></a><h2 class="section">Lemmas about the measure.</h2>

</div>
<div class="code code-space">

<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">Omega</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">while_head_bound</span> : ∀ <span class="id" type="var">c</span>, <span class="id" type="var">while_head</span> <span class="id" type="var">c</span> &lt; 2.<br/>
<div class="togglescript" id="proofcontrol9" onclick="toggleDisplay('proof9');toggleDisplay('proofcontrol9')"><span class="show"></span></div>
<div class="proofscript" id="proof9" onclick="toggleDisplay('proof9');toggleDisplay('proofcontrol9')">
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">induction</span> <span class="id" type="var">c</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">omega</span>. <span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">com_size_seq</span> : ∀ <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">c<sub>1</sub>'</span> <span class="id" type="var">c<sub>2</sub></span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">com_size</span> <span class="id" type="var">c<sub>1</sub>'</span> &lt; <span class="id" type="var">com_size</span> <span class="id" type="var">c<sub>1</sub></span> →<br/>
&nbsp;&nbsp;<span class="id" type="var">com_size</span> (<span class="id" type="var">c<sub>1</sub>'</span>;; <span class="id" type="var">c<sub>2</sub></span>) &lt; <span class="id" type="var">com_size</span> (<span class="id" type="var">c<sub>1</sub></span>;; <span class="id" type="var">c<sub>2</sub></span>).<br/>
<div class="togglescript" id="proofcontrol10" onclick="toggleDisplay('proof10');toggleDisplay('proofcontrol10')"><span class="show"></span></div>
<div class="proofscript" id="proof10" onclick="toggleDisplay('proof10');toggleDisplay('proofcontrol10')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">com_size</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">c<sub>1</sub></span>, <span class="id" type="var">c<sub>1</sub>'</span>; <br/>
&nbsp;&nbsp;<span class="id" type="tactic">try</span> <span class="id" type="var">solve</span> [<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">omega</span>].<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">com_size_seqskip</span> : ∀ <span class="id" type="var">c</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">com_size</span> <span class="id" type="var">c</span> &lt; <span class="id" type="var">com_size</span> (<span class="id" type="var">SKIP</span>;; <span class="id" type="var">c</span>).<br/>
<div class="togglescript" id="proofcontrol11" onclick="toggleDisplay('proof11');toggleDisplay('proofcontrol11')"><span class="show"></span></div>
<div class="proofscript" id="proof11" onclick="toggleDisplay('proof11');toggleDisplay('proofcontrol11')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">com_size</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">c</span>;<br/>
&nbsp;&nbsp;<span class="id" type="tactic">try</span> <span class="id" type="var">solve</span> [<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">try</span> <span class="id" type="keyword">match</span> <span class="id" type="var">goal</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| |- <span class="id" type="var">context</span>[<span class="id" type="var">while_head</span> ?<span class="id" type="var">X</span>] ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">pose</span> <span class="id" type="var">proof</span> (<span class="id" type="var">while_head_bound</span> <span class="id" type="var">X</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">omega</span>].<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="comment">(*&nbsp;lift&nbsp;to&nbsp;states&nbsp;*)</span><br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">imp_size</span> (<span class="id" type="var">st</span>:<span class="id" type="var">com</span> * <span class="id" type="var">mem</span>) : <span class="id" type="var">nat</span> := <br/>
&nbsp;&nbsp;<span class="id" type="keyword">let</span> (<span class="id" type="var">c</span>, <span class="id" type="var">_</span>) := <span class="id" type="var">st</span> <span class="id" type="keyword">in</span> <span class="id" type="var">com_size</span> <span class="id" type="var">c</span>.<br/>
</div>

<br/>
<span class="id" type="keyword">Local</span> <span class="id" type="keyword">Hint</span> <span class="id" type="var">Constructors</span> <span class="id" type="var">match_config</span>.<br/>
<span class="id" type="keyword">Hint</span> <span class="id" type="keyword">Resolve</span> <span class="id" type="var">com_size_seqskip</span> <span class="id" type="var">com_size_seq</span>.<br/>
</div>

<div class="doc">
<a name="lab72"></a><h2 class="section">Final simulation relation.</h2>

</div>
<div class="code code-space">

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">transl_sim_step_final</span> :<br/>
&nbsp;&nbsp;∀ <span class="id" type="var">g</span> <span class="id" type="var">r</span> <span class="id" type="var">imp_st</span> <span class="id" type="var">imp_st'</span> <span class="id" type="var">vmn_st</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">Imp.step</span> <span class="id" type="var">imp_st</span> <span class="id" type="var">imp_st'</span> →<br/>
&nbsp;&nbsp;<span class="id" type="var">match_states</span> <span class="id" type="var">g</span> <span class="id" type="var">r</span> <span class="id" type="var">imp_st</span> <span class="id" type="var">vmn_st</span> →<br/>
&nbsp;&nbsp;∃ <span class="id" type="var">vmn_st'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">plus</span> (<span class="id" type="var">step</span> <span class="id" type="var">g</span>) <span class="id" type="var">vmn_st</span> <span class="id" type="var">vmn_st'</span> ∨<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">star</span> (<span class="id" type="var">step</span> <span class="id" type="var">g</span>) <span class="id" type="var">vmn_st</span> <span class="id" type="var">vmn_st'</span> ∧ <span class="id" type="var">imp_size</span> <span class="id" type="var">imp_st'</span> &lt; <span class="id" type="var">imp_size</span> <span class="id" type="var">imp_st</span>) ∧<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">match_states</span> <span class="id" type="var">g</span> <span class="id" type="var">r</span> <span class="id" type="var">imp_st'</span> <span class="id" type="var">vmn_st'</span>.<br/>
<div class="togglescript" id="proofcontrol12" onclick="toggleDisplay('proof12');toggleDisplay('proofcontrol12')"><span class="show"></span></div>
<div class="proofscript" id="proof12" onclick="toggleDisplay('proof12');toggleDisplay('proofcontrol12')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span>. <span class="id" type="tactic">generalize</span> <span class="id" type="tactic">dependent</span> <span class="id" type="var">vmn_st</span>. <span class="id" type="var">revert</span> <span class="id" type="var">r</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="tactic">dependent</span> <span class="id" type="tactic">induction</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">r</span> <span class="id" type="var">vmn_st</span> <span class="id" type="var">Hst</span>;<br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Hst</span> <span class="id" type="keyword">as</span> [? ? ? ? <span class="id" type="var">Hcfg</span>]; <span class="id" type="tactic">inversion</span> <span class="id" type="var">Hcfg</span>; <span class="id" type="tactic">subst</span>.<br/>

<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;Case&nbsp;"S_Ass".&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">comp_store_correct</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H<sub>6</sub></span> <span class="id" type="keyword">as</span> [<span class="id" type="var">st'</span> [? [? ?]]]; <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">eexists</span>. <span class="id" type="tactic">split</span>; <span class="id" type="tactic">eauto</span>. <span class="id" type="var">econstructor</span>; <span class="id" type="tactic">eauto</span>.<br/>

<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;Case&nbsp;"S_Seq".&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="var">specialize</span> (<span class="id" type="var">IHstep</span> <span class="id" type="var">l<sub>2</sub></span> <span class="id" type="var">vmn_st</span>).<br/>
&nbsp;&nbsp;<span class="id" type="var">lapply</span> <span class="id" type="var">IHstep</span>. <span class="id" type="tactic">intros</span> [<span class="id" type="var">vmn_st'</span> [? ?]]. ∃ <span class="id" type="var">vmn_st'</span>. <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> *; <span class="id" type="tactic">intuition</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H<sub>2</sub></span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">econstructor</span>; <span class="id" type="tactic">eauto</span>. <span class="id" type="var">econstructor</span>; <span class="id" type="tactic">eauto</span>.<br/>

<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;Case&nbsp;"S_SeqSkip".&nbsp;*)</span><br/>
&nbsp;&nbsp;∃ <span class="id" type="var">vmn_st</span>. <span class="id" type="tactic">split</span>. <span class="id" type="var">right</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">split</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">star_refl</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">imp_size</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intuition</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H<sub>7</sub></span>; <span class="id" type="tactic">subst</span>. <span class="id" type="var">econstructor</span>; <span class="id" type="tactic">eauto</span>.<br/>

<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;Case&nbsp;"S_IfTrue".&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">comp_cond_correct</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H<sub>13</sub></span> <span class="id" type="keyword">as</span> [<span class="id" type="var">st'</span> [? [? ?]]]; <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;∃ <span class="id" type="var">st'</span>. <span class="id" type="tactic">split</span>; <span class="id" type="tactic">eauto</span>. <span class="id" type="var">econstructor</span>; <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H<sub>2</sub></span>; <span class="id" type="tactic">auto</span>.<br/>

<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;Case&nbsp;"S_IfFalse".&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">comp_cond_correct</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H<sub>13</sub></span> <span class="id" type="keyword">as</span> [<span class="id" type="var">st'</span> [? [? ?]]]; <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;∃ <span class="id" type="var">st'</span>. <span class="id" type="tactic">split</span>; <span class="id" type="tactic">eauto</span>. <span class="id" type="var">econstructor</span>; <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H<sub>2</sub></span>; <span class="id" type="tactic">auto</span>.<br/>

<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;Case&nbsp;"S_While".&nbsp;*)</span><br/>
&nbsp;&nbsp;∃ <span class="id" type="var">vmn_st</span>. <span class="id" type="tactic">split</span>. <span class="id" type="var">right</span>; <span class="id" type="tactic">intuition</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">star_refl</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">econstructor</span>; <span class="id" type="tactic">eauto</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
</div>

<div class="doc">
Is this enough? 
<div class="paragraph"> </div>

<a name="lab73"></a><h2 class="section">Relating initial states</h2>

<div class="paragraph"> </div>

 We still must relate the initial states! 
<div class="paragraph"> </div>

 First, some helpers: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">Vminus.LtacDebug</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">comp_store_not_nil</span> : ∀ <span class="id" type="var">a</span> <span class="id" type="var">v</span> <span class="id" type="var">l</span> <span class="id" type="var">cs</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">strun</span> (<span class="id" type="var">comp_store</span> <span class="id" type="var">a</span> <span class="id" type="var">v</span> <span class="id" type="var">l</span>) <span class="id" type="var">cs</span> ≠ [].<br/>
<div class="togglescript" id="proofcontrol13" onclick="toggleDisplay('proof13');toggleDisplay('proofcontrol13')"><span class="show"></span></div>
<div class="proofscript" id="proof13" onclick="toggleDisplay('proof13');toggleDisplay('proofcontrol13')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">strun</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">remember</span> (<span class="id" type="var">comp_store</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="keyword">as</span> <span class="id" type="var">ma</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">comp_store</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heqma</span>. <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heqma</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">type</span> <span class="id" type="var">of</span> <span class="id" type="var">Heqma</span> <span class="id" type="keyword">with</span> <span class="id" type="var">context</span>[<span class="id" type="keyword">let</span> (<span class="id" type="var">_</span>,_) := ?<span class="id" type="var">x</span> <span class="id" type="keyword">in</span> <span class="id" type="var">_</span>] ⇒ <span class="id" type="tactic">destruct</span> <span class="id" type="var">x</span> <span class="id" type="var">eqn</span>:<span class="id" type="var">Hc</span> <span class="id" type="keyword">end</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">p</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v'</span> <span class="id" type="var">is</span>].<br/>
&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">ma</span>; <span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">intro</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">app_cons_not_nil</span>; <span class="id" type="tactic">eauto</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">comp_cond_not_nil</span> : ∀ <span class="id" type="var">b</span> <span class="id" type="var">v</span> <span class="id" type="var">l</span> <span class="id" type="var">cs</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">strun</span> (<span class="id" type="var">comp_cond</span> <span class="id" type="var">b</span> <span class="id" type="var">v</span> <span class="id" type="var">l</span>) <span class="id" type="var">cs</span> ≠ [].<br/>
<div class="togglescript" id="proofcontrol14" onclick="toggleDisplay('proof14');toggleDisplay('proofcontrol14')"><span class="show"></span></div>
<div class="proofscript" id="proof14" onclick="toggleDisplay('proof14');toggleDisplay('proofcontrol14')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">strun</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">remember</span> (<span class="id" type="var">comp_cond</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="keyword">as</span> <span class="id" type="var">ma</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">comp_cond</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heqma</span>. <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heqma</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">type</span> <span class="id" type="var">of</span> <span class="id" type="var">Heqma</span> <span class="id" type="keyword">with</span> <span class="id" type="var">context</span>[<span class="id" type="keyword">let</span> (<span class="id" type="var">_</span>,_) := ?<span class="id" type="var">x</span> <span class="id" type="keyword">in</span> <span class="id" type="var">_</span>] ⇒ <span class="id" type="tactic">destruct</span> <span class="id" type="var">x</span> <span class="id" type="var">eqn</span>:<span class="id" type="var">Hc</span> <span class="id" type="keyword">end</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">p</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">v'</span> <span class="id" type="var">is</span>].<br/>
&nbsp;&nbsp;<span class="id" type="tactic">subst</span> <span class="id" type="var">ma</span>; <span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">intro</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">app_cons_not_nil</span>; <span class="id" type="tactic">eauto</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
</div>

<div class="doc">
<a name="lab74"></a><h2 class="section">Compilation invariant</h2>

<div class="paragraph"> </div>

 Compilation only "extends" the compilation state:

<div class="paragraph"> </div>

<ul class="doclist">
<li> Uids and labels change only monotonically.

</li>
<li> Compilation never removes code.

</li>
</ul>
  
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">cstate_incr</span> : <span class="id" type="var">cstate</span> → <span class="id" type="var">cstate</span> → <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">cstate_incr_intro</span> : ∀ <span class="id" type="var">ls</span> <span class="id" type="var">ls'</span> <span class="id" type="var">ids</span> <span class="id" type="var">ids'</span> <span class="id" type="var">g</span> <span class="id" type="var">g'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(∀ <span class="id" type="var">l</span>, <span class="id" type="var">In</span> <span class="id" type="var">l</span> <span class="id" type="var">ls</span> → <span class="id" type="var">In</span> <span class="id" type="var">l</span> <span class="id" type="var">ls'</span>) →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(∀ <span class="id" type="var">l</span> <span class="id" type="var">is</span>, <span class="id" type="var">In</span> <span class="id" type="var">l</span> <span class="id" type="var">ls</span> → <span class="id" type="var">is</span> ≠ <span class="id" type="var">nil</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ListCFG.lookup</span> <span class="id" type="var">g</span>  <span class="id" type="var">l</span> = <span class="id" type="var">Some</span> <span class="id" type="var">is</span> → <span class="id" type="var">ListCFG.lookup</span> <span class="id" type="var">g'</span> <span class="id" type="var">l</span> = <span class="id" type="var">Some</span> <span class="id" type="var">is</span>) →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">cstate_incr</span> (<span class="id" type="var">ls</span>, <span class="id" type="var">ids</span>, <span class="id" type="var">g</span>) (<span class="id" type="var">ls'</span>, <span class="id" type="var">ids'</span>, <span class="id" type="var">g'</span>).<br/>

<br/>
<span class="id" type="keyword">Instance</span> <span class="id" type="var">cstate_incr_trans</span> : <span class="id" type="var">Transitive</span> <span class="id" type="var">cstate_incr</span>.<br/>
<div class="togglescript" id="proofcontrol15" onclick="toggleDisplay('proof15');toggleDisplay('proofcontrol15')"><span class="show"></span></div>
<div class="proofscript" id="proof15" onclick="toggleDisplay('proof15');toggleDisplay('proofcontrol15')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">red</span>. <span class="id" type="tactic">inversion</span> 1. <span class="id" type="tactic">inversion</span> 1. <span class="id" type="var">constructor</span>; <span class="id" type="tactic">intuition</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">cstate_incr_strong</span> : <span class="id" type="var">cstate</span> → <span class="id" type="var">cstate</span> → <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">cstate_incr_strong_intro</span> : ∀ <span class="id" type="var">ls</span> <span class="id" type="var">ls'</span> <span class="id" type="var">ids</span> <span class="id" type="var">ids'</span> <span class="id" type="var">g</span> <span class="id" type="var">g'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(∀ <span class="id" type="var">l</span>, <span class="id" type="var">In</span> <span class="id" type="var">l</span> <span class="id" type="var">ls</span> → <span class="id" type="var">In</span> <span class="id" type="var">l</span> <span class="id" type="var">ls'</span>) →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(∀ <span class="id" type="var">l</span>, <span class="id" type="var">In</span> <span class="id" type="var">l</span> <span class="id" type="var">ls</span> → <span class="id" type="var">ListCFG.lookup</span> <span class="id" type="var">g</span> <span class="id" type="var">l</span> = <span class="id" type="var">ListCFG.lookup</span> <span class="id" type="var">g'</span> <span class="id" type="var">l</span>) →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">cstate_incr_strong</span> (<span class="id" type="var">ls</span>, <span class="id" type="var">ids</span>, <span class="id" type="var">g</span>) (<span class="id" type="var">ls'</span>, <span class="id" type="var">ids'</span>, <span class="id" type="var">g'</span>).<br/>

<br/>
<span class="id" type="keyword">Instance</span> <span class="id" type="var">cstate_incr_strong_trans</span> : <span class="id" type="var">Transitive</span> <span class="id" type="var">cstate_incr_strong</span>.<br/>
<div class="togglescript" id="proofcontrol16" onclick="toggleDisplay('proof16');toggleDisplay('proofcontrol16')"><span class="show"></span></div>
<div class="proofscript" id="proof16" onclick="toggleDisplay('proof16');toggleDisplay('proofcontrol16')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">red</span>. <span class="id" type="tactic">inversion</span> 1. <span class="id" type="tactic">inversion</span> 1. <span class="id" type="tactic">subst</span>. <span class="id" type="var">constructor</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">auto</span>. <span class="id" type="tactic">intros</span>. <span class="id" type="tactic">transitivity</span> (<span class="id" type="var">ListCFG.lookup</span> <span class="id" type="var">g'</span> <span class="id" type="var">l</span>); <span class="id" type="tactic">eauto</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
<span class="id" type="keyword">Instance</span> <span class="id" type="var">cstate_incr_strong_refl</span> : <span class="id" type="var">Reflexive</span> <span class="id" type="var">cstate_incr_strong</span>.<br/>
<div class="togglescript" id="proofcontrol17" onclick="toggleDisplay('proof17');toggleDisplay('proofcontrol17')"><span class="show"></span></div>
<div class="proofscript" id="proof17" onclick="toggleDisplay('proof17');toggleDisplay('proofcontrol17')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">red</span>. <span class="id" type="tactic">intro</span> <span class="id" type="var">cs</span>. <span class="id" type="tactic">destruct</span> <span class="id" type="var">cs</span> <span class="id" type="keyword">as</span> [[? ?] ?]. <span class="id" type="var">constructor</span>; <span class="id" type="tactic">auto</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">add_insns_incr</span> : ∀ <span class="id" type="var">l</span> <span class="id" type="var">is</span> <span class="id" type="var">g</span> <span class="id" type="var">ls</span> <span class="id" type="var">ids</span> <span class="id" type="var">cs'</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">ListCFG.lookup</span> <span class="id" type="var">g</span> <span class="id" type="var">l</span> = <span class="id" type="var">Some</span> [] →<br/>
&nbsp;&nbsp;<span class="id" type="var">add_insns</span> <span class="id" type="var">l</span> <span class="id" type="var">is</span> (<span class="id" type="var">ls</span>, <span class="id" type="var">ids</span>, <span class="id" type="var">g</span>) = (<span class="id" type="var">cs'</span>, <span class="id" type="var">tt</span>) →<br/>
&nbsp;&nbsp;<span class="id" type="var">cstate_incr</span> (<span class="id" type="var">ls</span>, <span class="id" type="var">ids</span>, <span class="id" type="var">g</span>) <span class="id" type="var">cs'</span>.<br/>
<div class="togglescript" id="proofcontrol18" onclick="toggleDisplay('proof18');toggleDisplay('proofcontrol18')"><span class="show"></span></div>
<div class="proofscript" id="proof18" onclick="toggleDisplay('proof18');toggleDisplay('proofcontrol18')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">cs'</span> <span class="id" type="keyword">as</span> [[? ?] ?]. <span class="id" type="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">constructor</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H<sub>0</sub></span>; <span class="id" type="tactic">intuition</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H<sub>0</sub></span>; <span class="id" type="tactic">subst</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">ListCFG.update_neq</span>. <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">contradict</span> <span class="id" type="var">H<sub>2</sub></span>. <span class="id" type="tactic">subst</span> <span class="id" type="var">l</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H<sub>3</sub></span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">injection</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">auto</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">ectmon_incr_strong</span> : <br/>
&nbsp;&nbsp;∀ (<span class="id" type="var">A</span>:<span class="id" type="keyword">Type</span>) (<span class="id" type="var">m</span>:<span class="id" type="var">ectmon</span> <span class="id" type="var">A</span>) (<span class="id" type="var">r</span>:<span class="id" type="var">A</span>) <span class="id" type="var">cs</span> <span class="id" type="var">cs'</span> ,<br/>
&nbsp;&nbsp;<span class="id" type="var">raise_ectmon</span> <span class="id" type="var">m</span> <span class="id" type="var">cs</span> = (<span class="id" type="var">cs'</span>, <span class="id" type="var">r</span>) →<br/>
&nbsp;&nbsp;<span class="id" type="var">cstate_incr_strong</span> <span class="id" type="var">cs</span> <span class="id" type="var">cs'</span>.<br/>
<div class="togglescript" id="proofcontrol19" onclick="toggleDisplay('proof19');toggleDisplay('proofcontrol19')"><span class="show"></span></div>
<div class="proofscript" id="proof19" onclick="toggleDisplay('proof19');toggleDisplay('proofcontrol19')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">cs</span> <span class="id" type="keyword">as</span> [[? ?] ?], <span class="id" type="var">cs'</span> <span class="id" type="keyword">as</span> [[? ?] ?].<br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> 1.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">m</span> <span class="id" type="var">l<sub>0</sub></span>). <span class="id" type="tactic">inversion</span> <span class="id" type="var">H<sub>1</sub></span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H<sub>1</sub></span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">constructor</span>; <span class="id" type="tactic">auto</span>; <span class="id" type="tactic">intros</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">fresh_add_incr_strong</span> :<br/>
&nbsp;&nbsp;∀ <span class="id" type="var">l</span> <span class="id" type="var">is</span> <span class="id" type="var">cs<sub>1</sub></span> <span class="id" type="var">cs<sub>2</sub></span> <span class="id" type="var">cs<sub>3</sub></span> <span class="id" type="var">cs<sub>4</sub></span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">fresh_lbl</span> <span class="id" type="var">cs<sub>1</sub></span> = (<span class="id" type="var">cs<sub>2</sub></span>, <span class="id" type="var">l</span>) →<br/>
&nbsp;&nbsp;<span class="id" type="var">cstate_incr_strong</span> <span class="id" type="var">cs<sub>2</sub></span> <span class="id" type="var">cs<sub>3</sub></span> →<br/>
&nbsp;&nbsp;<span class="id" type="var">add_insns</span> <span class="id" type="var">l</span> <span class="id" type="var">is</span> <span class="id" type="var">cs<sub>3</sub></span> = (<span class="id" type="var">cs<sub>4</sub></span>, <span class="id" type="var">tt</span>) →<br/>
&nbsp;&nbsp;<span class="id" type="var">cstate_incr_strong</span> <span class="id" type="var">cs<sub>1</sub></span> <span class="id" type="var">cs<sub>4</sub></span>.<br/>
<div class="togglescript" id="proofcontrol20" onclick="toggleDisplay('proof20');toggleDisplay('proofcontrol20')"><span class="show"></span></div>
<div class="proofscript" id="proof20" onclick="toggleDisplay('proof20');toggleDisplay('proofcontrol20')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">until</span> <span class="id" type="var">cs<sub>4</sub></span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">Hfresh</span> <span class="id" type="var">Hincr</span> <span class="id" type="var">Hadd</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">cs<sub>1</sub></span> <span class="id" type="keyword">as</span> [[? ?] ?], <span class="id" type="var">cs<sub>2</sub></span> <span class="id" type="keyword">as</span> [[? ?] ?],<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">cs<sub>3</sub></span> <span class="id" type="keyword">as</span> [[? ?] ?], <span class="id" type="var">cs<sub>4</sub></span> <span class="id" type="keyword">as</span> [[? ?] ?].<br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Hadd</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">Hfresh</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">Hincr</span>; <span class="id" type="tactic">subst</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="var">constructor</span>; <span class="id" type="tactic">intros</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H<sub>8</sub></span>. <span class="id" type="var">right</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">Lbl.fresh</span> <span class="id" type="var">l<sub>0</sub></span> ≠ <span class="id" type="var">l</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">contradict</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">Lbl.fresh_not_in</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">ListCFG.update_neq</span>; <span class="id" type="tactic">auto</span>. <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H<sub>13</sub></span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">ListCFG.update_neq</span>; <span class="id" type="tactic">auto</span>. <span class="id" type="var">right</span>; <span class="id" type="tactic">auto</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
<span class="id" type="keyword">Ltac</span> <span class="id" type="var">bind_step</span> <span class="id" type="var">H</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">type</span> <span class="id" type="var">of</span> <span class="id" type="var">H</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">context</span>[<span class="id" type="keyword">let</span> (<span class="id" type="var">_</span>,_) := ?<span class="id" type="var">b</span> <span class="id" type="keyword">in</span> <span class="id" type="var">_</span>] ⇒ <span class="id" type="tactic">destruct</span> <span class="id" type="var">b</span> <span class="id" type="keyword">as</span> [?<span class="id" type="var">x</span> ?<span class="id" type="var">y</span>] <span class="id" type="var">eqn</span>:?<span class="id" type="var">Hb</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Ltac</span> <span class="id" type="var">compile</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="tactic">repeat</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">goal</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| [ <span class="id" type="var">x</span> : <span class="id" type="var">Compiler.cstate</span> |- <span class="id" type="var">_</span>] ⇒ <span class="id" type="tactic">destruct</span> <span class="id" type="var">x</span> <span class="id" type="keyword">as</span> [[?<span class="id" type="var">lbls</span> ?<span class="id" type="var">ids</span>] ?<span class="id" type="var">bs</span>] <br/>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;<span class="inlinecode"></span> <span class="inlinecode"><span class="id" type="var">H</span></span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" type="var">context</span>[<span class="id" type="var">Compiler.add_insns</span></span> <span class="inlinecode"><span class="id" type="var">_</span></span> <span class="inlinecode"><span class="id" type="var">_</span></span> <span class="inlinecode"><span class="id" type="var">_</span>]</span> <span class="inlinecode">|-</span> <span class="inlinecode"><span class="id" type="var">_</span></span> <span class="inlinecode"></span>&nbsp;=&gt;&nbsp;simpl&nbsp;in&nbsp;H&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| [ <span class="id" type="var">H</span> : <span class="id" type="var">context</span>[<span class="id" type="keyword">let</span> (<span class="id" type="var">_</span>,_) := ?<span class="id" type="var">x</span> <span class="id" type="keyword">in</span> <span class="id" type="var">_</span>] |- <span class="id" type="var">_</span>] ⇒ <span class="id" type="tactic">destruct</span> <span class="id" type="var">x</span> <span class="id" type="keyword">as</span> [?<span class="id" type="var">l</span> ?<span class="id" type="var">r</span>] <span class="id" type="var">eqn</span>:?<span class="id" type="var">Heq</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| [ <span class="id" type="var">H</span> : (<span class="id" type="var">_</span>, <span class="id" type="var">_</span>) = (<span class="id" type="var">_</span>, <span class="id" type="var">_</span>) |- <span class="id" type="var">_</span>] ⇒ <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| [ <span class="id" type="var">H</span> : () |- <span class="id" type="var">_</span> ] ⇒ <span class="id" type="tactic">destruct</span> <span class="id" type="var">H</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">comp_com_incr_strong</span>: ∀ <span class="id" type="var">c</span> <span class="id" type="var">cst</span> <span class="id" type="var">cst'</span> <span class="id" type="var">e</span> <span class="id" type="var">r</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">comp_com</span> <span class="id" type="var">c</span> <span class="id" type="var">r</span> <span class="id" type="var">cst</span> = (<span class="id" type="var">cst'</span>, <span class="id" type="var">e</span>) → <span class="id" type="var">cstate_incr_strong</span> <span class="id" type="var">cst</span> <span class="id" type="var">cst'</span>.<br/>
<div class="togglescript" id="proofcontrol21" onclick="toggleDisplay('proof21');toggleDisplay('proofcontrol21')"><span class="show"></span></div>
<div class="proofscript" id="proof21" onclick="toggleDisplay('proof21');toggleDisplay('proofcontrol21')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">c</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">cst</span> <span class="id" type="var">cst'</span> <span class="id" type="var">e</span> <span class="id" type="var">r</span> <span class="id" type="var">Htr</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Htr</span>; <span class="id" type="var">compile</span>.<br/>

<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;Case&nbsp;"CSkip".*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">reflexivity</span>.<br/>

<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;Case&nbsp;"CAss".&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">fresh_add_incr_strong</span>; <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">ectmon_incr_strong</span>; <span class="id" type="tactic">eauto</span>.<br/>

<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;Case&nbsp;"CSeq".&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="tactic">transitivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">IHc2</span>; <span class="id" type="tactic">eauto</span>. <span class="id" type="tactic">eapply</span> <span class="id" type="var">IHc1</span>; <span class="id" type="tactic">eauto</span>.<br/>

<br/>
&nbsp;&nbsp;-  <span class="comment">(*&nbsp;Case&nbsp;"CIf".&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="tactic">transitivity</span>. <span class="id" type="tactic">eapply</span> <span class="id" type="var">IHc1</span>; <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="tactic">transitivity</span>. <span class="id" type="tactic">eapply</span> <span class="id" type="var">IHc2</span>; <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">fresh_add_incr_strong</span>; <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">ectmon_incr_strong</span>; <span class="id" type="tactic">eauto</span>.<br/>

<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;Case&nbsp;"CWhile".&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">fresh_add_incr_strong</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eauto</span>. <span class="id" type="tactic">eapply</span> <span class="id" type="tactic">transitivity</span>. <span class="id" type="tactic">eapply</span> <span class="id" type="var">IHc</span>; <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">ectmon_incr_strong</span>; <span class="id" type="tactic">eauto</span>. <span class="id" type="tactic">eauto</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">cstate_incr_weaken</span> : ∀ <span class="id" type="var">cst</span> <span class="id" type="var">cst'</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">cstate_incr_strong</span> <span class="id" type="var">cst</span> <span class="id" type="var">cst'</span> →<br/>
&nbsp;&nbsp;<span class="id" type="var">cstate_incr</span> <span class="id" type="var">cst</span> <span class="id" type="var">cst'</span>.<br/>
<div class="togglescript" id="proofcontrol22" onclick="toggleDisplay('proof22');toggleDisplay('proofcontrol22')"><span class="show"></span></div>
<div class="proofscript" id="proof22" onclick="toggleDisplay('proof22');toggleDisplay('proofcontrol22')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> 1. <span class="id" type="var">constructor</span>. <span class="id" type="tactic">auto</span>. <span class="id" type="tactic">intros</span>. <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H<sub>1</sub></span>; <span class="id" type="tactic">auto</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">comp_com_incr</span>: ∀ <span class="id" type="var">c</span> <span class="id" type="var">cst</span> <span class="id" type="var">cst'</span> <span class="id" type="var">e</span> <span class="id" type="var">r</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">comp_com</span> <span class="id" type="var">c</span> <span class="id" type="var">r</span> <span class="id" type="var">cst</span> = (<span class="id" type="var">cst'</span>, <span class="id" type="var">e</span>) → <span class="id" type="var">cstate_incr</span> <span class="id" type="var">cst</span> <span class="id" type="var">cst'</span>.<br/>
<div class="togglescript" id="proofcontrol23" onclick="toggleDisplay('proof23');toggleDisplay('proofcontrol23')"><span class="show"></span></div>
<div class="proofscript" id="proof23" onclick="toggleDisplay('proof23');toggleDisplay('proofcontrol23')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">cstate_incr_weaken</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">comp_com_incr_strong</span>; <span class="id" type="tactic">eauto</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
</div>

<div class="doc">
<a name="lab75"></a><h2 class="section">Relating Initial Compilation</h2>

<div class="paragraph"> </div>

 The key lemma is: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">match_init</span> : ∀ <span class="id" type="var">c</span> <span class="id" type="var">le</span> <span class="id" type="var">lr</span> <span class="id" type="var">csti</span> <span class="id" type="var">cst</span> <span class="id" type="var">x</span> <span class="id" type="var">g'</span> <span class="id" type="var">e</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">comp_com</span> <span class="id" type="var">c</span> <span class="id" type="var">lr</span> <span class="id" type="var">csti</span> = (<span class="id" type="var">cst</span>, <span class="id" type="var">le</span>) →<br/>
&nbsp;&nbsp;<span class="id" type="var">cstate_incr</span> <span class="id" type="var">cst</span> (<span class="id" type="var">x</span>, <span class="id" type="var">g'</span>) →<br/>
&nbsp;&nbsp;<span class="id" type="var">match_config</span> <span class="id" type="var">c</span> (<span class="id" type="var">e</span>, <span class="id" type="var">g'</span>, <span class="id" type="var">le</span>, <span class="id" type="var">lr</span>).<br/>
<div class="togglescript" id="proofcontrol24" onclick="toggleDisplay('proof24');toggleDisplay('proofcontrol24')"><span class="show"></span></div>
<div class="proofscript" id="proof24" onclick="toggleDisplay('proof24');toggleDisplay('proofcontrol24')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">c</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">le</span> <span class="id" type="var">lr</span> <span class="id" type="var">csti</span> <span class="id" type="var">cst</span> <span class="id" type="var">x</span> <span class="id" type="var">g'</span> <span class="id" type="var">e</span> <span class="id" type="var">Hcomp</span> <span class="id" type="var">Hincr</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hcomp</span>; <span class="id" type="var">compile</span>.<br/>

<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;Case&nbsp;"CSkip".&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">MC_Skip</span>.<br/>

<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;Case&nbsp;"CAss".&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heq</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">Heq</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">Heq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heq0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">comp_store</span> <span class="id" type="var">a</span> <span class="id" type="var">i</span> <span class="id" type="var">lr</span> <span class="id" type="var">ids1</span>) <span class="id" type="var">eqn</span>:<span class="id" type="var">Hc'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Heq0</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">Heq0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heq1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Heq1</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">Heq1</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">MC_Ass</span>, <span class="id" type="var">cfg_insns_at</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Hincr</span>. <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">H<sub>5</sub></span>. <span class="id" type="var">left</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">comp_store_not_nil</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">ListCFG.update_eq</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">f_equal</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">surjective_pairing</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hc'</span> <span class="id" type="tactic">at</span> 1.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Hc'</span>. <span class="id" type="tactic">reflexivity</span>.<br/>

<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;Case&nbsp;"CSeq".&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">MC_Seq</span>. <span class="id" type="tactic">eapply</span> <span class="id" type="var">IHc1</span>; <span class="id" type="tactic">eauto</span>. <span class="id" type="tactic">eapply</span> <span class="id" type="var">IHc2</span>; <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="tactic">transitivity</span>; <span class="id" type="tactic">eauto</span>. <span class="id" type="tactic">eapply</span> <span class="id" type="var">comp_com_incr</span>; <span class="id" type="tactic">eauto</span>.<br/>

<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;Case&nbsp;"CIf".&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">MC_If</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="id" type="tactic">eapply</span> <span class="id" type="var">IHc1</span>; <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="tactic">transitivity</span>. <span class="id" type="tactic">eapply</span> <span class="id" type="var">comp_com_incr</span>; <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="tactic">transitivity</span>; <span class="id" type="tactic">eauto</span>. <span class="id" type="tactic">eapply</span> <span class="id" type="var">cstate_incr_weaken</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">fresh_add_incr_strong</span>; <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">ectmon_incr_strong</span>; <span class="id" type="tactic">eauto</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="id" type="tactic">eapply</span> <span class="id" type="var">IHc2</span>; <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="tactic">transitivity</span>; <span class="id" type="tactic">eauto</span>. <span class="id" type="tactic">eapply</span> <span class="id" type="var">cstate_incr_weaken</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">fresh_add_incr_strong</span>; <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">ectmon_incr_strong</span>; <span class="id" type="tactic">eauto</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="id" type="tactic">inversion</span> <span class="id" type="var">Heq1</span>. <span class="id" type="tactic">subst</span>. <span class="id" type="tactic">clear</span> <span class="id" type="var">Heq1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heq2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">compile</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Heq3</span>. <span class="id" type="tactic">subst</span>. <span class="id" type="tactic">clear</span> <span class="id" type="var">Heq3</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">cfg_insns_at</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Hincr</span>. <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">H<sub>5</sub></span>. <span class="id" type="var">left</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">comp_cond_not_nil</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">ListCFG.update_eq</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">f_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">surjective_pairing</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heq1</span> <span class="id" type="tactic">at</span> 1.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Heq1</span>. <span class="id" type="tactic">reflexivity</span>.<br/>

<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;Case&nbsp;"CWhile".&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">MC_While</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">cs</span>:=<span class="id" type="var">ids2</span>).<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heq</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">Heq</span>; <span class="id" type="tactic">subst</span>. <span class="id" type="tactic">clear</span> <span class="id" type="var">Heq</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">IHc</span>. <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">comp_com_incr_strong</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heq0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">ectmon_incr_strong</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heq1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="tactic">transitivity</span>; <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="tactic">transitivity</span>; <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">cstate_incr_weaken</span>; <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">add_insns_incr</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heq2</span>; <span class="id" type="tactic">eauto</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Heq1</span>. <span class="id" type="tactic">subst</span>. <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H<sub>6</sub></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Heq0</span>. <span class="id" type="tactic">subst</span>. <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H<sub>8</sub></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">ListCFG.update_eq</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">left</span>. <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Heq0</span>. <span class="id" type="tactic">subst</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H<sub>2</sub></span>. <span class="id" type="var">left</span>. <span class="id" type="tactic">auto</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="id" type="tactic">inversion</span> <span class="id" type="var">Heq</span>. <span class="id" type="tactic">subst</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">cfg_insns_at</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Hincr</span>. <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">H<sub>5</sub></span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">comp_com_incr_strong</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heq0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">ectmon_incr_strong</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heq1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Heq0</span>. <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Heq2</span>. <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Heq1</span>. <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">H<sub>3</sub></span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H<sub>2</sub></span>. <span class="id" type="var">left</span>. <span class="id" type="tactic">reflexivity</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">comp_cond_not_nil</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Heq2</span>. <span class="id" type="tactic">subst</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">ListCFG.update_eq</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">f_equal</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">surjective_pairing</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heq1</span> <span class="id" type="tactic">at</span> 1.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Heq1</span>. <span class="id" type="tactic">subst</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">strun</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">comp_cond</span> <span class="id" type="var">b</span> <span class="id" type="var">r<sub>0</sub></span> <span class="id" type="var">lr</span> <span class="id" type="var">ids2</span>). <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
<span class="comment">(*&nbsp;adapted&nbsp;from&nbsp;Leroy,&nbsp;OPLSS&nbsp;'12&nbsp;Compil.v&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;Generic&nbsp;simulation&nbsp;proof.&nbsp;*)</span><br/>

<br/>
<span class="id" type="keyword">Section</span> <span class="id" type="var">SIMULATION_DIAGRAM</span>.<br/>

<br/>
<span class="id" type="keyword">Variable</span> <span class="id" type="var">state1</span>: <span class="id" type="keyword">Type</span>. <span class="comment">(*&nbsp;source&nbsp;states&nbsp;*)</span><br/>
<span class="id" type="keyword">Variable</span> <span class="id" type="var">step1</span>: <span class="id" type="var">state1</span> → <span class="id" type="var">state1</span> → <span class="id" type="keyword">Prop</span>. <span class="comment">(*&nbsp;source&nbsp;step&nbsp;relation&nbsp;*)</span><br/>

<br/>
<span class="id" type="keyword">Variable</span> <span class="id" type="var">state2</span>: <span class="id" type="keyword">Type</span>. <span class="comment">(*&nbsp;target&nbsp;states&nbsp;*)</span><br/>
<span class="id" type="keyword">Variable</span> <span class="id" type="var">step2</span>: <span class="id" type="var">state2</span> → <span class="id" type="var">state2</span> → <span class="id" type="keyword">Prop</span>. <span class="comment">(*&nbsp;target&nbsp;step&nbsp;relation&nbsp;*)</span><br/>

<br/>
<span class="id" type="keyword">Variable</span> <span class="id" type="var">match_states</span>: <span class="id" type="var">state1</span> → <span class="id" type="var">state2</span> → <span class="id" type="keyword">Prop</span>. <span class="comment">(*&nbsp;the&nbsp;invariant&nbsp;*)</span><br/>

<br/>
<span class="id" type="keyword">Variable</span> <span class="id" type="keyword">measure</span>: <span class="id" type="var">state1</span> → <span class="id" type="var">nat</span>. <span class="comment">(*&nbsp;for&nbsp;stuttering&nbsp;*)</span><br/>

<br/>
<span class="id" type="keyword">Hypothesis</span> <span class="id" type="var">simulation</span>:<br/>
&nbsp;&nbsp;∀ <span class="id" type="var">S<sub>1</sub></span> <span class="id" type="var">S<sub>1</sub>'</span> <span class="id" type="var">S<sub>2</sub></span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">step1</span> <span class="id" type="var">S<sub>1</sub></span> <span class="id" type="var">S<sub>1</sub>'</span> → <span class="id" type="var">match_states</span> <span class="id" type="var">S<sub>1</sub></span> <span class="id" type="var">S<sub>2</sub></span> →<br/>
&nbsp;&nbsp;∃ <span class="id" type="var">S<sub>2</sub>'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">plus</span> <span class="id" type="var">step2</span> <span class="id" type="var">S<sub>2</sub></span> <span class="id" type="var">S<sub>2</sub>'</span> ∨ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">star</span> <span class="id" type="var">step2</span> <span class="id" type="var">S<sub>2</sub></span> <span class="id" type="var">S<sub>2</sub>'</span> ∧ <span class="id" type="keyword">measure</span> <span class="id" type="var">S<sub>1</sub>'</span> &lt; <span class="id" type="keyword">measure</span> <span class="id" type="var">S<sub>1</sub></span>) ∧<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">match_states</span> <span class="id" type="var">S<sub>1</sub>'</span> <span class="id" type="var">S<sub>2</sub>'</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">simulation_star</span>:<br/>
&nbsp;&nbsp;∀ <span class="id" type="var">S<sub>1</sub></span> <span class="id" type="var">S<sub>1</sub>'</span>, <span class="id" type="var">star</span> <span class="id" type="var">step1</span> <span class="id" type="var">S<sub>1</sub></span> <span class="id" type="var">S<sub>1</sub>'</span> →<br/>
&nbsp;&nbsp;∀ <span class="id" type="var">S<sub>2</sub></span>, <span class="id" type="var">match_states</span> <span class="id" type="var">S<sub>1</sub></span> <span class="id" type="var">S<sub>2</sub></span> →<br/>
&nbsp;&nbsp;∃ <span class="id" type="var">S<sub>2</sub>'</span>, <span class="id" type="var">star</span> <span class="id" type="var">step2</span> <span class="id" type="var">S<sub>2</sub></span> <span class="id" type="var">S<sub>2</sub>'</span> ∧ <span class="id" type="var">match_states</span> <span class="id" type="var">S<sub>1</sub>'</span> <span class="id" type="var">S<sub>2</sub>'</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">induction</span> 1; <span class="id" type="tactic">intros</span>.<br/>

<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;Case&nbsp;"zero&nbsp;transition".&nbsp;*)</span><br/>
&nbsp;&nbsp;∃ <span class="id" type="var">S<sub>2</sub></span>; <span class="id" type="tactic">split</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">star_refl</span>. <span class="id" type="tactic">auto</span>.<br/>

<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;Case&nbsp;"one&nbsp;or&nbsp;more&nbsp;transitions".&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">simulation</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H</span> <span class="id" type="var">H<sub>1</sub></span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">S<sub>2</sub>'</span> [<span class="id" type="var">P</span> <span class="id" type="var">Q</span>]].<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">IHstar</span> <span class="id" type="var">_</span> <span class="id" type="var">Q</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">S<sub>2</sub>''</span> [<span class="id" type="var">U</span> <span class="id" type="var">V</span>]].<br/>
&nbsp;&nbsp;∃ <span class="id" type="var">S<sub>2</sub>''</span>; <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">star_trans</span>; <span class="id" type="tactic">eauto</span>. <span class="id" type="tactic">destruct</span> <span class="id" type="var">P</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">plus_star</span>; <span class="id" type="tactic">auto</span>. <span class="id" type="tactic">destruct</span> <span class="id" type="var">H<sub>2</sub></span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">auto</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">simulation_infseq_productive</span>:<br/>
&nbsp;&nbsp;∀ <span class="id" type="var">N</span> <span class="id" type="var">S<sub>1</sub></span> <span class="id" type="var">S<sub>2</sub></span>,<br/>
&nbsp;&nbsp;<span class="id" type="keyword">measure</span> <span class="id" type="var">S<sub>1</sub></span> &lt; <span class="id" type="var">N</span> →<br/>
&nbsp;&nbsp;<span class="id" type="var">infseq</span> <span class="id" type="var">step1</span> <span class="id" type="var">S<sub>1</sub></span> →<br/>
&nbsp;&nbsp;<span class="id" type="var">match_states</span> <span class="id" type="var">S<sub>1</sub></span> <span class="id" type="var">S<sub>2</sub></span> →<br/>
&nbsp;&nbsp;∃ <span class="id" type="var">S<sub>1</sub>'</span>, ∃ <span class="id" type="var">S<sub>2</sub>'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">plus</span> <span class="id" type="var">step2</span> <span class="id" type="var">S<sub>2</sub></span> <span class="id" type="var">S<sub>2</sub>'</span><br/>
&nbsp;&nbsp;&nbsp;∧ <span class="id" type="var">infseq</span> <span class="id" type="var">step1</span> <span class="id" type="var">S<sub>1</sub>'</span><br/>
&nbsp;&nbsp;&nbsp;∧ <span class="id" type="var">match_states</span> <span class="id" type="var">S<sub>1</sub>'</span> <span class="id" type="var">S<sub>2</sub>'</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">N</span>; <span class="id" type="tactic">intros</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;Case&nbsp;"N&nbsp;=&nbsp;0".&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">omega</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;Case&nbsp;"N&nbsp;&gt;&nbsp;0".&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H<sub>0</sub></span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H<sub>0</sub></span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">simulation</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H<sub>2</sub></span> <span class="id" type="var">H<sub>1</sub></span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">S<sub>2</sub>'</span> [<span class="id" type="var">P</span> <span class="id" type="var">Q</span>]].<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">P</span>.<br/>
&nbsp;&nbsp;+ <span class="comment">(*&nbsp;SCase&nbsp;"one&nbsp;or&nbsp;several&nbsp;transitions".&nbsp;*)</span><br/>
&nbsp;&nbsp;∃ <span class="id" type="var">b</span>; ∃ <span class="id" type="var">S<sub>2</sub>'</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;+ <span class="comment">(*&nbsp;SCase&nbsp;"zero,&nbsp;one&nbsp;or&nbsp;several&nbsp;transitions".&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">H<sub>0</sub></span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H<sub>0</sub></span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H<sub>0</sub></span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;* <span class="comment">(*&nbsp;SSCase&nbsp;"zero&nbsp;transitions".&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">IHN</span>; <span class="id" type="tactic">eauto</span>. <span class="id" type="tactic">omega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;* <span class="comment">(*&nbsp;SSCase&nbsp;"one&nbsp;or&nbsp;several&nbsp;transitions".&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;∃ <span class="id" type="var">b</span>; ∃ <span class="id" type="var">S<sub>2</sub>'</span>; <span class="id" type="tactic">split</span>. <span class="id" type="tactic">eapply</span> <span class="id" type="var">plus_left</span>; <span class="id" type="tactic">eauto</span>. <span class="id" type="tactic">auto</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">simulation_infseq</span>:<br/>
&nbsp;&nbsp;∀ <span class="id" type="var">S<sub>1</sub></span> <span class="id" type="var">S<sub>2</sub></span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">infseq</span> <span class="id" type="var">step1</span> <span class="id" type="var">S<sub>1</sub></span> →<br/>
&nbsp;&nbsp;<span class="id" type="var">match_states</span> <span class="id" type="var">S<sub>1</sub></span> <span class="id" type="var">S<sub>2</sub></span> →<br/>
&nbsp;&nbsp;<span class="id" type="var">infseq</span> <span class="id" type="var">step2</span> <span class="id" type="var">S<sub>2</sub></span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">infseq_coinduction_principle_2</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">X</span> := <span class="id" type="keyword">fun</span> <span class="id" type="var">S<sub>2</sub></span> ⇒ ∃ <span class="id" type="var">S<sub>1</sub></span>, <span class="id" type="var">infseq</span> <span class="id" type="var">step1</span> <span class="id" type="var">S<sub>1</sub></span> ∧ <span class="id" type="var">match_states</span> <span class="id" type="var">S<sub>1</sub></span> <span class="id" type="var">S<sub>2</sub></span>).<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span>. <span class="id" type="tactic">destruct</span> <span class="id" type="var">H<sub>1</sub></span> <span class="id" type="keyword">as</span> [<span class="id" type="var">S</span> [<span class="id" type="var">A</span> <span class="id" type="var">B</span>]].<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">simulation_infseq_productive</span> (<span class="id" type="keyword">measure</span> <span class="id" type="var">S</span> + 1) <span class="id" type="var">S</span> <span class="id" type="var">a</span>) <br/>
&nbsp;&nbsp;<span class="id" type="keyword">as</span> [<span class="id" type="var">S<sub>1</sub>'</span> [<span class="id" type="var">S<sub>2</sub>'</span> [<span class="id" type="var">P</span> [<span class="id" type="var">Q</span> <span class="id" type="var">R</span>]]]].<br/>
&nbsp;&nbsp;<span class="id" type="tactic">omega</span>. <span class="id" type="tactic">auto</span>. <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;∃ <span class="id" type="var">S<sub>2</sub>'</span>; <span class="id" type="tactic">split</span>. <span class="id" type="tactic">auto</span>. ∃ <span class="id" type="var">S<sub>1</sub>'</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;∃ <span class="id" type="var">S<sub>1</sub></span>; <span class="id" type="tactic">auto</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">End</span> <span class="id" type="var">SIMULATION_DIAGRAM</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">vminus_terminates</span> (<span class="id" type="var">g</span>:<span class="id" type="var">ListCFG.t</span>) (<span class="id" type="var">m</span> <span class="id" type="var">m'</span>:<span class="id" type="var">mem</span>) : <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;∃ <span class="id" type="var">x</span> <span class="id" type="var">st'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">insns_at_pc</span> <span class="id" type="var">g</span> <span class="id" type="var">st'</span>.(<span class="id" type="var">st_pc</span>) [(<span class="id" type="var">x</span>, <span class="id" type="var">cmd_tmn</span> <span class="id" type="var">tmn_ret</span>)] ∧<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">st'</span>.(<span class="id" type="var">st_mem</span>) = <span class="id" type="var">m'</span> ∧<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">star</span> (<span class="id" type="var">step</span> <span class="id" type="var">g</span>) (<span class="id" type="var">init_state</span> <span class="id" type="var">g</span> <span class="id" type="var">m</span>) <span class="id" type="var">st'</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">vminus_diverges</span> (<span class="id" type="var">g</span>:<span class="id" type="var">ListCFG.t</span>) (<span class="id" type="var">m</span>:<span class="id" type="var">mem</span>) : <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">infseq</span> (<span class="id" type="var">step</span> <span class="id" type="var">g</span>) (<span class="id" type="var">init_state</span> <span class="id" type="var">g</span> <span class="id" type="var">m</span>).<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">imp_terminates</span> (<span class="id" type="var">c</span>: <span class="id" type="var">com</span>) (<span class="id" type="var">m</span> <span class="id" type="var">m'</span>:<span class="id" type="var">mem</span>) : <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">star</span> <span class="id" type="var">Imp.step</span> (<span class="id" type="var">c</span>, <span class="id" type="var">m</span>) (<span class="id" type="var">SKIP</span>, <span class="id" type="var">m'</span>).<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">imp_diverges</span> (<span class="id" type="var">c</span>: <span class="id" type="var">com</span>) (<span class="id" type="var">mem</span>: <span class="id" type="var">mem</span>) : <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">infseq</span> <span class="id" type="var">Imp.step</span> (<span class="id" type="var">c</span>, <span class="id" type="var">mem</span>).<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">match_config_ret</span> : ∀ <span class="id" type="var">g</span> <span class="id" type="var">le</span> <span class="id" type="var">lr</span> <span class="id" type="var">c</span>,<br/>
&nbsp;&nbsp;(<span class="id" type="var">g</span>, <span class="id" type="var">le</span>, <span class="id" type="var">lr</span>) = <span class="id" type="var">compile</span> <span class="id" type="var">c</span> →<br/>
&nbsp;&nbsp;∃ <span class="id" type="var">x</span>, <span class="id" type="var">insns_at_pc</span> <span class="id" type="var">g</span> (<span class="id" type="var">block_entry</span> <span class="id" type="var">lr</span>) [(<span class="id" type="var">x</span>, <span class="id" type="var">cmd_tmn</span> <span class="id" type="var">tmn_ret</span>)].<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">compile</span>, <span class="id" type="var">comp_prog</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>. <span class="id" type="var">compile</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="var">eexists</span>. <span class="id" type="tactic">eapply</span> <span class="id" type="var">cfg_insns_at</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">comp_com_incr_strong</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heq1</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Heq1</span>; <span class="id" type="tactic">subst</span>. <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">H<sub>6</sub></span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">ListCFG.update_eq</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">left</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">match_config_initial</span> : ∀ <span class="id" type="var">g</span> <span class="id" type="var">le</span> <span class="id" type="var">lr</span> <span class="id" type="var">c</span> <span class="id" type="var">m</span>,<br/>
&nbsp;&nbsp;(<span class="id" type="var">g</span>, <span class="id" type="var">le</span>, <span class="id" type="var">lr</span>) = <span class="id" type="var">compile</span> <span class="id" type="var">c</span> →<br/>
&nbsp;&nbsp;<span class="id" type="var">match_states</span> <span class="id" type="var">g</span> <span class="id" type="var">lr</span> (<span class="id" type="var">c</span>, <span class="id" type="var">m</span>) (<span class="id" type="var">init_state</span> <span class="id" type="var">g</span> <span class="id" type="var">m</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">compile</span>, <span class="id" type="var">comp_prog</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>. <span class="id" type="var">compile</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">econstructor</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">eauto</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">match_init</span>. <span class="id" type="tactic">eauto</span>. <span class="id" type="tactic">eapply</span> <span class="id" type="var">cstate_incr_weaken</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">cstate_incr_strong_refl</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">compile_program_correct_terminating</span>:<br/>
&nbsp;&nbsp;∀ <span class="id" type="var">c</span> <span class="id" type="var">m</span> <span class="id" type="var">m'</span> <span class="id" type="var">g</span> <span class="id" type="var">le</span> <span class="id" type="var">lr</span>,<br/>
&nbsp;&nbsp;(<span class="id" type="var">g</span>, <span class="id" type="var">le</span>, <span class="id" type="var">lr</span>) = <span class="id" type="var">compile</span> <span class="id" type="var">c</span> →<br/>
&nbsp;&nbsp;<span class="id" type="var">imp_terminates</span> <span class="id" type="var">c</span> <span class="id" type="var">m</span> <span class="id" type="var">m'</span> →<br/>
&nbsp;&nbsp;<span class="id" type="var">vminus_terminates</span> <span class="id" type="var">g</span> <span class="id" type="var">m</span> <span class="id" type="var">m'</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">imp_terminates</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (∃ <span class="id" type="var">machconf2</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">star</span> (<span class="id" type="var">step</span> <span class="id" type="var">g</span>) (<span class="id" type="var">init_state</span> <span class="id" type="var">g</span> <span class="id" type="var">m</span>) <span class="id" type="var">machconf2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;∧ <span class="id" type="var">match_states</span> <span class="id" type="var">g</span> <span class="id" type="var">lr</span> (<span class="id" type="var">SKIP</span>, <span class="id" type="var">m'</span>) <span class="id" type="var">machconf2</span>).<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">simulation_star</span>; <span class="id" type="tactic">eauto</span>. <span class="id" type="tactic">eapply</span> <span class="id" type="var">transl_sim_step_final</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">match_config_initial</span>; <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">H<sub>1</sub></span> <span class="id" type="keyword">as</span> [<span class="id" type="var">machconf2</span> [<span class="id" type="var">STAR</span> <span class="id" type="var">MS</span>]].<br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">MS</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">eelim</span> <span class="id" type="var">match_config_ret</span>. <span class="id" type="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">red</span>. ∃ <span class="id" type="var">x</span>, <span class="id" type="var">machconf2</span>. <span class="id" type="tactic">split</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H<sub>4</sub></span>. <span class="id" type="tactic">eauto</span>. <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H<sub>3</sub></span>; <span class="id" type="tactic">subst</span>. <span class="id" type="tactic">eauto</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">compile_program_correct_diverging</span>:<br/>
&nbsp;&nbsp;∀ <span class="id" type="var">c</span> <span class="id" type="var">m</span> <span class="id" type="var">g</span> <span class="id" type="var">le</span> <span class="id" type="var">lr</span>,<br/>
&nbsp;&nbsp;(<span class="id" type="var">g</span>, <span class="id" type="var">le</span>, <span class="id" type="var">lr</span>) = <span class="id" type="var">compile</span> <span class="id" type="var">c</span> →<br/>
&nbsp;&nbsp;<span class="id" type="var">imp_diverges</span> <span class="id" type="var">c</span> <span class="id" type="var">m</span> →<br/>
&nbsp;&nbsp;<span class="id" type="var">vminus_diverges</span> <span class="id" type="var">g</span> <span class="id" type="var">m</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span>; <span class="id" type="tactic">red</span>; <span class="id" type="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">simulation_infseq</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">match_states</span> := <span class="id" type="var">match_states</span> <span class="id" type="var">g</span> <span class="id" type="var">lr</span>); <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">transl_sim_step_final</span>. <span class="id" type="tactic">eapply</span> <span class="id" type="var">match_config_initial</span>; <span class="id" type="tactic">eauto</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>
</div>

<div id="footer">
<hr/><a href="coqindex.html">Index</a></div>

</div>

</body>
</html>